{"id":"cronactions.js","dependencies":[{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\.babelrc","includedInParent":true,"mtime":1545517173655},{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\package.json","includedInParent":true,"mtime":1545850952595},{"name":"./Functions/Upload/scanAndRemoveFile","loc":{"line":5,"column":37},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\Upload\\scanAndRemoveFile.js"},{"name":"./Functions/FileDeletion/getFilesToDelete","loc":{"line":6,"column":37},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\FileDeletion\\getFilesToDelete.js"},{"name":"./Functions/FileDeletion/deleteFiles","loc":{"line":7,"column":37},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\FileDeletion\\deleteFiles.js"},{"name":"./Functions/SecondaryScan/GetFilesForSecondaryScan","loc":{"line":8,"column":37},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\SecondaryScan\\GetFilesForSecondaryScan.js"},{"name":"./Functions/VirusTotal/getFilesToScan","loc":{"line":9,"column":38},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\VirusTotal\\getFilesToScan.js"},{"name":"./Classes/VirusTotalScanner","loc":{"line":10,"column":37},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Classes\\VirusTotalScanner.js"}],"generated":{"js":"\"use strict\";\n\nvar _nodeCron = require(\"node-cron\");\n\nvar _dnode = _interopRequireDefault(require(\"dnode\"));\n\nvar _async = _interopRequireDefault(require(\"async\"));\n\nvar _debug = _interopRequireDefault(require(\"debug\"));\n\nvar _scanAndRemoveFile = _interopRequireDefault(require(\"./Functions/Upload/scanAndRemoveFile\"));\n\nvar _getFilesToDelete = _interopRequireDefault(require(\"./Functions/FileDeletion/getFilesToDelete\"));\n\nvar _deleteFiles = _interopRequireDefault(require(\"./Functions/FileDeletion/deleteFiles\"));\n\nvar _GetFilesForSecondaryScan = _interopRequireDefault(require(\"./Functions/SecondaryScan/GetFilesForSecondaryScan\"));\n\nvar _getFilesToScan = _interopRequireDefault(require(\"./Functions/VirusTotal/getFilesToScan\"));\n\nvar _VirusTotalScanner = _interopRequireDefault(require(\"./Classes/VirusTotalScanner\"));\n\nvar _dotenv = _interopRequireDefault(require(\"dotenv\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n_dotenv.default.config();\n\nconst virusTotal = new _VirusTotalScanner.default(process.env.VIRUSTOTAL_KEY, process.env.VIRUSTOTAL_MAX_SCAN_WAIT_MS, process.env.VIRUSTOTAL_MAX_SCANS_PR_MINUTE, process.env.VIRUSTOTAL_MIN_ALLOWED_POSITIVES, process.env.UPLOAD_DESTINATION);\n/**\r\n * Limits the AV scans\r\n */\n\nconst sophosQueue = _async.default.queue(async task => {\n  (0, _debug.default)(\"sophos-call\")(task); // This is a hack that makes it possible to develop without having Sophos installed. Don't tell anyone :v\n\n  if (process.env.NODE_ENV === \"production\") await (0, _scanAndRemoveFile.default)(task.fileName, task.fileSha);\n}, 1);\n/**\r\n * Functions the app can call\r\n */\n\n\nconst messageServer = (0, _dnode.default)({\n  sophosScan: (fileName, fileSha) => {\n    sophosQueue.push({\n      fileName: fileName,\n      fileSha: fileSha\n    });\n  },\n  virusTotalScan: (fileHash, fileName, scanNumber) => {\n    virusTotal.scan(fileHash, fileName, scanNumber);\n  }\n});\n/**\r\n * Remove files that are too old\r\n */\n\n(0, _nodeCron.schedule)(process.env.FILE_DELETION_CRON, async () => {\n  const files = await (0, _getFilesToDelete.default)(); // Prevent additional files from being scanned\n\n  if (files.length === 0) return; // Removes duplicates\n\n  const unique = [...new Set(files.map(file => file.filename))];\n  (0, _deleteFiles.default)(unique);\n});\n/**\r\n * Secondary AV scan of uploaded files\r\n */\n\n(0, _nodeCron.schedule)(process.env.SECONDARY_SCAN_CRON, async () => {\n  const files = await (0, _GetFilesForSecondaryScan.default)();\n\n  if (!files) {\n    return;\n  }\n\n  if (files.length === 0) {\n    return;\n  }\n\n  (0, _debug.default)(\"scanner-schedule\")(files);\n  files.forEach(file => {\n    sophosQueue.push({\n      fileName: file.fileName,\n      fileSha: file.filesha\n    });\n  });\n});\nlet num = 0;\n(0, _nodeCron.schedule)(process.env.VIRUSTOTAL_SECOND_AND_THIRD_SCAN_CRON, async () => {\n  const files = await (0, _getFilesToScan.default)();\n  num++;\n\n  if (!files) {\n    return;\n  }\n\n  if (files.length === 0) {\n    return;\n  }\n\n  files.forEach(file => {\n    virusTotal.scan(file.filehash, file.filename, ++file.virusTotalScan);\n  });\n});\nmessageServer.listen(parseInt(process.env.MESSAGE_SERVER_PORT));","map":{"mappings":[{"generated":{"line":3,"column":0},"source":"cronactions.js","original":{"line":1,"column":0}},{"generated":{"line":5,"column":0},"source":"cronactions.js","original":{"line":2,"column":0}},{"generated":{"line":7,"column":0},"source":"cronactions.js","original":{"line":3,"column":0}},{"generated":{"line":9,"column":0},"source":"cronactions.js","original":{"line":4,"column":0}},{"generated":{"line":11,"column":0},"source":"cronactions.js","original":{"line":5,"column":0}},{"generated":{"line":13,"column":0},"source":"cronactions.js","original":{"line":6,"column":0}},{"generated":{"line":15,"column":0},"source":"cronactions.js","original":{"line":7,"column":0}},{"generated":{"line":17,"column":0},"source":"cronactions.js","original":{"line":8,"column":0}},{"generated":{"line":19,"column":0},"source":"cronactions.js","original":{"line":9,"column":0}},{"generated":{"line":21,"column":0},"source":"cronactions.js","original":{"line":10,"column":0}},{"generated":{"line":23,"column":0},"source":"cronactions.js","original":{"line":12,"column":0}},{"name":"dotenv","generated":{"line":27,"column":0},"source":"cronactions.js","original":{"line":13,"column":0}},{"name":"config","generated":{"line":27,"column":16},"source":"cronactions.js","original":{"line":13,"column":7}},{"generated":{"line":27,"column":22},"source":"cronactions.js","original":{"line":13,"column":0}},{"generated":{"line":29,"column":0},"source":"cronactions.js","original":{"line":15,"column":0}},{"name":"virusTotal","generated":{"line":29,"column":6},"source":"cronactions.js","original":{"line":15,"column":6}},{"generated":{"line":29,"column":16},"source":"cronactions.js","original":{"line":15,"column":16}},{"generated":{"line":29,"column":19},"source":"cronactions.js","original":{"line":15,"column":19}},{"name":"VirusTotalScanner","generated":{"line":29,"column":23},"source":"cronactions.js","original":{"line":15,"column":23}},{"generated":{"line":29,"column":49},"source":"cronactions.js","original":{"line":15,"column":19}},{"name":"process","generated":{"line":29,"column":50},"source":"cronactions.js","original":{"line":15,"column":41}},{"generated":{"line":29,"column":57},"source":"cronactions.js","original":{"line":15,"column":48}},{"name":"env","generated":{"line":29,"column":58},"source":"cronactions.js","original":{"line":15,"column":49}},{"generated":{"line":29,"column":61},"source":"cronactions.js","original":{"line":15,"column":41}},{"name":"VIRUSTOTAL_KEY","generated":{"line":29,"column":62},"source":"cronactions.js","original":{"line":15,"column":53}},{"generated":{"line":29,"column":76},"source":"cronactions.js","original":{"line":15,"column":19}},{"name":"process","generated":{"line":29,"column":78},"source":"cronactions.js","original":{"line":16,"column":41}},{"generated":{"line":29,"column":85},"source":"cronactions.js","original":{"line":16,"column":48}},{"name":"env","generated":{"line":29,"column":86},"source":"cronactions.js","original":{"line":16,"column":49}},{"generated":{"line":29,"column":89},"source":"cronactions.js","original":{"line":16,"column":41}},{"name":"VIRUSTOTAL_MAX_SCAN_WAIT_MS","generated":{"line":29,"column":90},"source":"cronactions.js","original":{"line":16,"column":53}},{"generated":{"line":29,"column":117},"source":"cronactions.js","original":{"line":15,"column":19}},{"name":"process","generated":{"line":29,"column":119},"source":"cronactions.js","original":{"line":17,"column":41}},{"generated":{"line":29,"column":126},"source":"cronactions.js","original":{"line":17,"column":48}},{"name":"env","generated":{"line":29,"column":127},"source":"cronactions.js","original":{"line":17,"column":49}},{"generated":{"line":29,"column":130},"source":"cronactions.js","original":{"line":17,"column":41}},{"name":"VIRUSTOTAL_MAX_SCANS_PR_MINUTE","generated":{"line":29,"column":131},"source":"cronactions.js","original":{"line":17,"column":53}},{"generated":{"line":29,"column":161},"source":"cronactions.js","original":{"line":15,"column":19}},{"name":"process","generated":{"line":29,"column":163},"source":"cronactions.js","original":{"line":18,"column":41}},{"generated":{"line":29,"column":170},"source":"cronactions.js","original":{"line":18,"column":48}},{"name":"env","generated":{"line":29,"column":171},"source":"cronactions.js","original":{"line":18,"column":49}},{"generated":{"line":29,"column":174},"source":"cronactions.js","original":{"line":18,"column":41}},{"name":"VIRUSTOTAL_MIN_ALLOWED_POSITIVES","generated":{"line":29,"column":175},"source":"cronactions.js","original":{"line":18,"column":53}},{"generated":{"line":29,"column":207},"source":"cronactions.js","original":{"line":15,"column":19}},{"name":"process","generated":{"line":29,"column":209},"source":"cronactions.js","original":{"line":19,"column":41}},{"generated":{"line":29,"column":216},"source":"cronactions.js","original":{"line":19,"column":48}},{"name":"env","generated":{"line":29,"column":217},"source":"cronactions.js","original":{"line":19,"column":49}},{"generated":{"line":29,"column":220},"source":"cronactions.js","original":{"line":19,"column":41}},{"name":"UPLOAD_DESTINATION","generated":{"line":29,"column":221},"source":"cronactions.js","original":{"line":19,"column":53}},{"generated":{"line":29,"column":239},"source":"cronactions.js","original":{"line":15,"column":19}},{"generated":{"line":29,"column":240},"source":"cronactions.js","original":{"line":15,"column":0}},{"generated":{"line":30,"column":0},"source":"cronactions.js","original":{"line":22,"column":0}},{"generated":{"line":34,"column":0},"source":"cronactions.js","original":{"line":25,"column":0}},{"name":"sophosQueue","generated":{"line":34,"column":6},"source":"cronactions.js","original":{"line":25,"column":6}},{"generated":{"line":34,"column":17},"source":"cronactions.js","original":{"line":25,"column":17}},{"name":"async","generated":{"line":34,"column":20},"source":"cronactions.js","original":{"line":25,"column":20}},{"name":"queue","generated":{"line":34,"column":35},"source":"cronactions.js","original":{"line":25,"column":26}},{"generated":{"line":34,"column":40},"source":"cronactions.js","original":{"line":25,"column":20}},{"generated":{"line":34,"column":41},"source":"cronactions.js","original":{"line":25,"column":32}},{"name":"task","generated":{"line":34,"column":47},"source":"cronactions.js","original":{"line":25,"column":39}},{"generated":{"line":34,"column":51},"source":"cronactions.js","original":{"line":25,"column":32}},{"generated":{"line":34,"column":55},"source":"cronactions.js","original":{"line":25,"column":48}},{"generated":{"line":35,"column":0},"source":"cronactions.js","original":{"line":26,"column":4}},{"generated":{"line":35,"column":22},"source":"cronactions.js","original":{"line":26,"column":12}},{"generated":{"line":35,"column":35},"source":"cronactions.js","original":{"line":26,"column":4}},{"name":"task","generated":{"line":35,"column":37},"source":"cronactions.js","original":{"line":26,"column":27}},{"generated":{"line":35,"column":41},"source":"cronactions.js","original":{"line":26,"column":4}},{"generated":{"line":35,"column":43},"source":"cronactions.js","original":{"line":25,"column":48}},{"generated":{"line":35,"column":44},"source":"cronactions.js","original":{"line":28,"column":4}},{"generated":{"line":37,"column":0},"source":"cronactions.js","original":{"line":29,"column":4}},{"name":"process","generated":{"line":37,"column":6},"source":"cronactions.js","original":{"line":29,"column":8}},{"generated":{"line":37,"column":13},"source":"cronactions.js","original":{"line":29,"column":15}},{"name":"env","generated":{"line":37,"column":14},"source":"cronactions.js","original":{"line":29,"column":16}},{"generated":{"line":37,"column":17},"source":"cronactions.js","original":{"line":29,"column":8}},{"name":"NODE_ENV","generated":{"line":37,"column":18},"source":"cronactions.js","original":{"line":29,"column":20}},{"generated":{"line":37,"column":26},"source":"cronactions.js","original":{"line":29,"column":8}},{"generated":{"line":37,"column":31},"source":"cronactions.js","original":{"line":29,"column":33}},{"generated":{"line":37,"column":43},"source":"cronactions.js","original":{"line":29,"column":4}},{"generated":{"line":37,"column":45},"source":"cronactions.js","original":{"line":30,"column":8}},{"generated":{"line":37,"column":51},"source":"cronactions.js","original":{"line":30,"column":14}},{"name":"task","generated":{"line":37,"column":83},"source":"cronactions.js","original":{"line":30,"column":32}},{"generated":{"line":37,"column":87},"source":"cronactions.js","original":{"line":30,"column":36}},{"name":"fileName","generated":{"line":37,"column":88},"source":"cronactions.js","original":{"line":30,"column":37}},{"generated":{"line":37,"column":96},"source":"cronactions.js","original":{"line":30,"column":14}},{"name":"task","generated":{"line":37,"column":98},"source":"cronactions.js","original":{"line":30,"column":47}},{"generated":{"line":37,"column":102},"source":"cronactions.js","original":{"line":30,"column":51}},{"name":"fileSha","generated":{"line":37,"column":103},"source":"cronactions.js","original":{"line":30,"column":52}},{"generated":{"line":37,"column":110},"source":"cronactions.js","original":{"line":30,"column":14}},{"generated":{"line":37,"column":111},"source":"cronactions.js","original":{"line":30,"column":8}},{"generated":{"line":38,"column":0},"source":"cronactions.js","original":{"line":31,"column":1}},{"generated":{"line":38,"column":1},"source":"cronactions.js","original":{"line":25,"column":20}},{"generated":{"line":38,"column":3},"source":"cronactions.js","original":{"line":31,"column":3}},{"generated":{"line":38,"column":4},"source":"cronactions.js","original":{"line":25,"column":20}},{"generated":{"line":38,"column":5},"source":"cronactions.js","original":{"line":25,"column":0}},{"generated":{"line":39,"column":0},"source":"cronactions.js","original":{"line":33,"column":0}},{"generated":{"line":44,"column":0},"source":"cronactions.js","original":{"line":36,"column":0}},{"name":"messageServer","generated":{"line":44,"column":6},"source":"cronactions.js","original":{"line":36,"column":6}},{"generated":{"line":44,"column":19},"source":"cronactions.js","original":{"line":36,"column":19}},{"generated":{"line":44,"column":22},"source":"cronactions.js","original":{"line":36,"column":22}},{"generated":{"line":44,"column":42},"source":"cronactions.js","original":{"line":36,"column":28}},{"name":"sophosScan","generated":{"line":45,"column":0},"source":"cronactions.js","original":{"line":37,"column":4}},{"name":"sophosScan","generated":{"line":45,"column":2},"source":"cronactions.js","original":{"line":37,"column":4}},{"generated":{"line":45,"column":12},"source":"cronactions.js","original":{"line":37,"column":14}},{"generated":{"line":45,"column":14},"source":"cronactions.js","original":{"line":37,"column":16}},{"name":"fileName","generated":{"line":45,"column":15},"source":"cronactions.js","original":{"line":37,"column":17}},{"generated":{"line":45,"column":23},"source":"cronactions.js","original":{"line":37,"column":16}},{"name":"fileSha","generated":{"line":45,"column":25},"source":"cronactions.js","original":{"line":37,"column":27}},{"generated":{"line":45,"column":32},"source":"cronactions.js","original":{"line":37,"column":16}},{"generated":{"line":45,"column":37},"source":"cronactions.js","original":{"line":37,"column":39}},{"name":"sophosQueue","generated":{"line":46,"column":0},"source":"cronactions.js","original":{"line":38,"column":8}},{"name":"sophosQueue","generated":{"line":46,"column":4},"source":"cronactions.js","original":{"line":38,"column":8}},{"generated":{"line":46,"column":15},"source":"cronactions.js","original":{"line":38,"column":19}},{"name":"push","generated":{"line":46,"column":16},"source":"cronactions.js","original":{"line":38,"column":20}},{"generated":{"line":46,"column":20},"source":"cronactions.js","original":{"line":38,"column":8}},{"generated":{"line":46,"column":21},"source":"cronactions.js","original":{"line":38,"column":25}},{"name":"fileName","generated":{"line":47,"column":0},"source":"cronactions.js","original":{"line":39,"column":12}},{"name":"fileName","generated":{"line":47,"column":6},"source":"cronactions.js","original":{"line":39,"column":12}},{"generated":{"line":47,"column":14},"source":"cronactions.js","original":{"line":39,"column":20}},{"name":"fileName","generated":{"line":47,"column":16},"source":"cronactions.js","original":{"line":39,"column":22}},{"generated":{"line":47,"column":24},"source":"cronactions.js","original":{"line":38,"column":25}},{"name":"fileSha","generated":{"line":48,"column":0},"source":"cronactions.js","original":{"line":40,"column":12}},{"name":"fileSha","generated":{"line":48,"column":6},"source":"cronactions.js","original":{"line":40,"column":12}},{"generated":{"line":48,"column":13},"source":"cronactions.js","original":{"line":40,"column":19}},{"name":"fileSha","generated":{"line":48,"column":15},"source":"cronactions.js","original":{"line":40,"column":21}},{"generated":{"line":49,"column":0},"source":"cronactions.js","original":{"line":38,"column":25}},{"generated":{"line":49,"column":5},"source":"cronactions.js","original":{"line":38,"column":8}},{"generated":{"line":50,"column":0},"source":"cronactions.js","original":{"line":42,"column":5}},{"generated":{"line":50,"column":3},"source":"cronactions.js","original":{"line":36,"column":28}},{"name":"virusTotalScan","generated":{"line":51,"column":0},"source":"cronactions.js","original":{"line":43,"column":4}},{"name":"virusTotalScan","generated":{"line":51,"column":2},"source":"cronactions.js","original":{"line":43,"column":4}},{"generated":{"line":51,"column":16},"source":"cronactions.js","original":{"line":43,"column":18}},{"generated":{"line":51,"column":18},"source":"cronactions.js","original":{"line":43,"column":20}},{"name":"fileHash","generated":{"line":51,"column":19},"source":"cronactions.js","original":{"line":43,"column":21}},{"generated":{"line":51,"column":27},"source":"cronactions.js","original":{"line":43,"column":20}},{"name":"fileName","generated":{"line":51,"column":29},"source":"cronactions.js","original":{"line":43,"column":31}},{"generated":{"line":51,"column":37},"source":"cronactions.js","original":{"line":43,"column":20}},{"name":"scanNumber","generated":{"line":51,"column":39},"source":"cronactions.js","original":{"line":43,"column":41}},{"generated":{"line":51,"column":49},"source":"cronactions.js","original":{"line":43,"column":20}},{"generated":{"line":51,"column":54},"source":"cronactions.js","original":{"line":43,"column":56}},{"name":"virusTotal","generated":{"line":52,"column":0},"source":"cronactions.js","original":{"line":44,"column":8}},{"name":"virusTotal","generated":{"line":52,"column":4},"source":"cronactions.js","original":{"line":44,"column":8}},{"generated":{"line":52,"column":14},"source":"cronactions.js","original":{"line":44,"column":18}},{"name":"scan","generated":{"line":52,"column":15},"source":"cronactions.js","original":{"line":44,"column":19}},{"generated":{"line":52,"column":19},"source":"cronactions.js","original":{"line":44,"column":8}},{"name":"fileHash","generated":{"line":52,"column":20},"source":"cronactions.js","original":{"line":44,"column":24}},{"generated":{"line":52,"column":28},"source":"cronactions.js","original":{"line":44,"column":8}},{"name":"fileName","generated":{"line":52,"column":30},"source":"cronactions.js","original":{"line":44,"column":34}},{"generated":{"line":52,"column":38},"source":"cronactions.js","original":{"line":44,"column":8}},{"name":"scanNumber","generated":{"line":52,"column":40},"source":"cronactions.js","original":{"line":44,"column":44}},{"generated":{"line":52,"column":50},"source":"cronactions.js","original":{"line":44,"column":8}},{"generated":{"line":53,"column":0},"source":"cronactions.js","original":{"line":45,"column":5}},{"generated":{"line":54,"column":0},"source":"cronactions.js","original":{"line":36,"column":28}},{"generated":{"line":54,"column":1},"source":"cronactions.js","original":{"line":36,"column":22}},{"generated":{"line":54,"column":2},"source":"cronactions.js","original":{"line":36,"column":0}},{"generated":{"line":55,"column":0},"source":"cronactions.js","original":{"line":50,"column":0}},{"generated":{"line":59,"column":0},"source":"cronactions.js","original":{"line":53,"column":0}},{"name":"process","generated":{"line":59,"column":24},"source":"cronactions.js","original":{"line":53,"column":9}},{"generated":{"line":59,"column":31},"source":"cronactions.js","original":{"line":53,"column":16}},{"name":"env","generated":{"line":59,"column":32},"source":"cronactions.js","original":{"line":53,"column":17}},{"generated":{"line":59,"column":35},"source":"cronactions.js","original":{"line":53,"column":9}},{"name":"FILE_DELETION_CRON","generated":{"line":59,"column":36},"source":"cronactions.js","original":{"line":53,"column":21}},{"generated":{"line":59,"column":54},"source":"cronactions.js","original":{"line":53,"column":0}},{"generated":{"line":59,"column":56},"source":"cronactions.js","original":{"line":53,"column":41}},{"generated":{"line":59,"column":68},"source":"cronactions.js","original":{"line":53,"column":53}},{"generated":{"line":60,"column":0},"source":"cronactions.js","original":{"line":54,"column":4}},{"name":"files","generated":{"line":60,"column":8},"source":"cronactions.js","original":{"line":54,"column":10}},{"generated":{"line":60,"column":13},"source":"cronactions.js","original":{"line":54,"column":15}},{"generated":{"line":60,"column":16},"source":"cronactions.js","original":{"line":54,"column":18}},{"generated":{"line":60,"column":22},"source":"cronactions.js","original":{"line":54,"column":24}},{"generated":{"line":60,"column":54},"source":"cronactions.js","original":{"line":54,"column":4}},{"generated":{"line":60,"column":55},"source":"cronactions.js","original":{"line":53,"column":53}},{"generated":{"line":60,"column":56},"source":"cronactions.js","original":{"line":56,"column":4}},{"generated":{"line":62,"column":0},"source":"cronactions.js","original":{"line":57,"column":4}},{"name":"files","generated":{"line":62,"column":6},"source":"cronactions.js","original":{"line":57,"column":8}},{"generated":{"line":62,"column":11},"source":"cronactions.js","original":{"line":57,"column":13}},{"name":"length","generated":{"line":62,"column":12},"source":"cronactions.js","original":{"line":57,"column":14}},{"generated":{"line":62,"column":18},"source":"cronactions.js","original":{"line":57,"column":8}},{"generated":{"line":62,"column":23},"source":"cronactions.js","original":{"line":57,"column":25}},{"generated":{"line":62,"column":24},"source":"cronactions.js","original":{"line":57,"column":4}},{"generated":{"line":62,"column":26},"source":"cronactions.js","original":{"line":58,"column":8}},{"generated":{"line":62,"column":33},"source":"cronactions.js","original":{"line":53,"column":53}},{"generated":{"line":62,"column":34},"source":"cronactions.js","original":{"line":60,"column":4}},{"generated":{"line":64,"column":0},"source":"cronactions.js","original":{"line":61,"column":4}},{"name":"unique","generated":{"line":64,"column":8},"source":"cronactions.js","original":{"line":61,"column":10}},{"generated":{"line":64,"column":14},"source":"cronactions.js","original":{"line":61,"column":16}},{"generated":{"line":64,"column":17},"source":"cronactions.js","original":{"line":61,"column":19}},{"generated":{"line":64,"column":18},"source":"cronactions.js","original":{"line":61,"column":20}},{"generated":{"line":64,"column":21},"source":"cronactions.js","original":{"line":61,"column":23}},{"name":"Set","generated":{"line":64,"column":25},"source":"cronactions.js","original":{"line":61,"column":27}},{"generated":{"line":64,"column":28},"source":"cronactions.js","original":{"line":61,"column":23}},{"name":"files","generated":{"line":64,"column":29},"source":"cronactions.js","original":{"line":61,"column":31}},{"generated":{"line":64,"column":34},"source":"cronactions.js","original":{"line":61,"column":36}},{"name":"map","generated":{"line":64,"column":35},"source":"cronactions.js","original":{"line":61,"column":37}},{"generated":{"line":64,"column":38},"source":"cronactions.js","original":{"line":61,"column":31}},{"name":"file","generated":{"line":64,"column":39},"source":"cronactions.js","original":{"line":61,"column":41}},{"generated":{"line":64,"column":43},"source":"cronactions.js","original":{"line":61,"column":45}},{"name":"file","generated":{"line":64,"column":47},"source":"cronactions.js","original":{"line":61,"column":49}},{"generated":{"line":64,"column":51},"source":"cronactions.js","original":{"line":61,"column":53}},{"name":"filename","generated":{"line":64,"column":52},"source":"cronactions.js","original":{"line":61,"column":54}},{"generated":{"line":64,"column":60},"source":"cronactions.js","original":{"line":61,"column":31}},{"generated":{"line":64,"column":61},"source":"cronactions.js","original":{"line":61,"column":23}},{"generated":{"line":64,"column":62},"source":"cronactions.js","original":{"line":61,"column":19}},{"generated":{"line":64,"column":63},"source":"cronactions.js","original":{"line":61,"column":4}},{"generated":{"line":65,"column":0},"source":"cronactions.js","original":{"line":63,"column":4}},{"name":"unique","generated":{"line":65,"column":28},"source":"cronactions.js","original":{"line":63,"column":16}},{"generated":{"line":65,"column":34},"source":"cronactions.js","original":{"line":63,"column":4}},{"generated":{"line":66,"column":0},"source":"cronactions.js","original":{"line":64,"column":1}},{"generated":{"line":66,"column":1},"source":"cronactions.js","original":{"line":53,"column":0}},{"generated":{"line":67,"column":0},"source":"cronactions.js","original":{"line":66,"column":0}},{"generated":{"line":71,"column":0},"source":"cronactions.js","original":{"line":69,"column":0}},{"name":"process","generated":{"line":71,"column":24},"source":"cronactions.js","original":{"line":69,"column":9}},{"generated":{"line":71,"column":31},"source":"cronactions.js","original":{"line":69,"column":16}},{"name":"env","generated":{"line":71,"column":32},"source":"cronactions.js","original":{"line":69,"column":17}},{"generated":{"line":71,"column":35},"source":"cronactions.js","original":{"line":69,"column":9}},{"name":"SECONDARY_SCAN_CRON","generated":{"line":71,"column":36},"source":"cronactions.js","original":{"line":69,"column":21}},{"generated":{"line":71,"column":55},"source":"cronactions.js","original":{"line":69,"column":0}},{"generated":{"line":71,"column":57},"source":"cronactions.js","original":{"line":69,"column":42}},{"generated":{"line":71,"column":69},"source":"cronactions.js","original":{"line":69,"column":54}},{"generated":{"line":72,"column":0},"source":"cronactions.js","original":{"line":70,"column":4}},{"name":"files","generated":{"line":72,"column":8},"source":"cronactions.js","original":{"line":70,"column":10}},{"generated":{"line":72,"column":13},"source":"cronactions.js","original":{"line":70,"column":15}},{"generated":{"line":72,"column":16},"source":"cronactions.js","original":{"line":70,"column":18}},{"generated":{"line":72,"column":22},"source":"cronactions.js","original":{"line":70,"column":24}},{"generated":{"line":72,"column":62},"source":"cronactions.js","original":{"line":70,"column":4}},{"generated":{"line":74,"column":0},"source":"cronactions.js","original":{"line":72,"column":4}},{"generated":{"line":74,"column":6},"source":"cronactions.js","original":{"line":72,"column":8}},{"name":"files","generated":{"line":74,"column":7},"source":"cronactions.js","original":{"line":72,"column":9}},{"generated":{"line":74,"column":12},"source":"cronactions.js","original":{"line":72,"column":4}},{"generated":{"line":74,"column":14},"source":"cronactions.js","original":{"line":72,"column":16}},{"generated":{"line":75,"column":0},"source":"cronactions.js","original":{"line":73,"column":8}},{"generated":{"line":76,"column":0},"source":"cronactions.js","original":{"line":74,"column":5}},{"generated":{"line":78,"column":0},"source":"cronactions.js","original":{"line":76,"column":4}},{"name":"files","generated":{"line":78,"column":6},"source":"cronactions.js","original":{"line":76,"column":8}},{"generated":{"line":78,"column":11},"source":"cronactions.js","original":{"line":76,"column":13}},{"name":"length","generated":{"line":78,"column":12},"source":"cronactions.js","original":{"line":76,"column":14}},{"generated":{"line":78,"column":18},"source":"cronactions.js","original":{"line":76,"column":8}},{"generated":{"line":78,"column":23},"source":"cronactions.js","original":{"line":76,"column":25}},{"generated":{"line":78,"column":24},"source":"cronactions.js","original":{"line":76,"column":4}},{"generated":{"line":78,"column":26},"source":"cronactions.js","original":{"line":76,"column":28}},{"generated":{"line":79,"column":0},"source":"cronactions.js","original":{"line":77,"column":8}},{"generated":{"line":80,"column":0},"source":"cronactions.js","original":{"line":78,"column":5}},{"generated":{"line":82,"column":0},"source":"cronactions.js","original":{"line":80,"column":4}},{"generated":{"line":82,"column":22},"source":"cronactions.js","original":{"line":80,"column":12}},{"generated":{"line":82,"column":40},"source":"cronactions.js","original":{"line":80,"column":4}},{"name":"files","generated":{"line":82,"column":42},"source":"cronactions.js","original":{"line":80,"column":32}},{"generated":{"line":82,"column":47},"source":"cronactions.js","original":{"line":80,"column":4}},{"name":"files","generated":{"line":83,"column":0},"source":"cronactions.js","original":{"line":82,"column":4}},{"name":"files","generated":{"line":83,"column":2},"source":"cronactions.js","original":{"line":82,"column":4}},{"generated":{"line":83,"column":7},"source":"cronactions.js","original":{"line":82,"column":9}},{"name":"forEach","generated":{"line":83,"column":8},"source":"cronactions.js","original":{"line":82,"column":10}},{"generated":{"line":83,"column":15},"source":"cronactions.js","original":{"line":82,"column":4}},{"name":"file","generated":{"line":83,"column":16},"source":"cronactions.js","original":{"line":82,"column":18}},{"generated":{"line":83,"column":20},"source":"cronactions.js","original":{"line":82,"column":22}},{"generated":{"line":83,"column":24},"source":"cronactions.js","original":{"line":82,"column":26}},{"name":"sophosQueue","generated":{"line":84,"column":0},"source":"cronactions.js","original":{"line":83,"column":8}},{"name":"sophosQueue","generated":{"line":84,"column":4},"source":"cronactions.js","original":{"line":83,"column":8}},{"generated":{"line":84,"column":15},"source":"cronactions.js","original":{"line":83,"column":19}},{"name":"push","generated":{"line":84,"column":16},"source":"cronactions.js","original":{"line":83,"column":20}},{"generated":{"line":84,"column":20},"source":"cronactions.js","original":{"line":83,"column":8}},{"generated":{"line":84,"column":21},"source":"cronactions.js","original":{"line":83,"column":25}},{"name":"fileName","generated":{"line":85,"column":0},"source":"cronactions.js","original":{"line":84,"column":12}},{"name":"fileName","generated":{"line":85,"column":6},"source":"cronactions.js","original":{"line":84,"column":12}},{"generated":{"line":85,"column":14},"source":"cronactions.js","original":{"line":84,"column":20}},{"name":"file","generated":{"line":85,"column":16},"source":"cronactions.js","original":{"line":84,"column":22}},{"generated":{"line":85,"column":20},"source":"cronactions.js","original":{"line":84,"column":26}},{"name":"fileName","generated":{"line":85,"column":21},"source":"cronactions.js","original":{"line":84,"column":27}},{"generated":{"line":85,"column":29},"source":"cronactions.js","original":{"line":83,"column":25}},{"name":"fileSha","generated":{"line":86,"column":0},"source":"cronactions.js","original":{"line":85,"column":12}},{"name":"fileSha","generated":{"line":86,"column":6},"source":"cronactions.js","original":{"line":85,"column":12}},{"generated":{"line":86,"column":13},"source":"cronactions.js","original":{"line":85,"column":19}},{"name":"file","generated":{"line":86,"column":15},"source":"cronactions.js","original":{"line":85,"column":21}},{"generated":{"line":86,"column":19},"source":"cronactions.js","original":{"line":85,"column":25}},{"name":"filesha","generated":{"line":86,"column":20},"source":"cronactions.js","original":{"line":85,"column":26}},{"generated":{"line":87,"column":0},"source":"cronactions.js","original":{"line":83,"column":25}},{"generated":{"line":87,"column":5},"source":"cronactions.js","original":{"line":83,"column":8}},{"generated":{"line":88,"column":0},"source":"cronactions.js","original":{"line":87,"column":5}},{"generated":{"line":88,"column":3},"source":"cronactions.js","original":{"line":82,"column":4}},{"generated":{"line":89,"column":0},"source":"cronactions.js","original":{"line":88,"column":1}},{"generated":{"line":89,"column":1},"source":"cronactions.js","original":{"line":69,"column":0}},{"generated":{"line":90,"column":0},"source":"cronactions.js","original":{"line":91,"column":0}},{"name":"num","generated":{"line":90,"column":4},"source":"cronactions.js","original":{"line":91,"column":4}},{"generated":{"line":90,"column":7},"source":"cronactions.js","original":{"line":91,"column":7}},{"generated":{"line":90,"column":10},"source":"cronactions.js","original":{"line":91,"column":10}},{"generated":{"line":90,"column":11},"source":"cronactions.js","original":{"line":91,"column":0}},{"generated":{"line":91,"column":0},"source":"cronactions.js","original":{"line":92,"column":0}},{"name":"process","generated":{"line":91,"column":24},"source":"cronactions.js","original":{"line":92,"column":9}},{"generated":{"line":91,"column":31},"source":"cronactions.js","original":{"line":92,"column":16}},{"name":"env","generated":{"line":91,"column":32},"source":"cronactions.js","original":{"line":92,"column":17}},{"generated":{"line":91,"column":35},"source":"cronactions.js","original":{"line":92,"column":9}},{"name":"VIRUSTOTAL_SECOND_AND_THIRD_SCAN_CRON","generated":{"line":91,"column":36},"source":"cronactions.js","original":{"line":92,"column":21}},{"generated":{"line":91,"column":73},"source":"cronactions.js","original":{"line":92,"column":0}},{"generated":{"line":91,"column":75},"source":"cronactions.js","original":{"line":92,"column":60}},{"generated":{"line":91,"column":87},"source":"cronactions.js","original":{"line":92,"column":72}},{"generated":{"line":92,"column":0},"source":"cronactions.js","original":{"line":93,"column":4}},{"name":"files","generated":{"line":92,"column":8},"source":"cronactions.js","original":{"line":93,"column":10}},{"generated":{"line":92,"column":13},"source":"cronactions.js","original":{"line":93,"column":15}},{"generated":{"line":92,"column":16},"source":"cronactions.js","original":{"line":93,"column":18}},{"generated":{"line":92,"column":22},"source":"cronactions.js","original":{"line":93,"column":24}},{"generated":{"line":92,"column":52},"source":"cronactions.js","original":{"line":93,"column":4}},{"name":"num","generated":{"line":93,"column":0},"source":"cronactions.js","original":{"line":95,"column":4}},{"name":"num","generated":{"line":93,"column":2},"source":"cronactions.js","original":{"line":95,"column":4}},{"generated":{"line":93,"column":5},"source":"cronactions.js","original":{"line":95,"column":7}},{"generated":{"line":95,"column":0},"source":"cronactions.js","original":{"line":97,"column":4}},{"generated":{"line":95,"column":6},"source":"cronactions.js","original":{"line":97,"column":8}},{"name":"files","generated":{"line":95,"column":7},"source":"cronactions.js","original":{"line":97,"column":9}},{"generated":{"line":95,"column":12},"source":"cronactions.js","original":{"line":97,"column":4}},{"generated":{"line":95,"column":14},"source":"cronactions.js","original":{"line":97,"column":16}},{"generated":{"line":96,"column":0},"source":"cronactions.js","original":{"line":98,"column":8}},{"generated":{"line":97,"column":0},"source":"cronactions.js","original":{"line":99,"column":5}},{"generated":{"line":99,"column":0},"source":"cronactions.js","original":{"line":101,"column":4}},{"name":"files","generated":{"line":99,"column":6},"source":"cronactions.js","original":{"line":101,"column":8}},{"generated":{"line":99,"column":11},"source":"cronactions.js","original":{"line":101,"column":13}},{"name":"length","generated":{"line":99,"column":12},"source":"cronactions.js","original":{"line":101,"column":14}},{"generated":{"line":99,"column":18},"source":"cronactions.js","original":{"line":101,"column":8}},{"generated":{"line":99,"column":23},"source":"cronactions.js","original":{"line":101,"column":25}},{"generated":{"line":99,"column":24},"source":"cronactions.js","original":{"line":101,"column":4}},{"generated":{"line":99,"column":26},"source":"cronactions.js","original":{"line":101,"column":28}},{"generated":{"line":100,"column":0},"source":"cronactions.js","original":{"line":102,"column":8}},{"generated":{"line":101,"column":0},"source":"cronactions.js","original":{"line":103,"column":5}},{"name":"files","generated":{"line":103,"column":0},"source":"cronactions.js","original":{"line":105,"column":4}},{"name":"files","generated":{"line":103,"column":2},"source":"cronactions.js","original":{"line":105,"column":4}},{"generated":{"line":103,"column":7},"source":"cronactions.js","original":{"line":105,"column":9}},{"name":"forEach","generated":{"line":103,"column":8},"source":"cronactions.js","original":{"line":105,"column":10}},{"generated":{"line":103,"column":15},"source":"cronactions.js","original":{"line":105,"column":4}},{"name":"file","generated":{"line":103,"column":16},"source":"cronactions.js","original":{"line":105,"column":18}},{"generated":{"line":103,"column":20},"source":"cronactions.js","original":{"line":105,"column":22}},{"generated":{"line":103,"column":24},"source":"cronactions.js","original":{"line":105,"column":26}},{"name":"virusTotal","generated":{"line":104,"column":0},"source":"cronactions.js","original":{"line":106,"column":8}},{"name":"virusTotal","generated":{"line":104,"column":4},"source":"cronactions.js","original":{"line":106,"column":8}},{"generated":{"line":104,"column":14},"source":"cronactions.js","original":{"line":106,"column":18}},{"name":"scan","generated":{"line":104,"column":15},"source":"cronactions.js","original":{"line":106,"column":19}},{"generated":{"line":104,"column":19},"source":"cronactions.js","original":{"line":106,"column":8}},{"name":"file","generated":{"line":104,"column":20},"source":"cronactions.js","original":{"line":106,"column":24}},{"generated":{"line":104,"column":24},"source":"cronactions.js","original":{"line":106,"column":28}},{"name":"filehash","generated":{"line":104,"column":25},"source":"cronactions.js","original":{"line":106,"column":29}},{"generated":{"line":104,"column":33},"source":"cronactions.js","original":{"line":106,"column":8}},{"name":"file","generated":{"line":104,"column":35},"source":"cronactions.js","original":{"line":106,"column":39}},{"generated":{"line":104,"column":39},"source":"cronactions.js","original":{"line":106,"column":43}},{"name":"filename","generated":{"line":104,"column":40},"source":"cronactions.js","original":{"line":106,"column":44}},{"generated":{"line":104,"column":48},"source":"cronactions.js","original":{"line":106,"column":8}},{"generated":{"line":104,"column":50},"source":"cronactions.js","original":{"line":106,"column":54}},{"name":"file","generated":{"line":104,"column":52},"source":"cronactions.js","original":{"line":106,"column":56}},{"generated":{"line":104,"column":56},"source":"cronactions.js","original":{"line":106,"column":60}},{"name":"virusTotalScan","generated":{"line":104,"column":57},"source":"cronactions.js","original":{"line":106,"column":61}},{"generated":{"line":104,"column":71},"source":"cronactions.js","original":{"line":106,"column":8}},{"generated":{"line":105,"column":0},"source":"cronactions.js","original":{"line":107,"column":5}},{"generated":{"line":105,"column":3},"source":"cronactions.js","original":{"line":105,"column":4}},{"generated":{"line":106,"column":0},"source":"cronactions.js","original":{"line":108,"column":1}},{"generated":{"line":106,"column":1},"source":"cronactions.js","original":{"line":92,"column":0}},{"name":"messageServer","generated":{"line":107,"column":0},"source":"cronactions.js","original":{"line":110,"column":0}},{"generated":{"line":107,"column":13},"source":"cronactions.js","original":{"line":110,"column":13}},{"name":"listen","generated":{"line":107,"column":14},"source":"cronactions.js","original":{"line":110,"column":14}},{"generated":{"line":107,"column":20},"source":"cronactions.js","original":{"line":110,"column":0}},{"name":"parseInt","generated":{"line":107,"column":21},"source":"cronactions.js","original":{"line":110,"column":21}},{"generated":{"line":107,"column":29},"source":"cronactions.js","original":{"line":110,"column":29}},{"name":"process","generated":{"line":107,"column":30},"source":"cronactions.js","original":{"line":110,"column":30}},{"generated":{"line":107,"column":37},"source":"cronactions.js","original":{"line":110,"column":37}},{"name":"env","generated":{"line":107,"column":38},"source":"cronactions.js","original":{"line":110,"column":38}},{"generated":{"line":107,"column":41},"source":"cronactions.js","original":{"line":110,"column":30}},{"name":"MESSAGE_SERVER_PORT","generated":{"line":107,"column":42},"source":"cronactions.js","original":{"line":110,"column":42}},{"generated":{"line":107,"column":61},"source":"cronactions.js","original":{"line":110,"column":29}},{"generated":{"line":107,"column":62},"source":"cronactions.js","original":{"line":110,"column":0}}],"sources":{"cronactions.js":"import { schedule }             from 'node-cron';\r\nimport dnode                    from \"dnode\";\r\nimport async                    from \"async\"; \r\nimport debugge                  from \"debug\";\r\nimport scanAndRemoveFile        from \"./Functions/Upload/scanAndRemoveFile\";\r\nimport getFilesToDelete         from \"./Functions/FileDeletion/getFilesToDelete\";\r\nimport deleteFiles              from \"./Functions/FileDeletion/deleteFiles\";\r\nimport getFilesForSecondaryScan from \"./Functions/SecondaryScan/GetFilesForSecondaryScan\";\r\nimport getFilesToScan            from \"./Functions/VirusTotal/getFilesToScan\";\r\nimport VirusTotalScanner        from \"./Classes/VirusTotalScanner\";\r\n\r\nimport dotenv from \"dotenv\";\r\ndotenv.config();\r\n\r\nconst virusTotal = new VirusTotalScanner(process.env.VIRUSTOTAL_KEY,\r\n                                         process.env.VIRUSTOTAL_MAX_SCAN_WAIT_MS,\r\n                                         process.env.VIRUSTOTAL_MAX_SCANS_PR_MINUTE,\r\n                                         process.env.VIRUSTOTAL_MIN_ALLOWED_POSITIVES,\r\n                                         process.env.UPLOAD_DESTINATION)\r\n\r\n\r\n/**\r\n * Limits the AV scans\r\n */\r\nconst sophosQueue = async.queue(async (task) => {\r\n    debugge(\"sophos-call\")(task);\r\n    \r\n    // This is a hack that makes it possible to develop without having Sophos installed. Don't tell anyone :v\r\n    if (process.env.NODE_ENV === \"production\")\r\n        await scanAndRemoveFile(task.fileName, task.fileSha);\r\n}, 1);\r\n\r\n/**\r\n * Functions the app can call\r\n */\r\nconst messageServer = dnode({\r\n    sophosScan: (fileName, fileSha) => {\r\n        sophosQueue.push({\r\n            fileName: fileName,\r\n            fileSha: fileSha\r\n        });\r\n    },\r\n    virusTotalScan: (fileHash, fileName, scanNumber) => {\r\n        virusTotal.scan(fileHash, fileName, scanNumber);\r\n    }\r\n});\r\n\r\n\r\n\r\n/**\r\n * Remove files that are too old\r\n */\r\nschedule(process.env.FILE_DELETION_CRON, async () => {\r\n    const files = await getFilesToDelete();\r\n    \r\n    // Prevent additional files from being scanned\r\n    if (files.length === 0)\r\n        return;\r\n\r\n    // Removes duplicates\r\n    const unique = [...new Set(files.map(file => file.filename))];\r\n\r\n    deleteFiles(unique);\r\n});\r\n\r\n/**\r\n * Secondary AV scan of uploaded files\r\n */\r\nschedule(process.env.SECONDARY_SCAN_CRON, async () => {\r\n    const files = await getFilesForSecondaryScan();\r\n\r\n    if (!files) {\r\n        return;\r\n    }\r\n\r\n    if (files.length === 0) {\r\n        return;\r\n    }\r\n\r\n    debugge(\"scanner-schedule\")(files);\r\n \r\n    files.forEach(file => {\r\n        sophosQueue.push({\r\n            fileName: file.fileName,\r\n            fileSha: file.filesha\r\n        });\r\n    })\r\n});\r\n\r\n\r\nlet num = 0;\r\nschedule(process.env.VIRUSTOTAL_SECOND_AND_THIRD_SCAN_CRON, async () => {\r\n    const files = await getFilesToScan();\r\n\r\n    num++;\r\n\r\n    if (!files) {\r\n        return;\r\n    }\r\n\r\n    if (files.length === 0) {\r\n        return;\r\n    }\r\n    \r\n    files.forEach(file => {\r\n        virusTotal.scan(file.filehash, file.filename, ++file.virusTotalScan);\r\n    });    \r\n})\r\n \r\nmessageServer.listen(parseInt(process.env.MESSAGE_SERVER_PORT));"},"lineCount":null}},"hash":"16c8c8af8ee5f2f9fd0ef611eaf086aa","cacheData":{"env":{}}}