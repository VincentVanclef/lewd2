{"id":"SN7l","dependencies":[{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\.babelrc","includedInParent":true,"mtime":1545517173655},{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\package.json","includedInParent":true,"mtime":1545850952595},{"name":"../../helpers/database","loc":{"line":1,"column":53},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Controllers\\register\\register.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\helpers\\database.js"},{"name":"../../Functions/Register/tokenData","loc":{"line":5,"column":53},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Controllers\\register\\register.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\Register\\tokenData.js"},{"name":"../../Functions/Register/checkIfUsernameExists","loc":{"line":6,"column":53},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Controllers\\register\\register.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\Register\\checkIfUsernameExists.js"}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.get=i,exports.post=d,exports.validate=void 0;var e=n(require(\"../../helpers/database\")),s=n(require(\"bcrypt\")),r=require(\"express-validator/check\"),t=n(require(\"crypto\")),a=require(\"../../Functions/Register/tokenData\"),o=require(\"../../Functions/Register/checkIfUsernameExists\");function n(e){return e&&e.__esModule?e:{default:e}}async function i(e,s){const r=await(0,a.getTokenData)(e.params.token),t=(0,a.checkTokenDataForErrors)(r);if(t)return e.session.err=t,s.redirect(\"/\");s.render(\"register\",{token:e.params.token})}async function d(o,n){const i=await(0,a.getTokenData)(o.body.token),d=(0,a.checkTokenDataForErrors)(i);if(d)return o.session.err=d,n.redirect(\"/register/\"+o.body.token);const c=(0,r.validationResult)(o);if(!c.isEmpty())return o.session.err=c.array(),n.redirect(\"/register/\"+o.body.token);const u=await e.default.connect();if(1===(await u.query('SELECT username FROM \"Users\" WHERE username = $1;',[o.body.username])).rows.length)return await u.release(),n.redirect(\"/register/\"+o.body.token);const h=o.body.username,l=await s.default.hash(o.body.password,parseInt(process.env.BCRYPT_SALT_ROUNDS)),k=t.default.createHash(\"sha1\").update(h+Date.now().toString()).digest(\"hex\"),g=o.body.roleid,p=i.uploadsize,w=i.isadmin;await u.query('INSERT INTO \"Users\" (username, password, token, roleid, uploadsize, isadmin)\\n                        VALUES ($1, $2, $3, $4, $5, $6);',[h,l,k,g,p,w]),await u.query('UPDATE \"RegisterTokens\" SET used = TRUE WHERE token = $1;',[o.body.token]),await u.release(),o.flash(\"userAdded\",\"You are now ready to sign in\"),n.redirect(\"/\")}const c=[(0,r.check)(\"token\").isString().withMessage(\"Invalid token\").isLength({min:10}).withMessage(\"Token too short\"),(0,r.check)(\"username\").isLength({min:2}).withMessage(\"Username needs to be at least 2 characters long\").custom(o.checkIfUsernameNotExists).withMessage(\"Username already in use\"),(0,r.check)(\"password\").exists().withMessage(\"Please select a password\").isLength({min:3,max:72}).withMessage(\"Password needs to be 2 characters long\")];exports.validate=c;","map":{"mappings":[{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":0}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":13}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":20}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":35}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":43}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":56}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":57}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":64}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":68}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":76}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":80}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":82}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":90}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":95}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":97}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":105}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":119}},{"source":"Controllers/register/register.js","original":{"line":1,"column":0},"generated":{"line":1,"column":121}},{"source":"Controllers/register/register.js","original":{"line":1,"column":0},"generated":{"line":1,"column":125}},{"source":"Controllers/register/register.js","original":{"line":1,"column":0},"generated":{"line":1,"column":127}},{"source":"Controllers/register/register.js","original":{"line":1,"column":0},"generated":{"line":1,"column":129}},{"source":"Controllers/register/register.js","original":{"line":1,"column":0},"generated":{"line":1,"column":137}},{"source":"Controllers/register/register.js","original":{"line":2,"column":0},"generated":{"line":1,"column":164}},{"source":"Controllers/register/register.js","original":{"line":2,"column":0},"generated":{"line":1,"column":166}},{"source":"Controllers/register/register.js","original":{"line":2,"column":0},"generated":{"line":1,"column":168}},{"source":"Controllers/register/register.js","original":{"line":2,"column":0},"generated":{"line":1,"column":176}},{"source":"Controllers/register/register.js","original":{"line":3,"column":0},"generated":{"line":1,"column":187}},{"source":"Controllers/register/register.js","original":{"line":3,"column":0},"generated":{"line":1,"column":189}},{"source":"Controllers/register/register.js","original":{"line":3,"column":0},"generated":{"line":1,"column":197}},{"source":"Controllers/register/register.js","original":{"line":4,"column":0},"generated":{"line":1,"column":224}},{"source":"Controllers/register/register.js","original":{"line":4,"column":0},"generated":{"line":1,"column":226}},{"source":"Controllers/register/register.js","original":{"line":4,"column":0},"generated":{"line":1,"column":228}},{"source":"Controllers/register/register.js","original":{"line":4,"column":0},"generated":{"line":1,"column":236}},{"source":"Controllers/register/register.js","original":{"line":5,"column":0},"generated":{"line":1,"column":247}},{"source":"Controllers/register/register.js","original":{"line":5,"column":0},"generated":{"line":1,"column":249}},{"source":"Controllers/register/register.js","original":{"line":5,"column":0},"generated":{"line":1,"column":257}},{"source":"Controllers/register/register.js","original":{"line":6,"column":0},"generated":{"line":1,"column":295}},{"source":"Controllers/register/register.js","original":{"line":6,"column":0},"generated":{"line":1,"column":297}},{"source":"Controllers/register/register.js","original":{"line":6,"column":0},"generated":{"line":1,"column":305}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":355}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":364}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":366}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":369}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":376}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":379}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":381}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":392}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":394}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":395}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":403}},{"source":"Controllers/register/register.js","original":{"line":9,"column":0},"generated":{"line":1,"column":406}},{"source":"Controllers/register/register.js","name":"get","original":{"line":9,"column":15},"generated":{"line":1,"column":421}},{"source":"Controllers/register/register.js","name":"req","original":{"line":9,"column":19},"generated":{"line":1,"column":423}},{"source":"Controllers/register/register.js","name":"res","original":{"line":9,"column":24},"generated":{"line":1,"column":425}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":11,"column":10},"generated":{"line":1,"column":428}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":11,"column":10},"generated":{"line":1,"column":434}},{"source":"Controllers/register/register.js","original":{"line":11,"column":33},"generated":{"line":1,"column":442}},{"source":"Controllers/register/register.js","name":"req","original":{"line":11,"column":46},"generated":{"line":1,"column":444}},{"source":"Controllers/register/register.js","name":"req","original":{"line":11,"column":46},"generated":{"line":1,"column":446}},{"source":"Controllers/register/register.js","name":"req","original":{"line":11,"column":46},"generated":{"line":1,"column":460}},{"source":"Controllers/register/register.js","name":"params","original":{"line":11,"column":50},"generated":{"line":1,"column":462}},{"source":"Controllers/register/register.js","name":"token","original":{"line":11,"column":57},"generated":{"line":1,"column":469}},{"source":"Controllers/register/register.js","name":"tokenIsInvalid","original":{"line":12,"column":10},"generated":{"line":1,"column":476}},{"source":"Controllers/register/register.js","original":{"line":12,"column":28},"generated":{"line":1,"column":479}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":12,"column":52},"generated":{"line":1,"column":481}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":12,"column":52},"generated":{"line":1,"column":483}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":12,"column":52},"generated":{"line":1,"column":508}},{"source":"Controllers/register/register.js","name":"tokenIsInvalid","original":{"line":15,"column":8},"generated":{"line":1,"column":511}},{"source":"Controllers/register/register.js","name":"tokenIsInvalid","original":{"line":15,"column":8},"generated":{"line":1,"column":514}},{"source":"Controllers/register/register.js","name":"res","original":{"line":17,"column":15},"generated":{"line":1,"column":516}},{"source":"Controllers/register/register.js","name":"req","original":{"line":16,"column":8},"generated":{"line":1,"column":523}},{"source":"Controllers/register/register.js","name":"session","original":{"line":16,"column":12},"generated":{"line":1,"column":525}},{"source":"Controllers/register/register.js","name":"err","original":{"line":16,"column":20},"generated":{"line":1,"column":533}},{"source":"Controllers/register/register.js","name":"tokenIsInvalid","original":{"line":16,"column":26},"generated":{"line":1,"column":537}},{"source":"Controllers/register/register.js","name":"res","original":{"line":17,"column":15},"generated":{"line":1,"column":539}},{"source":"Controllers/register/register.js","name":"redirect","original":{"line":17,"column":19},"generated":{"line":1,"column":541}},{"source":"Controllers/register/register.js","original":{"line":17,"column":28},"generated":{"line":1,"column":550}},{"source":"Controllers/register/register.js","name":"res","original":{"line":21,"column":4},"generated":{"line":1,"column":555}},{"source":"Controllers/register/register.js","name":"render","original":{"line":21,"column":8},"generated":{"line":1,"column":557}},{"source":"Controllers/register/register.js","original":{"line":21,"column":15},"generated":{"line":1,"column":564}},{"source":"Controllers/register/register.js","original":{"line":21,"column":27},"generated":{"line":1,"column":575}},{"source":"Controllers/register/register.js","name":"token","original":{"line":22,"column":8},"generated":{"line":1,"column":576}},{"source":"Controllers/register/register.js","name":"req","original":{"line":22,"column":15},"generated":{"line":1,"column":582}},{"source":"Controllers/register/register.js","name":"params","original":{"line":22,"column":19},"generated":{"line":1,"column":584}},{"source":"Controllers/register/register.js","name":"token","original":{"line":22,"column":26},"generated":{"line":1,"column":591}},{"source":"Controllers/register/register.js","original":{"line":27,"column":0},"generated":{"line":1,"column":599}},{"source":"Controllers/register/register.js","name":"post","original":{"line":27,"column":15},"generated":{"line":1,"column":614}},{"source":"Controllers/register/register.js","name":"req","original":{"line":27,"column":20},"generated":{"line":1,"column":616}},{"source":"Controllers/register/register.js","name":"res","original":{"line":27,"column":25},"generated":{"line":1,"column":618}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":32,"column":10},"generated":{"line":1,"column":621}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":32,"column":10},"generated":{"line":1,"column":627}},{"source":"Controllers/register/register.js","original":{"line":32,"column":33},"generated":{"line":1,"column":635}},{"source":"Controllers/register/register.js","name":"req","original":{"line":32,"column":46},"generated":{"line":1,"column":637}},{"source":"Controllers/register/register.js","name":"req","original":{"line":32,"column":46},"generated":{"line":1,"column":639}},{"source":"Controllers/register/register.js","name":"req","original":{"line":32,"column":46},"generated":{"line":1,"column":653}},{"source":"Controllers/register/register.js","name":"body","original":{"line":32,"column":50},"generated":{"line":1,"column":655}},{"source":"Controllers/register/register.js","name":"token","original":{"line":32,"column":55},"generated":{"line":1,"column":660}},{"source":"Controllers/register/register.js","name":"tokenIsInvalid","original":{"line":33,"column":10},"generated":{"line":1,"column":667}},{"source":"Controllers/register/register.js","original":{"line":33,"column":28},"generated":{"line":1,"column":670}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":33,"column":52},"generated":{"line":1,"column":672}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":33,"column":52},"generated":{"line":1,"column":674}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":33,"column":52},"generated":{"line":1,"column":699}},{"source":"Controllers/register/register.js","name":"tokenIsInvalid","original":{"line":36,"column":8},"generated":{"line":1,"column":702}},{"source":"Controllers/register/register.js","name":"tokenIsInvalid","original":{"line":36,"column":8},"generated":{"line":1,"column":705}},{"source":"Controllers/register/register.js","name":"res","original":{"line":38,"column":15},"generated":{"line":1,"column":707}},{"source":"Controllers/register/register.js","name":"req","original":{"line":37,"column":8},"generated":{"line":1,"column":714}},{"source":"Controllers/register/register.js","name":"session","original":{"line":37,"column":12},"generated":{"line":1,"column":716}},{"source":"Controllers/register/register.js","name":"err","original":{"line":37,"column":20},"generated":{"line":1,"column":724}},{"source":"Controllers/register/register.js","name":"tokenIsInvalid","original":{"line":37,"column":26},"generated":{"line":1,"column":728}},{"source":"Controllers/register/register.js","name":"res","original":{"line":38,"column":15},"generated":{"line":1,"column":730}},{"source":"Controllers/register/register.js","name":"redirect","original":{"line":38,"column":19},"generated":{"line":1,"column":732}},{"source":"Controllers/register/register.js","original":{"line":38,"column":28},"generated":{"line":1,"column":741}},{"source":"Controllers/register/register.js","name":"req","original":{"line":38,"column":43},"generated":{"line":1,"column":754}},{"source":"Controllers/register/register.js","name":"body","original":{"line":38,"column":47},"generated":{"line":1,"column":756}},{"source":"Controllers/register/register.js","name":"token","original":{"line":38,"column":52},"generated":{"line":1,"column":761}},{"source":"Controllers/register/register.js","name":"errors","original":{"line":45,"column":10},"generated":{"line":1,"column":768}},{"source":"Controllers/register/register.js","name":"errors","original":{"line":45,"column":10},"generated":{"line":1,"column":774}},{"source":"Controllers/register/register.js","original":{"line":45,"column":19},"generated":{"line":1,"column":777}},{"source":"Controllers/register/register.js","name":"req","original":{"line":45,"column":36},"generated":{"line":1,"column":779}},{"source":"Controllers/register/register.js","name":"req","original":{"line":45,"column":36},"generated":{"line":1,"column":781}},{"source":"Controllers/register/register.js","name":"req","original":{"line":45,"column":36},"generated":{"line":1,"column":799}},{"source":"Controllers/register/register.js","original":{"line":46,"column":8},"generated":{"line":1,"column":802}},{"source":"Controllers/register/register.js","name":"errors","original":{"line":46,"column":9},"generated":{"line":1,"column":806}},{"source":"Controllers/register/register.js","name":"isEmpty","original":{"line":46,"column":16},"generated":{"line":1,"column":808}},{"source":"Controllers/register/register.js","name":"res","original":{"line":48,"column":15},"generated":{"line":1,"column":818}},{"source":"Controllers/register/register.js","name":"req","original":{"line":47,"column":8},"generated":{"line":1,"column":825}},{"source":"Controllers/register/register.js","name":"session","original":{"line":47,"column":12},"generated":{"line":1,"column":827}},{"source":"Controllers/register/register.js","name":"err","original":{"line":47,"column":20},"generated":{"line":1,"column":835}},{"source":"Controllers/register/register.js","name":"errors","original":{"line":47,"column":26},"generated":{"line":1,"column":839}},{"source":"Controllers/register/register.js","name":"array","original":{"line":47,"column":33},"generated":{"line":1,"column":841}},{"source":"Controllers/register/register.js","name":"res","original":{"line":48,"column":15},"generated":{"line":1,"column":849}},{"source":"Controllers/register/register.js","name":"redirect","original":{"line":48,"column":19},"generated":{"line":1,"column":851}},{"source":"Controllers/register/register.js","original":{"line":48,"column":28},"generated":{"line":1,"column":860}},{"source":"Controllers/register/register.js","name":"req","original":{"line":48,"column":43},"generated":{"line":1,"column":873}},{"source":"Controllers/register/register.js","name":"body","original":{"line":48,"column":47},"generated":{"line":1,"column":875}},{"source":"Controllers/register/register.js","name":"token","original":{"line":48,"column":52},"generated":{"line":1,"column":880}},{"source":"Controllers/register/register.js","name":"client","original":{"line":54,"column":10},"generated":{"line":1,"column":887}},{"source":"Controllers/register/register.js","name":"client","original":{"line":54,"column":10},"generated":{"line":1,"column":893}},{"source":"Controllers/register/register.js","name":"db","original":{"line":54,"column":25},"generated":{"line":1,"column":901}},{"source":"Controllers/register/register.js","name":"connect","original":{"line":54,"column":28},"generated":{"line":1,"column":903}},{"source":"Controllers/register/register.js","name":"connect","original":{"line":54,"column":28},"generated":{"line":1,"column":911}},{"source":"Controllers/register/register.js","name":"getUser","original":{"line":57,"column":8},"generated":{"line":1,"column":921}},{"source":"Controllers/register/register.js","original":{"line":57,"column":32},"generated":{"line":1,"column":924}},{"source":"Controllers/register/register.js","name":"client","original":{"line":56,"column":26},"generated":{"line":1,"column":935}},{"source":"Controllers/register/register.js","name":"query","original":{"line":56,"column":33},"generated":{"line":1,"column":937}},{"source":"Controllers/register/register.js","original":{"line":56,"column":40},"generated":{"line":1,"column":943}},{"source":"Controllers/register/register.js","original":{"line":56,"column":92},"generated":{"line":1,"column":995}},{"source":"Controllers/register/register.js","name":"req","original":{"line":56,"column":93},"generated":{"line":1,"column":996}},{"source":"Controllers/register/register.js","name":"body","original":{"line":56,"column":97},"generated":{"line":1,"column":998}},{"source":"Controllers/register/register.js","name":"username","original":{"line":56,"column":102},"generated":{"line":1,"column":1003}},{"source":"Controllers/register/register.js","name":"rows","original":{"line":57,"column":16},"generated":{"line":1,"column":1015}},{"source":"Controllers/register/register.js","name":"length","original":{"line":57,"column":21},"generated":{"line":1,"column":1020}},{"source":"Controllers/register/register.js","name":"res","original":{"line":60,"column":15},"generated":{"line":1,"column":1027}},{"source":"Controllers/register/register.js","name":"client","original":{"line":58,"column":14},"generated":{"line":1,"column":1040}},{"source":"Controllers/register/register.js","name":"release","original":{"line":58,"column":21},"generated":{"line":1,"column":1042}},{"source":"Controllers/register/register.js","name":"res","original":{"line":60,"column":15},"generated":{"line":1,"column":1052}},{"source":"Controllers/register/register.js","name":"redirect","original":{"line":60,"column":19},"generated":{"line":1,"column":1054}},{"source":"Controllers/register/register.js","original":{"line":60,"column":28},"generated":{"line":1,"column":1063}},{"source":"Controllers/register/register.js","name":"req","original":{"line":60,"column":43},"generated":{"line":1,"column":1076}},{"source":"Controllers/register/register.js","name":"body","original":{"line":60,"column":47},"generated":{"line":1,"column":1078}},{"source":"Controllers/register/register.js","name":"token","original":{"line":60,"column":52},"generated":{"line":1,"column":1083}},{"source":"Controllers/register/register.js","name":"username","original":{"line":66,"column":10},"generated":{"line":1,"column":1090}},{"source":"Controllers/register/register.js","name":"username","original":{"line":66,"column":10},"generated":{"line":1,"column":1096}},{"source":"Controllers/register/register.js","name":"req","original":{"line":66,"column":21},"generated":{"line":1,"column":1098}},{"source":"Controllers/register/register.js","name":"body","original":{"line":66,"column":25},"generated":{"line":1,"column":1100}},{"source":"Controllers/register/register.js","name":"username","original":{"line":66,"column":30},"generated":{"line":1,"column":1105}},{"source":"Controllers/register/register.js","name":"password","original":{"line":67,"column":10},"generated":{"line":1,"column":1114}},{"source":"Controllers/register/register.js","name":"bcrypt","original":{"line":67,"column":27},"generated":{"line":1,"column":1122}},{"source":"Controllers/register/register.js","name":"hash","original":{"line":67,"column":34},"generated":{"line":1,"column":1124}},{"source":"Controllers/register/register.js","name":"hash","original":{"line":67,"column":34},"generated":{"line":1,"column":1132}},{"source":"Controllers/register/register.js","name":"req","original":{"line":67,"column":39},"generated":{"line":1,"column":1137}},{"source":"Controllers/register/register.js","name":"body","original":{"line":67,"column":43},"generated":{"line":1,"column":1139}},{"source":"Controllers/register/register.js","name":"password","original":{"line":67,"column":48},"generated":{"line":1,"column":1144}},{"source":"Controllers/register/register.js","name":"parseInt","original":{"line":67,"column":58},"generated":{"line":1,"column":1153}},{"source":"Controllers/register/register.js","name":"process","original":{"line":67,"column":67},"generated":{"line":1,"column":1162}},{"source":"Controllers/register/register.js","name":"env","original":{"line":67,"column":75},"generated":{"line":1,"column":1170}},{"source":"Controllers/register/register.js","name":"BCRYPT_SALT_ROUNDS","original":{"line":67,"column":79},"generated":{"line":1,"column":1174}},{"source":"Controllers/register/register.js","name":"token","original":{"line":68,"column":10},"generated":{"line":1,"column":1195}},{"source":"Controllers/register/register.js","name":"crypto","original":{"line":68,"column":21},"generated":{"line":1,"column":1197}},{"source":"Controllers/register/register.js","name":"createHash","original":{"line":68,"column":28},"generated":{"line":1,"column":1199}},{"source":"Controllers/register/register.js","name":"createHash","original":{"line":68,"column":28},"generated":{"line":1,"column":1207}},{"source":"Controllers/register/register.js","original":{"line":68,"column":39},"generated":{"line":1,"column":1218}},{"source":"Controllers/register/register.js","name":"update","original":{"line":69,"column":28},"generated":{"line":1,"column":1226}},{"source":"Controllers/register/register.js","name":"username","original":{"line":69,"column":35},"generated":{"line":1,"column":1233}},{"source":"Controllers/register/register.js","name":"Date","original":{"line":69,"column":46},"generated":{"line":1,"column":1235}},{"source":"Controllers/register/register.js","name":"now","original":{"line":69,"column":51},"generated":{"line":1,"column":1240}},{"source":"Controllers/register/register.js","name":"toString","original":{"line":69,"column":57},"generated":{"line":1,"column":1246}},{"source":"Controllers/register/register.js","name":"digest","original":{"line":70,"column":28},"generated":{"line":1,"column":1258}},{"source":"Controllers/register/register.js","original":{"line":70,"column":35},"generated":{"line":1,"column":1265}},{"source":"Controllers/register/register.js","name":"roleid","original":{"line":72,"column":10},"generated":{"line":1,"column":1272}},{"source":"Controllers/register/register.js","name":"req","original":{"line":72,"column":23},"generated":{"line":1,"column":1274}},{"source":"Controllers/register/register.js","name":"body","original":{"line":72,"column":27},"generated":{"line":1,"column":1276}},{"source":"Controllers/register/register.js","name":"roleid","original":{"line":72,"column":32},"generated":{"line":1,"column":1281}},{"source":"Controllers/register/register.js","name":"uploadSize","original":{"line":73,"column":10},"generated":{"line":1,"column":1288}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":73,"column":23},"generated":{"line":1,"column":1290}},{"source":"Controllers/register/register.js","name":"uploadsize","original":{"line":73,"column":33},"generated":{"line":1,"column":1292}},{"source":"Controllers/register/register.js","name":"isAdmin","original":{"line":74,"column":10},"generated":{"line":1,"column":1303}},{"source":"Controllers/register/register.js","name":"tokenData","original":{"line":74,"column":23},"generated":{"line":1,"column":1305}},{"source":"Controllers/register/register.js","name":"isadmin","original":{"line":74,"column":33},"generated":{"line":1,"column":1307}},{"source":"Controllers/register/register.js","name":"client","original":{"line":76,"column":10},"generated":{"line":1,"column":1321}},{"source":"Controllers/register/register.js","name":"query","original":{"line":76,"column":17},"generated":{"line":1,"column":1323}},{"source":"Controllers/register/register.js","original":{"line":76,"column":24},"generated":{"line":1,"column":1329}},{"source":"Controllers/register/register.js","original":{"line":77,"column":59},"generated":{"line":1,"column":1466}},{"source":"Controllers/register/register.js","name":"username","original":{"line":78,"column":28},"generated":{"line":1,"column":1467}},{"source":"Controllers/register/register.js","name":"password","original":{"line":79,"column":28},"generated":{"line":1,"column":1469}},{"source":"Controllers/register/register.js","name":"token","original":{"line":80,"column":28},"generated":{"line":1,"column":1471}},{"source":"Controllers/register/register.js","name":"roleid","original":{"line":81,"column":28},"generated":{"line":1,"column":1473}},{"source":"Controllers/register/register.js","name":"uploadSize","original":{"line":82,"column":28},"generated":{"line":1,"column":1475}},{"source":"Controllers/register/register.js","name":"isAdmin","original":{"line":83,"column":28},"generated":{"line":1,"column":1477}},{"source":"Controllers/register/register.js","name":"client","original":{"line":86,"column":10},"generated":{"line":1,"column":1487}},{"source":"Controllers/register/register.js","name":"query","original":{"line":86,"column":17},"generated":{"line":1,"column":1489}},{"source":"Controllers/register/register.js","original":{"line":86,"column":24},"generated":{"line":1,"column":1495}},{"source":"Controllers/register/register.js","original":{"line":86,"column":84},"generated":{"line":1,"column":1555}},{"source":"Controllers/register/register.js","name":"req","original":{"line":86,"column":85},"generated":{"line":1,"column":1556}},{"source":"Controllers/register/register.js","name":"body","original":{"line":86,"column":89},"generated":{"line":1,"column":1558}},{"source":"Controllers/register/register.js","name":"token","original":{"line":86,"column":94},"generated":{"line":1,"column":1563}},{"source":"Controllers/register/register.js","name":"client","original":{"line":87,"column":10},"generated":{"line":1,"column":1577}},{"source":"Controllers/register/register.js","name":"release","original":{"line":87,"column":17},"generated":{"line":1,"column":1579}},{"source":"Controllers/register/register.js","name":"req","original":{"line":89,"column":4},"generated":{"line":1,"column":1589}},{"source":"Controllers/register/register.js","name":"flash","original":{"line":89,"column":8},"generated":{"line":1,"column":1591}},{"source":"Controllers/register/register.js","original":{"line":89,"column":14},"generated":{"line":1,"column":1597}},{"source":"Controllers/register/register.js","original":{"line":89,"column":27},"generated":{"line":1,"column":1609}},{"source":"Controllers/register/register.js","name":"res","original":{"line":90,"column":4},"generated":{"line":1,"column":1641}},{"source":"Controllers/register/register.js","name":"redirect","original":{"line":90,"column":8},"generated":{"line":1,"column":1643}},{"source":"Controllers/register/register.js","original":{"line":90,"column":17},"generated":{"line":1,"column":1652}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":1657}},{"source":"Controllers/register/register.js","name":"validate","original":{"line":93,"column":6},"generated":{"line":1,"column":1663}},{"source":"Controllers/register/register.js","original":{"line":93,"column":17},"generated":{"line":1,"column":1665}},{"source":"Controllers/register/register.js","original":{"line":94,"column":4},"generated":{"line":1,"column":1667}},{"source":"Controllers/register/register.js","original":{"line":94,"column":10},"generated":{"line":1,"column":1669}},{"source":"Controllers/register/register.js","original":{"line":94,"column":10},"generated":{"line":1,"column":1671}},{"source":"Controllers/register/register.js","original":{"line":94,"column":10},"generated":{"line":1,"column":1678}},{"source":"Controllers/register/register.js","name":"isString","original":{"line":94,"column":19},"generated":{"line":1,"column":1687}},{"source":"Controllers/register/register.js","name":"withMessage","original":{"line":94,"column":30},"generated":{"line":1,"column":1698}},{"source":"Controllers/register/register.js","original":{"line":94,"column":42},"generated":{"line":1,"column":1710}},{"source":"Controllers/register/register.js","name":"isLength","original":{"line":95,"column":19},"generated":{"line":1,"column":1727}},{"source":"Controllers/register/register.js","original":{"line":95,"column":28},"generated":{"line":1,"column":1736}},{"source":"Controllers/register/register.js","name":"min","original":{"line":95,"column":29},"generated":{"line":1,"column":1737}},{"source":"Controllers/register/register.js","original":{"line":95,"column":34},"generated":{"line":1,"column":1741}},{"source":"Controllers/register/register.js","name":"withMessage","original":{"line":95,"column":39},"generated":{"line":1,"column":1746}},{"source":"Controllers/register/register.js","original":{"line":95,"column":51},"generated":{"line":1,"column":1758}},{"source":"Controllers/register/register.js","original":{"line":97,"column":4},"generated":{"line":1,"column":1778}},{"source":"Controllers/register/register.js","original":{"line":97,"column":10},"generated":{"line":1,"column":1780}},{"source":"Controllers/register/register.js","original":{"line":97,"column":10},"generated":{"line":1,"column":1782}},{"source":"Controllers/register/register.js","original":{"line":97,"column":10},"generated":{"line":1,"column":1789}},{"source":"Controllers/register/register.js","name":"isLength","original":{"line":97,"column":22},"generated":{"line":1,"column":1801}},{"source":"Controllers/register/register.js","original":{"line":97,"column":31},"generated":{"line":1,"column":1810}},{"source":"Controllers/register/register.js","name":"min","original":{"line":97,"column":32},"generated":{"line":1,"column":1811}},{"source":"Controllers/register/register.js","original":{"line":97,"column":37},"generated":{"line":1,"column":1815}},{"source":"Controllers/register/register.js","name":"withMessage","original":{"line":97,"column":41},"generated":{"line":1,"column":1819}},{"source":"Controllers/register/register.js","original":{"line":97,"column":53},"generated":{"line":1,"column":1831}},{"source":"Controllers/register/register.js","name":"custom","original":{"line":98,"column":22},"generated":{"line":1,"column":1882}},{"source":"Controllers/register/register.js","name":"checkIfUsernameNotExists","original":{"line":98,"column":29},"generated":{"line":1,"column":1889}},{"source":"Controllers/register/register.js","original":{"line":97,"column":4},"generated":{"line":1,"column":1891}},{"source":"Controllers/register/register.js","name":"withMessage","original":{"line":98,"column":55},"generated":{"line":1,"column":1917}},{"source":"Controllers/register/register.js","original":{"line":98,"column":67},"generated":{"line":1,"column":1929}},{"source":"Controllers/register/register.js","original":{"line":100,"column":4},"generated":{"line":1,"column":1957}},{"source":"Controllers/register/register.js","original":{"line":100,"column":10},"generated":{"line":1,"column":1959}},{"source":"Controllers/register/register.js","original":{"line":100,"column":10},"generated":{"line":1,"column":1961}},{"source":"Controllers/register/register.js","original":{"line":100,"column":10},"generated":{"line":1,"column":1968}},{"source":"Controllers/register/register.js","name":"exists","original":{"line":100,"column":22},"generated":{"line":1,"column":1980}},{"source":"Controllers/register/register.js","name":"withMessage","original":{"line":100,"column":31},"generated":{"line":1,"column":1989}},{"source":"Controllers/register/register.js","original":{"line":100,"column":43},"generated":{"line":1,"column":2001}},{"source":"Controllers/register/register.js","name":"isLength","original":{"line":101,"column":22},"generated":{"line":1,"column":2029}},{"source":"Controllers/register/register.js","original":{"line":101,"column":31},"generated":{"line":1,"column":2038}},{"source":"Controllers/register/register.js","name":"min","original":{"line":101,"column":32},"generated":{"line":1,"column":2039}},{"source":"Controllers/register/register.js","original":{"line":101,"column":37},"generated":{"line":1,"column":2043}},{"source":"Controllers/register/register.js","name":"max","original":{"line":101,"column":40},"generated":{"line":1,"column":2045}},{"source":"Controllers/register/register.js","original":{"line":101,"column":45},"generated":{"line":1,"column":2049}},{"source":"Controllers/register/register.js","name":"withMessage","original":{"line":101,"column":50},"generated":{"line":1,"column":2054}},{"source":"Controllers/register/register.js","original":{"line":101,"column":62},"generated":{"line":1,"column":2066}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":2109}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":2117}},{"source":"Controllers/register/register.js","original":{"line":93,"column":0},"generated":{"line":1,"column":2126}}],"sources":{"Controllers/register/register.js":"import db                                       from \"../../helpers/database\";\r\nimport bcrypt                                   from \"bcrypt\";\r\nimport { check, validationResult }              from 'express-validator/check';\r\nimport crypto                                   from \"crypto\";\r\nimport { getTokenData, checkTokenDataForErrors} from \"../../Functions/Register/tokenData\";\r\nimport { checkIfUsernameNotExists }             from \"../../Functions/Register/checkIfUsernameExists\";\r\n\r\n// /:token\r\nasync function get(req, res) {\r\n    // Get token data\r\n    const tokenData      = await getTokenData(req.params.token);\r\n    const tokenIsInvalid =  checkTokenDataForErrors(tokenData);\r\n    \r\n    // Report errors\r\n    if (tokenIsInvalid) {\r\n        req.session.err = tokenIsInvalid;\r\n        return res.redirect(\"/\");\r\n    }\r\n\r\n    // No errors, show the register page\r\n    res.render(\"register\", {\r\n        token: req.params.token\r\n    });\r\n}\r\n\r\n// /\r\nasync function post(req, res) {\r\n    ////////////////////////\r\n    // Catch token errors //\r\n    ////////////////////////\r\n    // Get token data\r\n    const tokenData      = await getTokenData(req.body.token);\r\n    const tokenIsInvalid =  checkTokenDataForErrors(tokenData);\r\n    \r\n    // Report errors\r\n    if (tokenIsInvalid) {\r\n        req.session.err = tokenIsInvalid;\r\n        return res.redirect(\"/register/\" + req.body.token);\r\n    }\r\n    \r\n    ////////////////////////\r\n    // Catch input errors //\r\n    ////////////////////////\r\n    \r\n    const errors = validationResult(req);\r\n    if (!errors.isEmpty()) {\r\n        req.session.err = errors.array();\r\n        return res.redirect(\"/register/\" + req.body.token);\r\n    }\r\n\r\n    //////////////////////////\r\n    // Check if user exists // \r\n    //////////////////////////\r\n    const client = await db.connect();\r\n\r\n    const getUser = await client.query(`SELECT username FROM \"Users\" WHERE username = $1;`, [req.body.username]);\r\n    if (getUser.rows.length === 1) {\r\n        await client.release();\r\n\r\n        return res.redirect(\"/register/\" + req.body.token);\r\n    }\r\n\r\n    //////////////\r\n    // Add user //\r\n    //////////////\r\n    const username = req.body.username;\r\n    const password = await bcrypt.hash(req.body.password, parseInt(process.env.BCRYPT_SALT_ROUNDS));\r\n    const token    = crypto.createHash(\"sha1\")\r\n                           .update(username + Date.now().toString())\r\n                           .digest(\"hex\");\r\n\r\n    const roleid     = req.body.roleid;\r\n    const uploadSize = tokenData.uploadsize;\r\n    const isAdmin    = tokenData.isadmin;\r\n\r\n    await client.query(`INSERT INTO \"Users\" (username, password, token, roleid, uploadsize, isadmin)\r\n                        VALUES ($1, $2, $3, $4, $5, $6);`, [\r\n                            username, \r\n                            password, \r\n                            token, \r\n                            roleid, \r\n                            uploadSize,\r\n                            isAdmin\r\n                        ]);\r\n\r\n    await client.query(`UPDATE \"RegisterTokens\" SET used = TRUE WHERE token = $1;`, [req.body.token]);\r\n    await client.release();\r\n\r\n    req.flash('userAdded', 'You are now ready to sign in');\r\n    res.redirect(\"/\");\r\n}\r\n\r\nconst validate = [\r\n    check(\"token\").isString().withMessage(\"Invalid token\")\r\n                  .isLength({min: 10}).withMessage(\"Token too short\"),\r\n\r\n    check(\"username\").isLength({min: 2}).withMessage(\"Username needs to be at least 2 characters long\")\r\n                     .custom(checkIfUsernameNotExists).withMessage(\"Username already in use\"),\r\n\r\n    check(\"password\").exists().withMessage(\"Please select a password\")\r\n                     .isLength({min: 3, max: 72}).withMessage(\"Password needs to be 2 characters long\")\r\n\r\n]\r\n\r\nexport { get, post, validate }"},"lineCount":null}},"hash":"1ee1e1c9749c95ef33026bbb50df72a0","cacheData":{"env":{}}}