{"id":"QrQj","dependencies":[{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\.babelrc","includedInParent":true,"mtime":1545517173655},{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\package.json","includedInParent":true,"mtime":1545850952595},{"name":"../Upload/symlink","loc":{"line":3,"column":26},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\FileDeletion\\deleteFiles.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\Upload\\symlink.js"},{"name":"../../helpers/database","loc":{"line":4,"column":26},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\FileDeletion\\deleteFiles.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\helpers\\database.js"}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.default=void 0;var e=o(require(\"fs\")),a=require(\"util\"),t=o(require(\"../Upload/symlink\")),r=o(require(\"../../helpers/database\")),n=o(require(\"debug\"));function o(e){return e&&e.__esModule?e:{default:e}}require(\"dotenv\").config();const s=(0,a.promisify)(e.default.unlink),u=(0,a.promisify)(e.default.rename),c=async(e,a,r)=>{const n=(await e.query('SELECT filename \\n                                         FROM \"Uploads\" \\n                                         WHERE filesha = $1;',[r])).rows;if(0!==n.length){await s(process.env.UPLOAD_DESTINATION+n[0].filename),await u(process.env.UPLOAD_DESTINATION+a,process.env.UPLOAD_DESTINATION+n[0].filename),await e.query('UPDATE \"Uploads\" \\n                        SET duplicate = FALSE \\n                        WHERE filename = $1;',[n[0].filename]);for(let e=1;e<n.length;e++){const a=n[e];await s(process.env.UPLOAD_DESTINATION+a.filename),await(0,t.default)(process.env.UPLOAD_DESTINATION+n[0].filename,process.env.UPLOAD_DESTINATION+a.filename)}}else await s(process.env.UPLOAD_DESTINATION+a)},d=async(a,t=\"null\")=>{const o=(0,n.default)(t),u=await r.default.connect();for(let r of a){o(r);const a=process.env.UPLOAD_DESTINATION+r,t=await u.query('DELETE FROM \"Uploads\" \\n                                            WHERE filename = $1 \\n                                            RETURNING filesha, duplicate;',[r]);if(0===t.rows.length)return await u.release(),!1;const n=t.rows[0];e.default.existsSync(a)&&\"robots.txt\"!==r&&(n.duplicate?await c(u,r,n.filesha):await s(a))}return!0};var E=d;exports.default=E;","map":{"mappings":[{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":0}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":13}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":20}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":35}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":43}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":56}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":57}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":64}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":68}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":76}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":89}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":1,"column":0},"generated":{"line":1,"column":91}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":1,"column":0},"generated":{"line":1,"column":95}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":1,"column":0},"generated":{"line":1,"column":97}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":1,"column":0},"generated":{"line":1,"column":99}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":1,"column":0},"generated":{"line":1,"column":107}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":2,"column":0},"generated":{"line":1,"column":114}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":2,"column":0},"generated":{"line":1,"column":116}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":2,"column":0},"generated":{"line":1,"column":124}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":3,"column":0},"generated":{"line":1,"column":132}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":3,"column":0},"generated":{"line":1,"column":134}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":3,"column":0},"generated":{"line":1,"column":136}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":3,"column":0},"generated":{"line":1,"column":144}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":4,"column":0},"generated":{"line":1,"column":166}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":4,"column":0},"generated":{"line":1,"column":168}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":4,"column":0},"generated":{"line":1,"column":170}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":4,"column":0},"generated":{"line":1,"column":178}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":5,"column":0},"generated":{"line":1,"column":205}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":5,"column":0},"generated":{"line":1,"column":207}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":5,"column":0},"generated":{"line":1,"column":209}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":5,"column":0},"generated":{"line":1,"column":217}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":227}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":236}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":238}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":241}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":248}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":251}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":253}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":264}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":266}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":267}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":275}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"require","original":{"line":7,"column":0},"generated":{"line":1,"column":278}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":7,"column":8},"generated":{"line":1,"column":286}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"config","original":{"line":7,"column":18},"generated":{"line":1,"column":296}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":9,"column":0},"generated":{"line":1,"column":305}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"unlink","original":{"line":9,"column":6},"generated":{"line":1,"column":311}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":9,"column":15},"generated":{"line":1,"column":314}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fs","original":{"line":9,"column":25},"generated":{"line":1,"column":316}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fs","original":{"line":9,"column":25},"generated":{"line":1,"column":318}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fs","original":{"line":9,"column":25},"generated":{"line":1,"column":329}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"unlink","original":{"line":9,"column":28},"generated":{"line":1,"column":331}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"unlink","original":{"line":9,"column":28},"generated":{"line":1,"column":339}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"move","original":{"line":10,"column":6},"generated":{"line":1,"column":347}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":10,"column":15},"generated":{"line":1,"column":350}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fs","original":{"line":10,"column":25},"generated":{"line":1,"column":352}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fs","original":{"line":10,"column":25},"generated":{"line":1,"column":354}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fs","original":{"line":10,"column":25},"generated":{"line":1,"column":365}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"rename","original":{"line":10,"column":28},"generated":{"line":1,"column":367}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"rename","original":{"line":10,"column":28},"generated":{"line":1,"column":375}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"handleSymlink","original":{"line":12,"column":6},"generated":{"line":1,"column":383}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":12,"column":22},"generated":{"line":1,"column":385}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"client","original":{"line":12,"column":29},"generated":{"line":1,"column":391}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileName","original":{"line":12,"column":37},"generated":{"line":1,"column":393}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileSha","original":{"line":12,"column":47},"generated":{"line":1,"column":395}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"getFiles","original":{"line":13,"column":10},"generated":{"line":1,"column":400}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"files","original":{"line":16,"column":10},"generated":{"line":1,"column":406}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"client","original":{"line":13,"column":27},"generated":{"line":1,"column":415}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"query","original":{"line":13,"column":34},"generated":{"line":1,"column":417}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":13,"column":41},"generated":{"line":1,"column":423}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":15,"column":63},"generated":{"line":1,"column":562}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileSha","original":{"line":15,"column":64},"generated":{"line":1,"column":563}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"rows","original":{"line":16,"column":30},"generated":{"line":1,"column":568}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"files","original":{"line":19,"column":8},"generated":{"line":1,"column":573}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":19,"column":25},"generated":{"line":1,"column":576}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"files","original":{"line":19,"column":8},"generated":{"line":1,"column":580}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"length","original":{"line":19,"column":14},"generated":{"line":1,"column":582}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"files","original":{"line":19,"column":8},"generated":{"line":1,"column":589}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"unlink","original":{"line":25,"column":10},"generated":{"line":1,"column":596}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"process","original":{"line":25,"column":17},"generated":{"line":1,"column":598}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"env","original":{"line":25,"column":25},"generated":{"line":1,"column":606}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"UPLOAD_DESTINATION","original":{"line":25,"column":29},"generated":{"line":1,"column":610}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"files","original":{"line":25,"column":50},"generated":{"line":1,"column":629}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":25,"column":56},"generated":{"line":1,"column":631}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"filename","original":{"line":25,"column":59},"generated":{"line":1,"column":634}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"move","original":{"line":26,"column":10},"generated":{"line":1,"column":650}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"process","original":{"line":26,"column":15},"generated":{"line":1,"column":652}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"env","original":{"line":26,"column":23},"generated":{"line":1,"column":660}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"UPLOAD_DESTINATION","original":{"line":26,"column":27},"generated":{"line":1,"column":664}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileName","original":{"line":26,"column":50},"generated":{"line":1,"column":683}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"process","original":{"line":27,"column":15},"generated":{"line":1,"column":685}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"env","original":{"line":27,"column":23},"generated":{"line":1,"column":693}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"UPLOAD_DESTINATION","original":{"line":27,"column":27},"generated":{"line":1,"column":697}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"files","original":{"line":27,"column":50},"generated":{"line":1,"column":716}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":27,"column":56},"generated":{"line":1,"column":718}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"filename","original":{"line":27,"column":59},"generated":{"line":1,"column":721}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"client","original":{"line":29,"column":10},"generated":{"line":1,"column":737}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"query","original":{"line":29,"column":17},"generated":{"line":1,"column":739}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":29,"column":24},"generated":{"line":1,"column":745}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":31,"column":47},"generated":{"line":1,"column":859}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"files","original":{"line":31,"column":48},"generated":{"line":1,"column":860}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":31,"column":54},"generated":{"line":1,"column":862}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"filename","original":{"line":31,"column":57},"generated":{"line":1,"column":865}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":34,"column":9},"generated":{"line":1,"column":876}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":34,"column":9},"generated":{"line":1,"column":880}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"i","original":{"line":34,"column":13},"generated":{"line":1,"column":884}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":34,"column":17},"generated":{"line":1,"column":886}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"i","original":{"line":34,"column":20},"generated":{"line":1,"column":888}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"files","original":{"line":34,"column":24},"generated":{"line":1,"column":890}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"length","original":{"line":34,"column":30},"generated":{"line":1,"column":892}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"i","original":{"line":34,"column":38},"generated":{"line":1,"column":899}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":34,"column":43},"generated":{"line":1,"column":903}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"file","original":{"line":35,"column":14},"generated":{"line":1,"column":904}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"file","original":{"line":35,"column":14},"generated":{"line":1,"column":910}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"files","original":{"line":35,"column":21},"generated":{"line":1,"column":912}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"i","original":{"line":35,"column":27},"generated":{"line":1,"column":914}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"unlink","original":{"line":36,"column":14},"generated":{"line":1,"column":923}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"process","original":{"line":36,"column":21},"generated":{"line":1,"column":925}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"env","original":{"line":36,"column":29},"generated":{"line":1,"column":933}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"UPLOAD_DESTINATION","original":{"line":36,"column":33},"generated":{"line":1,"column":937}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"file","original":{"line":36,"column":55},"generated":{"line":1,"column":956}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"filename","original":{"line":36,"column":60},"generated":{"line":1,"column":958}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":37,"column":14},"generated":{"line":1,"column":974}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"process","original":{"line":37,"column":22},"generated":{"line":1,"column":976}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"process","original":{"line":37,"column":22},"generated":{"line":1,"column":978}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"process","original":{"line":37,"column":22},"generated":{"line":1,"column":987}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"env","original":{"line":37,"column":30},"generated":{"line":1,"column":995}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"UPLOAD_DESTINATION","original":{"line":37,"column":34},"generated":{"line":1,"column":999}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"files","original":{"line":37,"column":55},"generated":{"line":1,"column":1018}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":37,"column":61},"generated":{"line":1,"column":1020}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"filename","original":{"line":37,"column":64},"generated":{"line":1,"column":1023}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"process","original":{"line":38,"column":22},"generated":{"line":1,"column":1032}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"env","original":{"line":38,"column":30},"generated":{"line":1,"column":1040}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"UPLOAD_DESTINATION","original":{"line":38,"column":34},"generated":{"line":1,"column":1044}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"file","original":{"line":38,"column":55},"generated":{"line":1,"column":1063}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"filename","original":{"line":38,"column":60},"generated":{"line":1,"column":1065}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"unlink","original":{"line":20,"column":14},"generated":{"line":1,"column":1087}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"process","original":{"line":20,"column":21},"generated":{"line":1,"column":1089}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"env","original":{"line":20,"column":29},"generated":{"line":1,"column":1097}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"UPLOAD_DESTINATION","original":{"line":20,"column":33},"generated":{"line":1,"column":1101}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileName","original":{"line":20,"column":54},"generated":{"line":1,"column":1120}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":48,"column":6},"generated":{"line":1,"column":1124}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":48,"column":20},"generated":{"line":1,"column":1126}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileNames","original":{"line":48,"column":27},"generated":{"line":1,"column":1132}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"location","original":{"line":48,"column":38},"generated":{"line":1,"column":1134}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":48,"column":49},"generated":{"line":1,"column":1136}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"debug","original":{"line":49,"column":10},"generated":{"line":1,"column":1146}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"debug","original":{"line":49,"column":10},"generated":{"line":1,"column":1152}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":49,"column":18},"generated":{"line":1,"column":1155}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"location","original":{"line":49,"column":26},"generated":{"line":1,"column":1157}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"location","original":{"line":49,"column":26},"generated":{"line":1,"column":1159}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"location","original":{"line":49,"column":26},"generated":{"line":1,"column":1168}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"client","original":{"line":50,"column":10},"generated":{"line":1,"column":1171}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"db","original":{"line":50,"column":25},"generated":{"line":1,"column":1179}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"connect","original":{"line":50,"column":28},"generated":{"line":1,"column":1181}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"connect","original":{"line":50,"column":28},"generated":{"line":1,"column":1189}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":52,"column":9},"generated":{"line":1,"column":1199}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":52,"column":9},"generated":{"line":1,"column":1203}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileName","original":{"line":52,"column":13},"generated":{"line":1,"column":1207}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileNames","original":{"line":52,"column":25},"generated":{"line":1,"column":1212}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":52,"column":36},"generated":{"line":1,"column":1214}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"debug","original":{"line":53,"column":8},"generated":{"line":1,"column":1215}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileName","original":{"line":53,"column":14},"generated":{"line":1,"column":1217}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fullFileName","original":{"line":54,"column":14},"generated":{"line":1,"column":1220}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fullFileName","original":{"line":54,"column":14},"generated":{"line":1,"column":1226}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"process","original":{"line":54,"column":29},"generated":{"line":1,"column":1228}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"env","original":{"line":54,"column":37},"generated":{"line":1,"column":1236}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"UPLOAD_DESTINATION","original":{"line":54,"column":41},"generated":{"line":1,"column":1240}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileName","original":{"line":54,"column":62},"generated":{"line":1,"column":1259}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"getFile","original":{"line":56,"column":14},"generated":{"line":1,"column":1261}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"client","original":{"line":56,"column":30},"generated":{"line":1,"column":1269}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"query","original":{"line":56,"column":37},"generated":{"line":1,"column":1271}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":56,"column":44},"generated":{"line":1,"column":1277}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":58,"column":76},"generated":{"line":1,"column":1443}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileName","original":{"line":58,"column":77},"generated":{"line":1,"column":1444}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"getFile","original":{"line":61,"column":12},"generated":{"line":1,"column":1448}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":61,"column":36},"generated":{"line":1,"column":1451}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"getFile","original":{"line":61,"column":12},"generated":{"line":1,"column":1455}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"rows","original":{"line":61,"column":20},"generated":{"line":1,"column":1457}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"length","original":{"line":61,"column":25},"generated":{"line":1,"column":1462}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":63,"column":19},"generated":{"line":1,"column":1469}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"client","original":{"line":62,"column":18},"generated":{"line":1,"column":1482}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"release","original":{"line":62,"column":25},"generated":{"line":1,"column":1484}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":63,"column":19},"generated":{"line":1,"column":1495}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"file","original":{"line":67,"column":14},"generated":{"line":1,"column":1497}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"file","original":{"line":67,"column":14},"generated":{"line":1,"column":1503}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"getFile","original":{"line":67,"column":24},"generated":{"line":1,"column":1505}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"rows","original":{"line":67,"column":32},"generated":{"line":1,"column":1507}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":67,"column":37},"generated":{"line":1,"column":1512}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fs","original":{"line":72,"column":12},"generated":{"line":1,"column":1515}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"existsSync","original":{"line":72,"column":15},"generated":{"line":1,"column":1517}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"existsSync","original":{"line":72,"column":15},"generated":{"line":1,"column":1525}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fullFileName","original":{"line":72,"column":26},"generated":{"line":1,"column":1536}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":72,"column":56},"generated":{"line":1,"column":1540}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileName","original":{"line":72,"column":43},"generated":{"line":1,"column":1555}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"file","original":{"line":73,"column":16},"generated":{"line":1,"column":1559}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"duplicate","original":{"line":73,"column":21},"generated":{"line":1,"column":1561}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"handleSymlink","original":{"line":75,"column":22},"generated":{"line":1,"column":1577}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"client","original":{"line":75,"column":36},"generated":{"line":1,"column":1579}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fileName","original":{"line":75,"column":44},"generated":{"line":1,"column":1581}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"file","original":{"line":75,"column":54},"generated":{"line":1,"column":1583}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"filesha","original":{"line":75,"column":59},"generated":{"line":1,"column":1585}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"unlink","original":{"line":78,"column":22},"generated":{"line":1,"column":1600}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"fullFileName","original":{"line":78,"column":29},"generated":{"line":1,"column":1602}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":83,"column":11},"generated":{"line":1,"column":1606}},{"source":"Functions/FileDeletion/deleteFiles.js","original":{"line":83,"column":11},"generated":{"line":1,"column":1613}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":1616}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":1620}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":1622}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":1624}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":1632}},{"source":"Functions/FileDeletion/deleteFiles.js","name":"deleteFiles","original":{"line":86,"column":15},"generated":{"line":1,"column":1640}}],"sources":{"Functions/FileDeletion/deleteFiles.js":"import fs            from \"fs\";\r\nimport { promisify } from \"util\";\r\nimport symlink       from \"../Upload/symlink\";\r\nimport db            from \"../../helpers/database\";\r\nimport debugge       from \"debug\";\r\n\r\nrequire('dotenv').config();\r\n\r\nconst unlink = promisify(fs.unlink);\r\nconst move   = promisify(fs.rename);\r\n\r\nconst handleSymlink = async (client, fileName, fileSha) => {\r\n    const getFiles = await client.query(`SELECT filename \r\n                                         FROM \"Uploads\" \r\n                                         WHERE filesha = $1;`, [fileSha]);\r\n    const files    = getFiles.rows;\r\n    \r\n    // The original has been marked for deletion by AV\r\n    if (files.length === 0) {\r\n        await unlink(process.env.UPLOAD_DESTINATION + fileName);\r\n        return;\r\n    }\r\n\r\n    // Move the \"deleted\" file to the first duplicate and set it as not duplicate in db\r\n    await unlink(process.env.UPLOAD_DESTINATION + files[0].filename);\r\n    await move(process.env.UPLOAD_DESTINATION   + fileName, \r\n               process.env.UPLOAD_DESTINATION   + files[0].filename);\r\n\r\n    await client.query(`UPDATE \"Uploads\" \r\n                        SET duplicate = FALSE \r\n                        WHERE filename = $1;`, [files[0].filename]);\r\n    \r\n    // Now change all links to the \"new\" original file\r\n    for (let i = 1; i < files.length; i++) {\r\n        const file = files[i];\r\n        await unlink(process.env.UPLOAD_DESTINATION  + file.filename);\r\n        await symlink(process.env.UPLOAD_DESTINATION + files[0].filename,\r\n                      process.env.UPLOAD_DESTINATION + file.filename);\r\n        \r\n    }\r\n}\r\n\r\n/**\r\n * \r\n * @param {Array} fileNames - List of filenames to delete \r\n * @returns {boolean} gotRemoved - Due to a race condition between the AV scanners this is needed\r\n */\r\nconst deleteFiles = async (fileNames, location = \"null\") => {\r\n    const debug = debugge(location);\r\n    const client = await db.connect();\r\n\r\n    for (let fileName of fileNames) {\r\n        debug(fileName);\r\n        const fullFileName = process.env.UPLOAD_DESTINATION + fileName;\r\n    \r\n        const getFile = await client.query(`DELETE FROM \"Uploads\" \r\n                                            WHERE filename = $1 \r\n                                            RETURNING filesha, duplicate;`, [fileName]);\r\n        \r\n        // If the file has already been deleted\r\n        if (getFile.rows.length === 0) {\r\n            await client.release();\r\n            return false;\r\n        }\r\n        \r\n\r\n        const file    = getFile.rows[0];\r\n                                    \r\n        ////////////////////\r\n        // HANDLE SYMLINK //\r\n        ///////////////////\r\n        if (fs.existsSync(fullFileName) && fileName !== \"robots.txt\") {\r\n            if (file.duplicate) {\r\n                // If this is the original file\r\n                await handleSymlink(client, fileName, file.filesha);\r\n            } else {\r\n                // Just remove it\r\n                await unlink(fullFileName);\r\n            }\r\n        } \r\n    }\r\n\r\n    return true;\r\n};\r\n\r\nexport default deleteFiles;"},"lineCount":null}},"hash":"a0260f6e2497d463761e83ef7738cac3","cacheData":{"env":{}}}