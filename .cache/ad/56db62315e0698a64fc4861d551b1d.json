{"id":"IXYa","dependencies":[{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\.babelrc","includedInParent":true,"mtime":1545517173655},{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\package.json","includedInParent":true,"mtime":1545850952595},{"name":"../../helpers/database","loc":{"line":1,"column":40},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Controllers\\login\\resetPassword.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\helpers\\database.js"}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.get=a,exports.post=n,exports.validate=void 0;var e=r(require(\"../../helpers/database\")),s=require(\"express-validator/check\"),t=r(require(\"bcrypt\"));function r(e){return e&&e.__esModule?e:{default:e}}async function a(s,t){const r=await e.default.connect(),a=await r.query(`SELECT \"userId\", \"UpdatePasswordKeys\".\"token\", username\\n                                            FROM \"UpdatePasswordKeys\", \"Users\"\\n                                            WHERE \"UpdatePasswordKeys\".\"token\" = $1\\n                                            AND registered > NOW() - '${process.env.HOW_OLD_PASSWORD_RESET_TOKENS_CAN_BE}'::INTERVAL\\n                                            AND \"userId\" = id;`,[s.params.token]);await r.release(),t.render(\"change-password\",{user:0===a.rows.length?null:a.rows[0]})}const o=(e,{req:s})=>{if(s.body[\"new-password\"]!==s.body[\"password-check\"])throw new Error(\"Passwords does not match\");return!0};async function n(r,a){const o=(0,s.validationResult)(r);if(!o.isEmpty())return r.session.err=o.array(),a.redirect(\"/login/forgot-password/\"+r.body.token);const n=await e.default.connect(),d=await n.query(`SELECT id, username\\n                                            FROM \"UpdatePasswordKeys\", \"Users\"\\n                                            WHERE \"UpdatePasswordKeys\".\"token\" = $1\\n                                            AND registered > NOW() - '${process.env.HOW_OLD_PASSWORD_RESET_TOKENS_CAN_BE}'::INTERVAL\\n                                            AND \"userId\" = id;`,[r.body.token]);if(0===d.rows.length)return await n.release(),void a.send(\"Congratulations on finding the secret message. You have the honour of telling the developer that a proper error needs to be implemented.\");const i=d.rows[0],w=await t.default.hash(r.body[\"new-password\"],parseInt(process.env.BCRYPT_SALT_ROUNDS));await n.query('UPDATE \"Users\" \\n                        SET password = $1\\n                        WHERE id = $2',[w,i.id]),await n.query('DELETE FROM \"LoginTokens\"        WHERE  userid  = $1;\\n                        DELETE FROM \"UpdatePasswordKeys\" WHERE \"userId\" = $1;',[i.id]),await n.release(),r.flash(\"userAdded\",\"Your password has been updated\"),a.redirect(\"/\")}const d=[(0,s.check)(\"new-password\").exists().withMessage(\"Please select a password\").isLength({min:2,max:72}).withMessage(\"Password needs to be 2 characters long\").custom(o).withMessage(\"The two passwords must be the same\"),(0,s.check)(\"password-check\").exists().withMessage(\"Please select a password\").isLength({min:2,max:72}).withMessage(\"Password needs to be 2 characters long\").custom(o).withMessage(\"The two passwords must be the same\"),(0,s.check)(\"token\").exists().withMessage(\"You need to supply a valid token\")];exports.validate=d;","map":{"mappings":[{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":0}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":13}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":20}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":35}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":43}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":56}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":57}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":64}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":68}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":76}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":80}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":82}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":90}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":95}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":97}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":105}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":119}},{"source":"Controllers/login/resetPassword.js","original":{"line":1,"column":0},"generated":{"line":1,"column":121}},{"source":"Controllers/login/resetPassword.js","original":{"line":1,"column":0},"generated":{"line":1,"column":125}},{"source":"Controllers/login/resetPassword.js","original":{"line":1,"column":0},"generated":{"line":1,"column":127}},{"source":"Controllers/login/resetPassword.js","original":{"line":1,"column":0},"generated":{"line":1,"column":129}},{"source":"Controllers/login/resetPassword.js","original":{"line":1,"column":0},"generated":{"line":1,"column":137}},{"source":"Controllers/login/resetPassword.js","original":{"line":2,"column":0},"generated":{"line":1,"column":164}},{"source":"Controllers/login/resetPassword.js","original":{"line":2,"column":0},"generated":{"line":1,"column":166}},{"source":"Controllers/login/resetPassword.js","original":{"line":2,"column":0},"generated":{"line":1,"column":174}},{"source":"Controllers/login/resetPassword.js","original":{"line":3,"column":0},"generated":{"line":1,"column":201}},{"source":"Controllers/login/resetPassword.js","original":{"line":3,"column":0},"generated":{"line":1,"column":203}},{"source":"Controllers/login/resetPassword.js","original":{"line":3,"column":0},"generated":{"line":1,"column":205}},{"source":"Controllers/login/resetPassword.js","original":{"line":3,"column":0},"generated":{"line":1,"column":213}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":224}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":233}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":235}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":238}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":245}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":248}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":250}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":261}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":263}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":264}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":272}},{"source":"Controllers/login/resetPassword.js","original":{"line":6,"column":0},"generated":{"line":1,"column":275}},{"source":"Controllers/login/resetPassword.js","name":"get","original":{"line":6,"column":15},"generated":{"line":1,"column":290}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":6,"column":19},"generated":{"line":1,"column":292}},{"source":"Controllers/login/resetPassword.js","name":"res","original":{"line":6,"column":24},"generated":{"line":1,"column":294}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":8,"column":10},"generated":{"line":1,"column":297}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":8,"column":10},"generated":{"line":1,"column":303}},{"source":"Controllers/login/resetPassword.js","name":"db","original":{"line":8,"column":30},"generated":{"line":1,"column":311}},{"source":"Controllers/login/resetPassword.js","name":"connect","original":{"line":8,"column":33},"generated":{"line":1,"column":313}},{"source":"Controllers/login/resetPassword.js","name":"connect","original":{"line":8,"column":33},"generated":{"line":1,"column":321}},{"source":"Controllers/login/resetPassword.js","name":"getUserInfo","original":{"line":9,"column":10},"generated":{"line":1,"column":331}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":9,"column":30},"generated":{"line":1,"column":339}},{"source":"Controllers/login/resetPassword.js","name":"query","original":{"line":9,"column":37},"generated":{"line":1,"column":341}},{"source":"Controllers/login/resetPassword.js","name":"process","original":{"line":12,"column":72},"generated":{"line":1,"column":642}},{"source":"Controllers/login/resetPassword.js","name":"env","original":{"line":12,"column":80},"generated":{"line":1,"column":650}},{"source":"Controllers/login/resetPassword.js","name":"HOW_OLD_PASSWORD_RESET_TOKENS_CAN_BE","original":{"line":12,"column":84},"generated":{"line":1,"column":654}},{"source":"Controllers/login/resetPassword.js","original":{"line":14,"column":44},"generated":{"line":1,"column":768}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":14,"column":46},"generated":{"line":1,"column":769}},{"source":"Controllers/login/resetPassword.js","name":"params","original":{"line":14,"column":50},"generated":{"line":1,"column":771}},{"source":"Controllers/login/resetPassword.js","name":"token","original":{"line":14,"column":57},"generated":{"line":1,"column":778}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":16,"column":10},"generated":{"line":1,"column":792}},{"source":"Controllers/login/resetPassword.js","name":"release","original":{"line":16,"column":17},"generated":{"line":1,"column":794}},{"source":"Controllers/login/resetPassword.js","name":"res","original":{"line":17,"column":4},"generated":{"line":1,"column":804}},{"source":"Controllers/login/resetPassword.js","name":"render","original":{"line":17,"column":8},"generated":{"line":1,"column":806}},{"source":"Controllers/login/resetPassword.js","original":{"line":17,"column":15},"generated":{"line":1,"column":813}},{"source":"Controllers/login/resetPassword.js","original":{"line":17,"column":34},"generated":{"line":1,"column":831}},{"source":"Controllers/login/resetPassword.js","name":"user","original":{"line":18,"column":8},"generated":{"line":1,"column":832}},{"source":"Controllers/login/resetPassword.js","original":{"line":18,"column":42},"generated":{"line":1,"column":837}},{"source":"Controllers/login/resetPassword.js","name":"getUserInfo","original":{"line":18,"column":14},"generated":{"line":1,"column":841}},{"source":"Controllers/login/resetPassword.js","name":"rows","original":{"line":18,"column":26},"generated":{"line":1,"column":843}},{"source":"Controllers/login/resetPassword.js","name":"length","original":{"line":18,"column":31},"generated":{"line":1,"column":848}},{"source":"Controllers/login/resetPassword.js","original":{"line":18,"column":46},"generated":{"line":1,"column":855}},{"source":"Controllers/login/resetPassword.js","name":"getUserInfo","original":{"line":19,"column":46},"generated":{"line":1,"column":860}},{"source":"Controllers/login/resetPassword.js","name":"rows","original":{"line":19,"column":58},"generated":{"line":1,"column":862}},{"source":"Controllers/login/resetPassword.js","original":{"line":19,"column":63},"generated":{"line":1,"column":867}},{"source":"Controllers/login/resetPassword.js","original":{"line":23,"column":0},"generated":{"line":1,"column":872}},{"source":"Controllers/login/resetPassword.js","name":"passwordCheck","original":{"line":23,"column":6},"generated":{"line":1,"column":878}},{"source":"Controllers/login/resetPassword.js","original":{"line":23,"column":22},"generated":{"line":1,"column":880}},{"source":"Controllers/login/resetPassword.js","name":"value","original":{"line":23,"column":23},"generated":{"line":1,"column":881}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":23,"column":32},"generated":{"line":1,"column":884}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":23,"column":32},"generated":{"line":1,"column":888}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":24,"column":8},"generated":{"line":1,"column":894}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":24,"column":8},"generated":{"line":1,"column":897}},{"source":"Controllers/login/resetPassword.js","name":"body","original":{"line":24,"column":12},"generated":{"line":1,"column":899}},{"source":"Controllers/login/resetPassword.js","original":{"line":24,"column":17},"generated":{"line":1,"column":904}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":24,"column":37},"generated":{"line":1,"column":922}},{"source":"Controllers/login/resetPassword.js","name":"body","original":{"line":24,"column":41},"generated":{"line":1,"column":924}},{"source":"Controllers/login/resetPassword.js","original":{"line":24,"column":46},"generated":{"line":1,"column":929}},{"source":"Controllers/login/resetPassword.js","original":{"line":25,"column":14},"generated":{"line":1,"column":947}},{"source":"Controllers/login/resetPassword.js","original":{"line":25,"column":14},"generated":{"line":1,"column":953}},{"source":"Controllers/login/resetPassword.js","name":"Error","original":{"line":25,"column":18},"generated":{"line":1,"column":957}},{"source":"Controllers/login/resetPassword.js","original":{"line":25,"column":24},"generated":{"line":1,"column":963}},{"source":"Controllers/login/resetPassword.js","original":{"line":27,"column":15},"generated":{"line":1,"column":991}},{"source":"Controllers/login/resetPassword.js","original":{"line":27,"column":15},"generated":{"line":1,"column":998}},{"source":"Controllers/login/resetPassword.js","original":{"line":32,"column":0},"generated":{"line":1,"column":1001}},{"source":"Controllers/login/resetPassword.js","name":"post","original":{"line":32,"column":15},"generated":{"line":1,"column":1016}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":32,"column":20},"generated":{"line":1,"column":1018}},{"source":"Controllers/login/resetPassword.js","name":"res","original":{"line":32,"column":25},"generated":{"line":1,"column":1020}},{"source":"Controllers/login/resetPassword.js","name":"errors","original":{"line":33,"column":10},"generated":{"line":1,"column":1023}},{"source":"Controllers/login/resetPassword.js","name":"errors","original":{"line":33,"column":10},"generated":{"line":1,"column":1029}},{"source":"Controllers/login/resetPassword.js","original":{"line":33,"column":19},"generated":{"line":1,"column":1032}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":33,"column":36},"generated":{"line":1,"column":1034}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":33,"column":36},"generated":{"line":1,"column":1036}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":33,"column":36},"generated":{"line":1,"column":1054}},{"source":"Controllers/login/resetPassword.js","original":{"line":35,"column":8},"generated":{"line":1,"column":1057}},{"source":"Controllers/login/resetPassword.js","name":"errors","original":{"line":35,"column":9},"generated":{"line":1,"column":1061}},{"source":"Controllers/login/resetPassword.js","name":"isEmpty","original":{"line":35,"column":16},"generated":{"line":1,"column":1063}},{"source":"Controllers/login/resetPassword.js","name":"res","original":{"line":37,"column":15},"generated":{"line":1,"column":1073}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":36,"column":8},"generated":{"line":1,"column":1080}},{"source":"Controllers/login/resetPassword.js","name":"session","original":{"line":36,"column":12},"generated":{"line":1,"column":1082}},{"source":"Controllers/login/resetPassword.js","name":"err","original":{"line":36,"column":20},"generated":{"line":1,"column":1090}},{"source":"Controllers/login/resetPassword.js","name":"errors","original":{"line":36,"column":26},"generated":{"line":1,"column":1094}},{"source":"Controllers/login/resetPassword.js","name":"array","original":{"line":36,"column":33},"generated":{"line":1,"column":1096}},{"source":"Controllers/login/resetPassword.js","name":"res","original":{"line":37,"column":15},"generated":{"line":1,"column":1104}},{"source":"Controllers/login/resetPassword.js","name":"redirect","original":{"line":37,"column":19},"generated":{"line":1,"column":1106}},{"source":"Controllers/login/resetPassword.js","original":{"line":37,"column":28},"generated":{"line":1,"column":1115}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":37,"column":56},"generated":{"line":1,"column":1141}},{"source":"Controllers/login/resetPassword.js","name":"body","original":{"line":37,"column":60},"generated":{"line":1,"column":1143}},{"source":"Controllers/login/resetPassword.js","name":"token","original":{"line":37,"column":65},"generated":{"line":1,"column":1148}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":40,"column":10},"generated":{"line":1,"column":1155}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":40,"column":10},"generated":{"line":1,"column":1161}},{"source":"Controllers/login/resetPassword.js","name":"db","original":{"line":40,"column":30},"generated":{"line":1,"column":1169}},{"source":"Controllers/login/resetPassword.js","name":"connect","original":{"line":40,"column":33},"generated":{"line":1,"column":1171}},{"source":"Controllers/login/resetPassword.js","name":"connect","original":{"line":40,"column":33},"generated":{"line":1,"column":1179}},{"source":"Controllers/login/resetPassword.js","name":"getUserInfo","original":{"line":41,"column":10},"generated":{"line":1,"column":1189}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":41,"column":30},"generated":{"line":1,"column":1197}},{"source":"Controllers/login/resetPassword.js","name":"query","original":{"line":41,"column":37},"generated":{"line":1,"column":1199}},{"source":"Controllers/login/resetPassword.js","name":"process","original":{"line":44,"column":72},"generated":{"line":1,"column":1464}},{"source":"Controllers/login/resetPassword.js","name":"env","original":{"line":44,"column":80},"generated":{"line":1,"column":1472}},{"source":"Controllers/login/resetPassword.js","name":"HOW_OLD_PASSWORD_RESET_TOKENS_CAN_BE","original":{"line":44,"column":84},"generated":{"line":1,"column":1476}},{"source":"Controllers/login/resetPassword.js","original":{"line":46,"column":44},"generated":{"line":1,"column":1590}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":46,"column":46},"generated":{"line":1,"column":1591}},{"source":"Controllers/login/resetPassword.js","name":"body","original":{"line":46,"column":50},"generated":{"line":1,"column":1593}},{"source":"Controllers/login/resetPassword.js","name":"token","original":{"line":46,"column":55},"generated":{"line":1,"column":1598}},{"source":"Controllers/login/resetPassword.js","name":"getUserInfo","original":{"line":49,"column":8},"generated":{"line":1,"column":1606}},{"source":"Controllers/login/resetPassword.js","original":{"line":49,"column":36},"generated":{"line":1,"column":1609}},{"source":"Controllers/login/resetPassword.js","name":"getUserInfo","original":{"line":49,"column":8},"generated":{"line":1,"column":1613}},{"source":"Controllers/login/resetPassword.js","name":"rows","original":{"line":49,"column":20},"generated":{"line":1,"column":1615}},{"source":"Controllers/login/resetPassword.js","name":"length","original":{"line":49,"column":25},"generated":{"line":1,"column":1620}},{"source":"Controllers/login/resetPassword.js","original":{"line":52,"column":8},"generated":{"line":1,"column":1627}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":50,"column":14},"generated":{"line":1,"column":1640}},{"source":"Controllers/login/resetPassword.js","name":"release","original":{"line":50,"column":21},"generated":{"line":1,"column":1642}},{"source":"Controllers/login/resetPassword.js","name":"res","original":{"line":51,"column":8},"generated":{"line":1,"column":1657}},{"source":"Controllers/login/resetPassword.js","name":"send","original":{"line":51,"column":12},"generated":{"line":1,"column":1659}},{"source":"Controllers/login/resetPassword.js","original":{"line":51,"column":17},"generated":{"line":1,"column":1664}},{"source":"Controllers/login/resetPassword.js","name":"user","original":{"line":54,"column":10},"generated":{"line":1,"column":1804}},{"source":"Controllers/login/resetPassword.js","name":"user","original":{"line":54,"column":10},"generated":{"line":1,"column":1810}},{"source":"Controllers/login/resetPassword.js","name":"getUserInfo","original":{"line":54,"column":17},"generated":{"line":1,"column":1812}},{"source":"Controllers/login/resetPassword.js","name":"rows","original":{"line":54,"column":29},"generated":{"line":1,"column":1814}},{"source":"Controllers/login/resetPassword.js","original":{"line":54,"column":34},"generated":{"line":1,"column":1819}},{"source":"Controllers/login/resetPassword.js","name":"newPassword","original":{"line":55,"column":10},"generated":{"line":1,"column":1822}},{"source":"Controllers/login/resetPassword.js","name":"bcrypt","original":{"line":55,"column":30},"generated":{"line":1,"column":1830}},{"source":"Controllers/login/resetPassword.js","name":"hash","original":{"line":55,"column":37},"generated":{"line":1,"column":1832}},{"source":"Controllers/login/resetPassword.js","name":"hash","original":{"line":55,"column":37},"generated":{"line":1,"column":1840}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":55,"column":42},"generated":{"line":1,"column":1845}},{"source":"Controllers/login/resetPassword.js","name":"body","original":{"line":55,"column":46},"generated":{"line":1,"column":1847}},{"source":"Controllers/login/resetPassword.js","original":{"line":55,"column":51},"generated":{"line":1,"column":1852}},{"source":"Controllers/login/resetPassword.js","name":"parseInt","original":{"line":55,"column":68},"generated":{"line":1,"column":1868}},{"source":"Controllers/login/resetPassword.js","name":"process","original":{"line":55,"column":77},"generated":{"line":1,"column":1877}},{"source":"Controllers/login/resetPassword.js","name":"env","original":{"line":55,"column":85},"generated":{"line":1,"column":1885}},{"source":"Controllers/login/resetPassword.js","name":"BCRYPT_SALT_ROUNDS","original":{"line":55,"column":89},"generated":{"line":1,"column":1889}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":57,"column":10},"generated":{"line":1,"column":1916}},{"source":"Controllers/login/resetPassword.js","name":"query","original":{"line":57,"column":17},"generated":{"line":1,"column":1918}},{"source":"Controllers/login/resetPassword.js","original":{"line":57,"column":24},"generated":{"line":1,"column":1924}},{"source":"Controllers/login/resetPassword.js","original":{"line":59,"column":41},"generated":{"line":1,"column":2024}},{"source":"Controllers/login/resetPassword.js","name":"newPassword","original":{"line":59,"column":42},"generated":{"line":1,"column":2025}},{"source":"Controllers/login/resetPassword.js","name":"user","original":{"line":59,"column":55},"generated":{"line":1,"column":2027}},{"source":"Controllers/login/resetPassword.js","name":"id","original":{"line":59,"column":60},"generated":{"line":1,"column":2029}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":61,"column":10},"generated":{"line":1,"column":2040}},{"source":"Controllers/login/resetPassword.js","name":"query","original":{"line":61,"column":17},"generated":{"line":1,"column":2042}},{"source":"Controllers/login/resetPassword.js","original":{"line":61,"column":24},"generated":{"line":1,"column":2048}},{"source":"Controllers/login/resetPassword.js","original":{"line":62,"column":80},"generated":{"line":1,"column":2183}},{"source":"Controllers/login/resetPassword.js","name":"user","original":{"line":62,"column":81},"generated":{"line":1,"column":2184}},{"source":"Controllers/login/resetPassword.js","name":"id","original":{"line":62,"column":86},"generated":{"line":1,"column":2186}},{"source":"Controllers/login/resetPassword.js","name":"client","original":{"line":63,"column":10},"generated":{"line":1,"column":2197}},{"source":"Controllers/login/resetPassword.js","name":"release","original":{"line":63,"column":17},"generated":{"line":1,"column":2199}},{"source":"Controllers/login/resetPassword.js","name":"req","original":{"line":65,"column":4},"generated":{"line":1,"column":2209}},{"source":"Controllers/login/resetPassword.js","name":"flash","original":{"line":65,"column":8},"generated":{"line":1,"column":2211}},{"source":"Controllers/login/resetPassword.js","original":{"line":65,"column":14},"generated":{"line":1,"column":2217}},{"source":"Controllers/login/resetPassword.js","original":{"line":65,"column":27},"generated":{"line":1,"column":2229}},{"source":"Controllers/login/resetPassword.js","name":"res","original":{"line":66,"column":4},"generated":{"line":1,"column":2263}},{"source":"Controllers/login/resetPassword.js","name":"redirect","original":{"line":66,"column":8},"generated":{"line":1,"column":2265}},{"source":"Controllers/login/resetPassword.js","original":{"line":66,"column":17},"generated":{"line":1,"column":2274}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":2279}},{"source":"Controllers/login/resetPassword.js","name":"validate","original":{"line":69,"column":6},"generated":{"line":1,"column":2285}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":17},"generated":{"line":1,"column":2287}},{"source":"Controllers/login/resetPassword.js","original":{"line":70,"column":4},"generated":{"line":1,"column":2289}},{"source":"Controllers/login/resetPassword.js","original":{"line":70,"column":10},"generated":{"line":1,"column":2291}},{"source":"Controllers/login/resetPassword.js","original":{"line":70,"column":10},"generated":{"line":1,"column":2293}},{"source":"Controllers/login/resetPassword.js","original":{"line":70,"column":10},"generated":{"line":1,"column":2300}},{"source":"Controllers/login/resetPassword.js","name":"exists","original":{"line":70,"column":26},"generated":{"line":1,"column":2316}},{"source":"Controllers/login/resetPassword.js","name":"withMessage","original":{"line":70,"column":35},"generated":{"line":1,"column":2325}},{"source":"Controllers/login/resetPassword.js","original":{"line":70,"column":47},"generated":{"line":1,"column":2337}},{"source":"Controllers/login/resetPassword.js","name":"isLength","original":{"line":71,"column":26},"generated":{"line":1,"column":2365}},{"source":"Controllers/login/resetPassword.js","original":{"line":71,"column":35},"generated":{"line":1,"column":2374}},{"source":"Controllers/login/resetPassword.js","name":"min","original":{"line":71,"column":36},"generated":{"line":1,"column":2375}},{"source":"Controllers/login/resetPassword.js","original":{"line":71,"column":41},"generated":{"line":1,"column":2379}},{"source":"Controllers/login/resetPassword.js","name":"max","original":{"line":71,"column":44},"generated":{"line":1,"column":2381}},{"source":"Controllers/login/resetPassword.js","original":{"line":71,"column":49},"generated":{"line":1,"column":2385}},{"source":"Controllers/login/resetPassword.js","name":"withMessage","original":{"line":71,"column":54},"generated":{"line":1,"column":2390}},{"source":"Controllers/login/resetPassword.js","original":{"line":71,"column":66},"generated":{"line":1,"column":2402}},{"source":"Controllers/login/resetPassword.js","name":"custom","original":{"line":72,"column":26},"generated":{"line":1,"column":2444}},{"source":"Controllers/login/resetPassword.js","name":"passwordCheck","original":{"line":72,"column":33},"generated":{"line":1,"column":2451}},{"source":"Controllers/login/resetPassword.js","name":"withMessage","original":{"line":72,"column":48},"generated":{"line":1,"column":2454}},{"source":"Controllers/login/resetPassword.js","original":{"line":72,"column":60},"generated":{"line":1,"column":2466}},{"source":"Controllers/login/resetPassword.js","original":{"line":73,"column":4},"generated":{"line":1,"column":2505}},{"source":"Controllers/login/resetPassword.js","original":{"line":73,"column":10},"generated":{"line":1,"column":2507}},{"source":"Controllers/login/resetPassword.js","original":{"line":73,"column":10},"generated":{"line":1,"column":2509}},{"source":"Controllers/login/resetPassword.js","original":{"line":73,"column":10},"generated":{"line":1,"column":2516}},{"source":"Controllers/login/resetPassword.js","name":"exists","original":{"line":73,"column":28},"generated":{"line":1,"column":2534}},{"source":"Controllers/login/resetPassword.js","name":"withMessage","original":{"line":73,"column":37},"generated":{"line":1,"column":2543}},{"source":"Controllers/login/resetPassword.js","original":{"line":73,"column":49},"generated":{"line":1,"column":2555}},{"source":"Controllers/login/resetPassword.js","name":"isLength","original":{"line":74,"column":28},"generated":{"line":1,"column":2583}},{"source":"Controllers/login/resetPassword.js","original":{"line":74,"column":37},"generated":{"line":1,"column":2592}},{"source":"Controllers/login/resetPassword.js","name":"min","original":{"line":74,"column":38},"generated":{"line":1,"column":2593}},{"source":"Controllers/login/resetPassword.js","original":{"line":74,"column":43},"generated":{"line":1,"column":2597}},{"source":"Controllers/login/resetPassword.js","name":"max","original":{"line":74,"column":46},"generated":{"line":1,"column":2599}},{"source":"Controllers/login/resetPassword.js","original":{"line":74,"column":51},"generated":{"line":1,"column":2603}},{"source":"Controllers/login/resetPassword.js","name":"withMessage","original":{"line":74,"column":56},"generated":{"line":1,"column":2608}},{"source":"Controllers/login/resetPassword.js","original":{"line":74,"column":68},"generated":{"line":1,"column":2620}},{"source":"Controllers/login/resetPassword.js","name":"custom","original":{"line":75,"column":28},"generated":{"line":1,"column":2662}},{"source":"Controllers/login/resetPassword.js","name":"passwordCheck","original":{"line":75,"column":35},"generated":{"line":1,"column":2669}},{"source":"Controllers/login/resetPassword.js","name":"withMessage","original":{"line":75,"column":50},"generated":{"line":1,"column":2672}},{"source":"Controllers/login/resetPassword.js","original":{"line":75,"column":62},"generated":{"line":1,"column":2684}},{"source":"Controllers/login/resetPassword.js","original":{"line":76,"column":4},"generated":{"line":1,"column":2723}},{"source":"Controllers/login/resetPassword.js","original":{"line":76,"column":10},"generated":{"line":1,"column":2725}},{"source":"Controllers/login/resetPassword.js","original":{"line":76,"column":10},"generated":{"line":1,"column":2727}},{"source":"Controllers/login/resetPassword.js","original":{"line":76,"column":10},"generated":{"line":1,"column":2734}},{"source":"Controllers/login/resetPassword.js","name":"exists","original":{"line":76,"column":19},"generated":{"line":1,"column":2743}},{"source":"Controllers/login/resetPassword.js","name":"withMessage","original":{"line":76,"column":28},"generated":{"line":1,"column":2752}},{"source":"Controllers/login/resetPassword.js","original":{"line":76,"column":40},"generated":{"line":1,"column":2764}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":2801}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":2809}},{"source":"Controllers/login/resetPassword.js","original":{"line":69,"column":0},"generated":{"line":1,"column":2818}}],"sources":{"Controllers/login/resetPassword.js":"import db                          from \"../../helpers/database\";\r\nimport { check, validationResult } from \"express-validator/check\"\r\nimport bcrypt                      from \"bcrypt\";\r\n\r\n// /forgot-password/:token\r\nasync function get(req, res) {\r\n    // Get user info\r\n    const client      = await db.connect();\r\n    const getUserInfo = await client.query(`SELECT \"userId\", \"UpdatePasswordKeys\".\"token\", username\r\n                                            FROM \"UpdatePasswordKeys\", \"Users\"\r\n                                            WHERE \"UpdatePasswordKeys\".\"token\" = $1\r\n                                            AND registered > NOW() - '${process.env.HOW_OLD_PASSWORD_RESET_TOKENS_CAN_BE}'::INTERVAL\r\n                                            AND \"userId\" = id;`, \r\n                                            [ req.params.token ]);\r\n    \r\n    await client.release();\r\n    res.render(\"change-password\", {\r\n        user: getUserInfo.rows.length === 0 ? null\r\n                                            : getUserInfo.rows[0]\r\n    });\r\n}\r\n\r\nconst passwordCheck = (value, { req }) => {\r\n    if (req.body[\"new-password\"] !== req.body[\"password-check\"]) {\r\n        throw new Error(\"Passwords does not match\");\r\n    } else {\r\n        return true;\r\n    }\r\n}\r\n\r\n// /reset-password\r\nasync function post(req, res) {\r\n    const errors = validationResult(req);\r\n\r\n    if (!errors.isEmpty()) {\r\n        req.session.err = errors.array();\r\n        return res.redirect(\"/login/forgot-password/\" + req.body.token);\r\n    }\r\n\r\n    const client      = await db.connect();\r\n    const getUserInfo = await client.query(`SELECT id, username\r\n                                            FROM \"UpdatePasswordKeys\", \"Users\"\r\n                                            WHERE \"UpdatePasswordKeys\".\"token\" = $1\r\n                                            AND registered > NOW() - '${process.env.HOW_OLD_PASSWORD_RESET_TOKENS_CAN_BE}'::INTERVAL\r\n                                            AND \"userId\" = id;`, \r\n                                            [ req.body.token ]);\r\n\r\n    // If this is all bullshit\r\n    if (getUserInfo.rows.length === 0) {\r\n        await client.release();\r\n        res.send(\"Congratulations on finding the secret message. You have the honour of telling the developer that a proper error needs to be implemented.\");\r\n        return;\r\n    }\r\n    const user = getUserInfo.rows[0];\r\n    const newPassword = await bcrypt.hash(req.body[\"new-password\"], parseInt(process.env.BCRYPT_SALT_ROUNDS));\r\n\r\n    await client.query(`UPDATE \"Users\" \r\n                        SET password = $1\r\n                        WHERE id = $2`,  [newPassword, user.id]);\r\n    // Clear login tokens\r\n    await client.query(`DELETE FROM \"LoginTokens\"        WHERE  userid  = $1;\r\n                        DELETE FROM \"UpdatePasswordKeys\" WHERE \"userId\" = $1;`, [user.id]);\r\n    await client.release();\r\n\r\n    req.flash(\"userAdded\", \"Your password has been updated\");\r\n    res.redirect(\"/\");\r\n}\r\n\r\nconst validate = [\r\n    check(\"new-password\").exists().withMessage(\"Please select a password\")\r\n                         .isLength({min: 2, max: 72}).withMessage(\"Password needs to be 2 characters long\")\r\n                         .custom(passwordCheck).withMessage(\"The two passwords must be the same\"),\r\n    check(\"password-check\").exists().withMessage(\"Please select a password\")\r\n                           .isLength({min: 2, max: 72}).withMessage(\"Password needs to be 2 characters long\")\r\n                           .custom(passwordCheck).withMessage(\"The two passwords must be the same\"),\r\n    check(\"token\").exists().withMessage(\"You need to supply a valid token\")                              \r\n\r\n]\r\n\r\nexport { get, post, validate }"},"lineCount":null}},"hash":"444e2e534725cc5bc3a0cb23597de007","cacheData":{"env":{}}}