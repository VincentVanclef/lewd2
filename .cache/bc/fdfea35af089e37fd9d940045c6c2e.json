{"id":"WGPF","dependencies":[{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\.babelrc","includedInParent":true,"mtime":1545517173655},{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\package.json","includedInParent":true,"mtime":1545850952595},{"name":"./Functions/Upload/scanAndRemoveFile","loc":{"line":5,"column":37},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\Upload\\scanAndRemoveFile.js"},{"name":"./Functions/FileDeletion/getFilesToDelete","loc":{"line":6,"column":37},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\FileDeletion\\getFilesToDelete.js"},{"name":"./Functions/FileDeletion/deleteFiles","loc":{"line":7,"column":37},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\FileDeletion\\deleteFiles.js"},{"name":"./Functions/SecondaryScan/GetFilesForSecondaryScan","loc":{"line":8,"column":37},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\SecondaryScan\\GetFilesForSecondaryScan.js"},{"name":"./Functions/VirusTotal/getFilesToScan","loc":{"line":9,"column":38},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\VirusTotal\\getFilesToScan.js"},{"name":"./Classes/VirusTotalScanner","loc":{"line":10,"column":37},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\cronactions.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Classes\\VirusTotalScanner.js"}],"generated":{"js":"\"use strict\";var e=require(\"node-cron\"),n=S(require(\"dnode\")),s=S(require(\"async\")),a=S(require(\"debug\")),l=S(require(\"./Functions/Upload/scanAndRemoveFile\")),r=S(require(\"./Functions/FileDeletion/getFilesToDelete\")),t=S(require(\"./Functions/FileDeletion/deleteFiles\")),c=S(require(\"./Functions/SecondaryScan/GetFilesForSecondaryScan\")),i=S(require(\"./Functions/VirusTotal/getFilesToScan\")),o=S(require(\"./Classes/VirusTotalScanner\")),u=S(require(\"dotenv\"));function S(e){return e&&e.__esModule?e:{default:e}}u.default.config();const d=new o.default(process.env.VIRUSTOTAL_KEY,process.env.VIRUSTOTAL_MAX_SCAN_WAIT_MS,process.env.VIRUSTOTAL_MAX_SCANS_PR_MINUTE,process.env.VIRUSTOTAL_MIN_ALLOWED_POSITIVES,process.env.UPLOAD_DESTINATION),f=s.default.queue(async e=>{(0,a.default)(\"sophos-call\")(e),\"production\"===process.env.NODE_ENV&&await(0,l.default)(e.fileName,e.fileSha)},1),_=(0,n.default)({sophosScan:(e,n)=>{f.push({fileName:e,fileSha:n})},virusTotalScan:(e,n,s)=>{d.scan(e,n,s)}});(0,e.schedule)(process.env.FILE_DELETION_CRON,async()=>{const e=await(0,r.default)();if(0===e.length)return;const n=[...new Set(e.map(e=>e.filename))];(0,t.default)(n)}),(0,e.schedule)(process.env.SECONDARY_SCAN_CRON,async()=>{const e=await(0,c.default)();e&&0!==e.length&&((0,a.default)(\"scanner-schedule\")(e),e.forEach(e=>{f.push({fileName:e.fileName,fileSha:e.filesha})}))});let T=0;(0,e.schedule)(process.env.VIRUSTOTAL_SECOND_AND_THIRD_SCAN_CRON,async()=>{const e=await(0,i.default)();T++,e&&0!==e.length&&e.forEach(e=>{d.scan(e.filehash,e.filename,++e.virusTotalScan)})}),_.listen(parseInt(process.env.MESSAGE_SERVER_PORT));","map":{"mappings":[{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":0}},{"source":"cronactions.js","original":{"line":1,"column":0},"generated":{"line":1,"column":13}},{"source":"cronactions.js","original":{"line":1,"column":0},"generated":{"line":1,"column":17}},{"source":"cronactions.js","original":{"line":1,"column":0},"generated":{"line":1,"column":19}},{"source":"cronactions.js","original":{"line":1,"column":0},"generated":{"line":1,"column":27}},{"source":"cronactions.js","original":{"line":2,"column":0},"generated":{"line":1,"column":40}},{"source":"cronactions.js","original":{"line":2,"column":0},"generated":{"line":1,"column":42}},{"source":"cronactions.js","original":{"line":2,"column":0},"generated":{"line":1,"column":44}},{"source":"cronactions.js","original":{"line":2,"column":0},"generated":{"line":1,"column":52}},{"source":"cronactions.js","original":{"line":3,"column":0},"generated":{"line":1,"column":62}},{"source":"cronactions.js","original":{"line":3,"column":0},"generated":{"line":1,"column":64}},{"source":"cronactions.js","original":{"line":3,"column":0},"generated":{"line":1,"column":66}},{"source":"cronactions.js","original":{"line":3,"column":0},"generated":{"line":1,"column":74}},{"source":"cronactions.js","original":{"line":4,"column":0},"generated":{"line":1,"column":84}},{"source":"cronactions.js","original":{"line":4,"column":0},"generated":{"line":1,"column":86}},{"source":"cronactions.js","original":{"line":4,"column":0},"generated":{"line":1,"column":88}},{"source":"cronactions.js","original":{"line":4,"column":0},"generated":{"line":1,"column":96}},{"source":"cronactions.js","original":{"line":5,"column":0},"generated":{"line":1,"column":106}},{"source":"cronactions.js","original":{"line":5,"column":0},"generated":{"line":1,"column":108}},{"source":"cronactions.js","original":{"line":5,"column":0},"generated":{"line":1,"column":110}},{"source":"cronactions.js","original":{"line":5,"column":0},"generated":{"line":1,"column":118}},{"source":"cronactions.js","original":{"line":6,"column":0},"generated":{"line":1,"column":159}},{"source":"cronactions.js","original":{"line":6,"column":0},"generated":{"line":1,"column":161}},{"source":"cronactions.js","original":{"line":6,"column":0},"generated":{"line":1,"column":163}},{"source":"cronactions.js","original":{"line":6,"column":0},"generated":{"line":1,"column":171}},{"source":"cronactions.js","original":{"line":7,"column":0},"generated":{"line":1,"column":217}},{"source":"cronactions.js","original":{"line":7,"column":0},"generated":{"line":1,"column":219}},{"source":"cronactions.js","original":{"line":7,"column":0},"generated":{"line":1,"column":221}},{"source":"cronactions.js","original":{"line":7,"column":0},"generated":{"line":1,"column":229}},{"source":"cronactions.js","original":{"line":8,"column":0},"generated":{"line":1,"column":270}},{"source":"cronactions.js","original":{"line":8,"column":0},"generated":{"line":1,"column":272}},{"source":"cronactions.js","original":{"line":8,"column":0},"generated":{"line":1,"column":274}},{"source":"cronactions.js","original":{"line":8,"column":0},"generated":{"line":1,"column":282}},{"source":"cronactions.js","original":{"line":9,"column":0},"generated":{"line":1,"column":337}},{"source":"cronactions.js","original":{"line":9,"column":0},"generated":{"line":1,"column":339}},{"source":"cronactions.js","original":{"line":9,"column":0},"generated":{"line":1,"column":341}},{"source":"cronactions.js","original":{"line":9,"column":0},"generated":{"line":1,"column":349}},{"source":"cronactions.js","original":{"line":10,"column":0},"generated":{"line":1,"column":391}},{"source":"cronactions.js","original":{"line":10,"column":0},"generated":{"line":1,"column":393}},{"source":"cronactions.js","original":{"line":10,"column":0},"generated":{"line":1,"column":395}},{"source":"cronactions.js","original":{"line":10,"column":0},"generated":{"line":1,"column":403}},{"source":"cronactions.js","original":{"line":12,"column":0},"generated":{"line":1,"column":435}},{"source":"cronactions.js","original":{"line":12,"column":0},"generated":{"line":1,"column":437}},{"source":"cronactions.js","original":{"line":12,"column":0},"generated":{"line":1,"column":439}},{"source":"cronactions.js","original":{"line":12,"column":0},"generated":{"line":1,"column":447}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":458}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":467}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":469}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":472}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":479}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":482}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":484}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":495}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":497}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":498}},{"source":"cronactions.js","original":{"line":110,"column":0},"generated":{"line":1,"column":506}},{"source":"cronactions.js","name":"dotenv","original":{"line":13,"column":0},"generated":{"line":1,"column":509}},{"source":"cronactions.js","name":"config","original":{"line":13,"column":7},"generated":{"line":1,"column":511}},{"source":"cronactions.js","name":"config","original":{"line":13,"column":7},"generated":{"line":1,"column":519}},{"source":"cronactions.js","original":{"line":15,"column":0},"generated":{"line":1,"column":528}},{"source":"cronactions.js","name":"virusTotal","original":{"line":15,"column":6},"generated":{"line":1,"column":534}},{"source":"cronactions.js","original":{"line":15,"column":19},"generated":{"line":1,"column":536}},{"source":"cronactions.js","name":"VirusTotalScanner","original":{"line":15,"column":23},"generated":{"line":1,"column":540}},{"source":"cronactions.js","original":{"line":15,"column":19},"generated":{"line":1,"column":542}},{"source":"cronactions.js","name":"process","original":{"line":15,"column":41},"generated":{"line":1,"column":550}},{"source":"cronactions.js","name":"env","original":{"line":15,"column":49},"generated":{"line":1,"column":558}},{"source":"cronactions.js","name":"VIRUSTOTAL_KEY","original":{"line":15,"column":53},"generated":{"line":1,"column":562}},{"source":"cronactions.js","name":"process","original":{"line":16,"column":41},"generated":{"line":1,"column":577}},{"source":"cronactions.js","name":"env","original":{"line":16,"column":49},"generated":{"line":1,"column":585}},{"source":"cronactions.js","name":"VIRUSTOTAL_MAX_SCAN_WAIT_MS","original":{"line":16,"column":53},"generated":{"line":1,"column":589}},{"source":"cronactions.js","name":"process","original":{"line":17,"column":41},"generated":{"line":1,"column":617}},{"source":"cronactions.js","name":"env","original":{"line":17,"column":49},"generated":{"line":1,"column":625}},{"source":"cronactions.js","name":"VIRUSTOTAL_MAX_SCANS_PR_MINUTE","original":{"line":17,"column":53},"generated":{"line":1,"column":629}},{"source":"cronactions.js","name":"process","original":{"line":18,"column":41},"generated":{"line":1,"column":660}},{"source":"cronactions.js","name":"env","original":{"line":18,"column":49},"generated":{"line":1,"column":668}},{"source":"cronactions.js","name":"VIRUSTOTAL_MIN_ALLOWED_POSITIVES","original":{"line":18,"column":53},"generated":{"line":1,"column":672}},{"source":"cronactions.js","name":"process","original":{"line":19,"column":41},"generated":{"line":1,"column":705}},{"source":"cronactions.js","name":"env","original":{"line":19,"column":49},"generated":{"line":1,"column":713}},{"source":"cronactions.js","name":"UPLOAD_DESTINATION","original":{"line":19,"column":53},"generated":{"line":1,"column":717}},{"source":"cronactions.js","name":"sophosQueue","original":{"line":25,"column":6},"generated":{"line":1,"column":737}},{"source":"cronactions.js","name":"async","original":{"line":25,"column":20},"generated":{"line":1,"column":739}},{"source":"cronactions.js","name":"queue","original":{"line":25,"column":26},"generated":{"line":1,"column":741}},{"source":"cronactions.js","name":"queue","original":{"line":25,"column":26},"generated":{"line":1,"column":749}},{"source":"cronactions.js","original":{"line":25,"column":32},"generated":{"line":1,"column":755}},{"source":"cronactions.js","original":{"line":25,"column":32},"generated":{"line":1,"column":761}},{"source":"cronactions.js","original":{"line":26,"column":12},"generated":{"line":1,"column":766}},{"source":"cronactions.js","original":{"line":26,"column":12},"generated":{"line":1,"column":768}},{"source":"cronactions.js","original":{"line":26,"column":12},"generated":{"line":1,"column":770}},{"source":"cronactions.js","original":{"line":26,"column":12},"generated":{"line":1,"column":779}},{"source":"cronactions.js","original":{"line":26,"column":12},"generated":{"line":1,"column":793}},{"source":"cronactions.js","name":"task","original":{"line":26,"column":27},"generated":{"line":1,"column":794}},{"source":"cronactions.js","original":{"line":29,"column":33},"generated":{"line":1,"column":797}},{"source":"cronactions.js","name":"process","original":{"line":29,"column":8},"generated":{"line":1,"column":812}},{"source":"cronactions.js","name":"env","original":{"line":29,"column":16},"generated":{"line":1,"column":820}},{"source":"cronactions.js","name":"NODE_ENV","original":{"line":29,"column":20},"generated":{"line":1,"column":824}},{"source":"cronactions.js","original":{"line":30,"column":14},"generated":{"line":1,"column":840}},{"source":"cronactions.js","name":"task","original":{"line":30,"column":32},"generated":{"line":1,"column":842}},{"source":"cronactions.js","name":"task","original":{"line":30,"column":32},"generated":{"line":1,"column":844}},{"source":"cronactions.js","name":"task","original":{"line":30,"column":32},"generated":{"line":1,"column":853}},{"source":"cronactions.js","name":"fileName","original":{"line":30,"column":37},"generated":{"line":1,"column":855}},{"source":"cronactions.js","name":"task","original":{"line":30,"column":47},"generated":{"line":1,"column":864}},{"source":"cronactions.js","name":"fileSha","original":{"line":30,"column":52},"generated":{"line":1,"column":866}},{"source":"cronactions.js","original":{"line":31,"column":3},"generated":{"line":1,"column":876}},{"source":"cronactions.js","name":"messageServer","original":{"line":36,"column":6},"generated":{"line":1,"column":879}},{"source":"cronactions.js","original":{"line":36,"column":22},"generated":{"line":1,"column":882}},{"source":"cronactions.js","original":{"line":36,"column":28},"generated":{"line":1,"column":884}},{"source":"cronactions.js","original":{"line":36,"column":28},"generated":{"line":1,"column":886}},{"source":"cronactions.js","original":{"line":36,"column":28},"generated":{"line":1,"column":895}},{"source":"cronactions.js","name":"sophosScan","original":{"line":37,"column":4},"generated":{"line":1,"column":896}},{"source":"cronactions.js","original":{"line":37,"column":16},"generated":{"line":1,"column":907}},{"source":"cronactions.js","name":"fileName","original":{"line":37,"column":17},"generated":{"line":1,"column":908}},{"source":"cronactions.js","name":"fileSha","original":{"line":37,"column":27},"generated":{"line":1,"column":910}},{"source":"cronactions.js","name":"sophosQueue","original":{"line":38,"column":8},"generated":{"line":1,"column":915}},{"source":"cronactions.js","name":"push","original":{"line":38,"column":20},"generated":{"line":1,"column":917}},{"source":"cronactions.js","original":{"line":38,"column":25},"generated":{"line":1,"column":922}},{"source":"cronactions.js","name":"fileName","original":{"line":39,"column":12},"generated":{"line":1,"column":923}},{"source":"cronactions.js","name":"fileName","original":{"line":39,"column":22},"generated":{"line":1,"column":932}},{"source":"cronactions.js","name":"fileSha","original":{"line":40,"column":12},"generated":{"line":1,"column":934}},{"source":"cronactions.js","name":"fileSha","original":{"line":40,"column":21},"generated":{"line":1,"column":942}},{"source":"cronactions.js","name":"virusTotalScan","original":{"line":43,"column":4},"generated":{"line":1,"column":947}},{"source":"cronactions.js","original":{"line":43,"column":20},"generated":{"line":1,"column":962}},{"source":"cronactions.js","name":"fileHash","original":{"line":43,"column":21},"generated":{"line":1,"column":963}},{"source":"cronactions.js","name":"fileName","original":{"line":43,"column":31},"generated":{"line":1,"column":965}},{"source":"cronactions.js","name":"scanNumber","original":{"line":43,"column":41},"generated":{"line":1,"column":967}},{"source":"cronactions.js","name":"virusTotal","original":{"line":44,"column":8},"generated":{"line":1,"column":972}},{"source":"cronactions.js","name":"scan","original":{"line":44,"column":19},"generated":{"line":1,"column":974}},{"source":"cronactions.js","name":"fileHash","original":{"line":44,"column":24},"generated":{"line":1,"column":979}},{"source":"cronactions.js","name":"fileName","original":{"line":44,"column":34},"generated":{"line":1,"column":981}},{"source":"cronactions.js","name":"scanNumber","original":{"line":44,"column":44},"generated":{"line":1,"column":983}},{"source":"cronactions.js","original":{"line":53,"column":0},"generated":{"line":1,"column":990}},{"source":"cronactions.js","name":"process","original":{"line":53,"column":9},"generated":{"line":1,"column":992}},{"source":"cronactions.js","name":"process","original":{"line":53,"column":9},"generated":{"line":1,"column":994}},{"source":"cronactions.js","name":"process","original":{"line":53,"column":9},"generated":{"line":1,"column":1004}},{"source":"cronactions.js","name":"env","original":{"line":53,"column":17},"generated":{"line":1,"column":1012}},{"source":"cronactions.js","name":"FILE_DELETION_CRON","original":{"line":53,"column":21},"generated":{"line":1,"column":1016}},{"source":"cronactions.js","original":{"line":53,"column":41},"generated":{"line":1,"column":1035}},{"source":"cronactions.js","name":"files","original":{"line":54,"column":10},"generated":{"line":1,"column":1045}},{"source":"cronactions.js","name":"files","original":{"line":54,"column":10},"generated":{"line":1,"column":1051}},{"source":"cronactions.js","original":{"line":54,"column":24},"generated":{"line":1,"column":1059}},{"source":"cronactions.js","original":{"line":54,"column":4},"generated":{"line":1,"column":1061}},{"source":"cronactions.js","original":{"line":54,"column":4},"generated":{"line":1,"column":1063}},{"source":"cronactions.js","name":"files","original":{"line":57,"column":8},"generated":{"line":1,"column":1074}},{"source":"cronactions.js","original":{"line":57,"column":25},"generated":{"line":1,"column":1077}},{"source":"cronactions.js","name":"files","original":{"line":57,"column":8},"generated":{"line":1,"column":1081}},{"source":"cronactions.js","name":"length","original":{"line":57,"column":14},"generated":{"line":1,"column":1083}},{"source":"cronactions.js","original":{"line":58,"column":8},"generated":{"line":1,"column":1090}},{"source":"cronactions.js","name":"unique","original":{"line":61,"column":10},"generated":{"line":1,"column":1097}},{"source":"cronactions.js","name":"unique","original":{"line":61,"column":10},"generated":{"line":1,"column":1103}},{"source":"cronactions.js","original":{"line":61,"column":19},"generated":{"line":1,"column":1105}},{"source":"cronactions.js","original":{"line":61,"column":23},"generated":{"line":1,"column":1109}},{"source":"cronactions.js","name":"Set","original":{"line":61,"column":27},"generated":{"line":1,"column":1113}},{"source":"cronactions.js","name":"files","original":{"line":61,"column":31},"generated":{"line":1,"column":1117}},{"source":"cronactions.js","name":"map","original":{"line":61,"column":37},"generated":{"line":1,"column":1119}},{"source":"cronactions.js","name":"file","original":{"line":61,"column":41},"generated":{"line":1,"column":1123}},{"source":"cronactions.js","name":"file","original":{"line":61,"column":49},"generated":{"line":1,"column":1126}},{"source":"cronactions.js","name":"filename","original":{"line":61,"column":54},"generated":{"line":1,"column":1128}},{"source":"cronactions.js","name":"unique","original":{"line":63,"column":16},"generated":{"line":1,"column":1141}},{"source":"cronactions.js","name":"unique","original":{"line":63,"column":16},"generated":{"line":1,"column":1143}},{"source":"cronactions.js","name":"unique","original":{"line":63,"column":16},"generated":{"line":1,"column":1145}},{"source":"cronactions.js","name":"unique","original":{"line":63,"column":16},"generated":{"line":1,"column":1154}},{"source":"cronactions.js","original":{"line":69,"column":0},"generated":{"line":1,"column":1160}},{"source":"cronactions.js","name":"process","original":{"line":69,"column":9},"generated":{"line":1,"column":1162}},{"source":"cronactions.js","name":"process","original":{"line":69,"column":9},"generated":{"line":1,"column":1164}},{"source":"cronactions.js","name":"process","original":{"line":69,"column":9},"generated":{"line":1,"column":1174}},{"source":"cronactions.js","name":"env","original":{"line":69,"column":17},"generated":{"line":1,"column":1182}},{"source":"cronactions.js","name":"SECONDARY_SCAN_CRON","original":{"line":69,"column":21},"generated":{"line":1,"column":1186}},{"source":"cronactions.js","original":{"line":69,"column":42},"generated":{"line":1,"column":1206}},{"source":"cronactions.js","name":"files","original":{"line":70,"column":10},"generated":{"line":1,"column":1216}},{"source":"cronactions.js","name":"files","original":{"line":70,"column":10},"generated":{"line":1,"column":1222}},{"source":"cronactions.js","original":{"line":70,"column":24},"generated":{"line":1,"column":1230}},{"source":"cronactions.js","original":{"line":70,"column":4},"generated":{"line":1,"column":1232}},{"source":"cronactions.js","original":{"line":70,"column":4},"generated":{"line":1,"column":1234}},{"source":"cronactions.js","name":"files","original":{"line":72,"column":9},"generated":{"line":1,"column":1245}},{"source":"cronactions.js","original":{"line":76,"column":25},"generated":{"line":1,"column":1248}},{"source":"cronactions.js","name":"files","original":{"line":76,"column":8},"generated":{"line":1,"column":1252}},{"source":"cronactions.js","name":"length","original":{"line":76,"column":14},"generated":{"line":1,"column":1254}},{"source":"cronactions.js","original":{"line":80,"column":12},"generated":{"line":1,"column":1264}},{"source":"cronactions.js","original":{"line":80,"column":12},"generated":{"line":1,"column":1266}},{"source":"cronactions.js","original":{"line":80,"column":12},"generated":{"line":1,"column":1268}},{"source":"cronactions.js","original":{"line":80,"column":12},"generated":{"line":1,"column":1277}},{"source":"cronactions.js","original":{"line":80,"column":12},"generated":{"line":1,"column":1296}},{"source":"cronactions.js","name":"files","original":{"line":80,"column":32},"generated":{"line":1,"column":1297}},{"source":"cronactions.js","name":"files","original":{"line":82,"column":4},"generated":{"line":1,"column":1300}},{"source":"cronactions.js","name":"forEach","original":{"line":82,"column":10},"generated":{"line":1,"column":1302}},{"source":"cronactions.js","name":"file","original":{"line":82,"column":18},"generated":{"line":1,"column":1310}},{"source":"cronactions.js","name":"sophosQueue","original":{"line":83,"column":8},"generated":{"line":1,"column":1314}},{"source":"cronactions.js","name":"push","original":{"line":83,"column":20},"generated":{"line":1,"column":1316}},{"source":"cronactions.js","original":{"line":83,"column":25},"generated":{"line":1,"column":1321}},{"source":"cronactions.js","name":"fileName","original":{"line":84,"column":12},"generated":{"line":1,"column":1322}},{"source":"cronactions.js","name":"file","original":{"line":84,"column":22},"generated":{"line":1,"column":1331}},{"source":"cronactions.js","name":"fileName","original":{"line":84,"column":27},"generated":{"line":1,"column":1333}},{"source":"cronactions.js","name":"fileSha","original":{"line":85,"column":12},"generated":{"line":1,"column":1342}},{"source":"cronactions.js","name":"file","original":{"line":85,"column":21},"generated":{"line":1,"column":1350}},{"source":"cronactions.js","name":"filesha","original":{"line":85,"column":26},"generated":{"line":1,"column":1352}},{"source":"cronactions.js","original":{"line":91,"column":0},"generated":{"line":1,"column":1367}},{"source":"cronactions.js","name":"num","original":{"line":91,"column":4},"generated":{"line":1,"column":1371}},{"source":"cronactions.js","original":{"line":91,"column":10},"generated":{"line":1,"column":1373}},{"source":"cronactions.js","original":{"line":92,"column":0},"generated":{"line":1,"column":1376}},{"source":"cronactions.js","name":"process","original":{"line":92,"column":9},"generated":{"line":1,"column":1378}},{"source":"cronactions.js","name":"process","original":{"line":92,"column":9},"generated":{"line":1,"column":1380}},{"source":"cronactions.js","name":"process","original":{"line":92,"column":9},"generated":{"line":1,"column":1390}},{"source":"cronactions.js","name":"env","original":{"line":92,"column":17},"generated":{"line":1,"column":1398}},{"source":"cronactions.js","name":"VIRUSTOTAL_SECOND_AND_THIRD_SCAN_CRON","original":{"line":92,"column":21},"generated":{"line":1,"column":1402}},{"source":"cronactions.js","original":{"line":92,"column":60},"generated":{"line":1,"column":1440}},{"source":"cronactions.js","name":"files","original":{"line":93,"column":10},"generated":{"line":1,"column":1450}},{"source":"cronactions.js","name":"files","original":{"line":93,"column":10},"generated":{"line":1,"column":1456}},{"source":"cronactions.js","original":{"line":93,"column":24},"generated":{"line":1,"column":1464}},{"source":"cronactions.js","original":{"line":93,"column":4},"generated":{"line":1,"column":1466}},{"source":"cronactions.js","original":{"line":93,"column":4},"generated":{"line":1,"column":1468}},{"source":"cronactions.js","name":"num","original":{"line":95,"column":4},"generated":{"line":1,"column":1479}},{"source":"cronactions.js","name":"files","original":{"line":97,"column":9},"generated":{"line":1,"column":1483}},{"source":"cronactions.js","original":{"line":101,"column":25},"generated":{"line":1,"column":1486}},{"source":"cronactions.js","name":"files","original":{"line":101,"column":8},"generated":{"line":1,"column":1490}},{"source":"cronactions.js","name":"length","original":{"line":101,"column":14},"generated":{"line":1,"column":1492}},{"source":"cronactions.js","name":"files","original":{"line":105,"column":4},"generated":{"line":1,"column":1500}},{"source":"cronactions.js","name":"forEach","original":{"line":105,"column":10},"generated":{"line":1,"column":1502}},{"source":"cronactions.js","name":"file","original":{"line":105,"column":18},"generated":{"line":1,"column":1510}},{"source":"cronactions.js","name":"virusTotal","original":{"line":106,"column":8},"generated":{"line":1,"column":1514}},{"source":"cronactions.js","name":"scan","original":{"line":106,"column":19},"generated":{"line":1,"column":1516}},{"source":"cronactions.js","name":"file","original":{"line":106,"column":24},"generated":{"line":1,"column":1521}},{"source":"cronactions.js","name":"filehash","original":{"line":106,"column":29},"generated":{"line":1,"column":1523}},{"source":"cronactions.js","name":"file","original":{"line":106,"column":39},"generated":{"line":1,"column":1532}},{"source":"cronactions.js","name":"filename","original":{"line":106,"column":44},"generated":{"line":1,"column":1534}},{"source":"cronactions.js","name":"file","original":{"line":106,"column":56},"generated":{"line":1,"column":1545}},{"source":"cronactions.js","name":"virusTotalScan","original":{"line":106,"column":61},"generated":{"line":1,"column":1547}},{"source":"cronactions.js","name":"messageServer","original":{"line":110,"column":0},"generated":{"line":1,"column":1567}},{"source":"cronactions.js","name":"listen","original":{"line":110,"column":14},"generated":{"line":1,"column":1569}},{"source":"cronactions.js","name":"parseInt","original":{"line":110,"column":21},"generated":{"line":1,"column":1576}},{"source":"cronactions.js","name":"process","original":{"line":110,"column":30},"generated":{"line":1,"column":1585}},{"source":"cronactions.js","name":"env","original":{"line":110,"column":38},"generated":{"line":1,"column":1593}},{"source":"cronactions.js","name":"MESSAGE_SERVER_PORT","original":{"line":110,"column":42},"generated":{"line":1,"column":1597}}],"sources":{"cronactions.js":"import { schedule }             from 'node-cron';\r\nimport dnode                    from \"dnode\";\r\nimport async                    from \"async\"; \r\nimport debugge                  from \"debug\";\r\nimport scanAndRemoveFile        from \"./Functions/Upload/scanAndRemoveFile\";\r\nimport getFilesToDelete         from \"./Functions/FileDeletion/getFilesToDelete\";\r\nimport deleteFiles              from \"./Functions/FileDeletion/deleteFiles\";\r\nimport getFilesForSecondaryScan from \"./Functions/SecondaryScan/GetFilesForSecondaryScan\";\r\nimport getFilesToScan            from \"./Functions/VirusTotal/getFilesToScan\";\r\nimport VirusTotalScanner        from \"./Classes/VirusTotalScanner\";\r\n\r\nimport dotenv from \"dotenv\";\r\ndotenv.config();\r\n\r\nconst virusTotal = new VirusTotalScanner(process.env.VIRUSTOTAL_KEY,\r\n                                         process.env.VIRUSTOTAL_MAX_SCAN_WAIT_MS,\r\n                                         process.env.VIRUSTOTAL_MAX_SCANS_PR_MINUTE,\r\n                                         process.env.VIRUSTOTAL_MIN_ALLOWED_POSITIVES,\r\n                                         process.env.UPLOAD_DESTINATION)\r\n\r\n\r\n/**\r\n * Limits the AV scans\r\n */\r\nconst sophosQueue = async.queue(async (task) => {\r\n    debugge(\"sophos-call\")(task);\r\n    \r\n    // This is a hack that makes it possible to develop without having Sophos installed. Don't tell anyone :v\r\n    if (process.env.NODE_ENV === \"production\")\r\n        await scanAndRemoveFile(task.fileName, task.fileSha);\r\n}, 1);\r\n\r\n/**\r\n * Functions the app can call\r\n */\r\nconst messageServer = dnode({\r\n    sophosScan: (fileName, fileSha) => {\r\n        sophosQueue.push({\r\n            fileName: fileName,\r\n            fileSha: fileSha\r\n        });\r\n    },\r\n    virusTotalScan: (fileHash, fileName, scanNumber) => {\r\n        virusTotal.scan(fileHash, fileName, scanNumber);\r\n    }\r\n});\r\n\r\n\r\n\r\n/**\r\n * Remove files that are too old\r\n */\r\nschedule(process.env.FILE_DELETION_CRON, async () => {\r\n    const files = await getFilesToDelete();\r\n    \r\n    // Prevent additional files from being scanned\r\n    if (files.length === 0)\r\n        return;\r\n\r\n    // Removes duplicates\r\n    const unique = [...new Set(files.map(file => file.filename))];\r\n\r\n    deleteFiles(unique);\r\n});\r\n\r\n/**\r\n * Secondary AV scan of uploaded files\r\n */\r\nschedule(process.env.SECONDARY_SCAN_CRON, async () => {\r\n    const files = await getFilesForSecondaryScan();\r\n\r\n    if (!files) {\r\n        return;\r\n    }\r\n\r\n    if (files.length === 0) {\r\n        return;\r\n    }\r\n\r\n    debugge(\"scanner-schedule\")(files);\r\n \r\n    files.forEach(file => {\r\n        sophosQueue.push({\r\n            fileName: file.fileName,\r\n            fileSha: file.filesha\r\n        });\r\n    })\r\n});\r\n\r\n\r\nlet num = 0;\r\nschedule(process.env.VIRUSTOTAL_SECOND_AND_THIRD_SCAN_CRON, async () => {\r\n    const files = await getFilesToScan();\r\n\r\n    num++;\r\n\r\n    if (!files) {\r\n        return;\r\n    }\r\n\r\n    if (files.length === 0) {\r\n        return;\r\n    }\r\n    \r\n    files.forEach(file => {\r\n        virusTotal.scan(file.filehash, file.filename, ++file.virusTotalScan);\r\n    });    \r\n})\r\n \r\nmessageServer.listen(parseInt(process.env.MESSAGE_SERVER_PORT));"},"lineCount":null}},"hash":"a008b75f48829de9fd047d1461407a80","cacheData":{"env":{}}}