{"id":"qJzc","dependencies":[{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\.babelrc","includedInParent":true,"mtime":1545517173655},{"name":"C:\\Users\\inaba\\Programming\\Lewd2\\package.json","includedInParent":true,"mtime":1545850952595},{"name":"../Functions/sleep","loc":{"line":6,"column":26},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Classes\\VirusTotalScanner.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\sleep.js"},{"name":"../helpers/database","loc":{"line":7,"column":26},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Classes\\VirusTotalScanner.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\helpers\\database.js"},{"name":"../Functions/FileDeletion/deleteFiles","loc":{"line":8,"column":26},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Classes\\VirusTotalScanner.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\FileDeletion\\deleteFiles.js"},{"name":"../Functions/Transparency/logToTransparency","loc":{"line":9,"column":30},"parent":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Classes\\VirusTotalScanner.js","resolved":"C:\\Users\\inaba\\Programming\\Lewd2\\src\\Functions\\Transparency\\logToTransparency.js"}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.default=void 0;var e=l(require(\"https\")),t=l(require(\"querystring\")),a=l(require(\"async\")),i=require(\"util\"),s=l(require(\"fs\")),n=l(require(\"../Functions/sleep\")),r=l(require(\"../helpers/database\")),u=l(require(\"../Functions/FileDeletion/deleteFiles\")),o=l(require(\"../Functions/Transparency/logToTransparency\"));function l(e){return e&&e.__esModule?e:{default:e}}const c=(0,i.promisify)(s.default.unlink);class p{constructor(e,t,i,s,r){this.APIKey=e,this.uploadDir=r,this.waitTime=parseInt(t),this.scansPrMinute=parseInt(i),this.maximumPositives=parseInt(s),this.amountOfScans=0,this.options={hostname:\"virustotal.com\",port:\"443\",path:\"/vtapi/v2/file/report\",method:\"POST\",headers:{\"Accept-Encoding\":\"gzip deflate\",\"User-Agent\":\"gzip \"+process.env.VIRUSTOTAL_USER}},this.queue=a.default.queue(async e=>{this.amountOfScans==this.scansPrMinute&&(await(0,n.default)(this.waitTime),this.amountOfScans=0),this.amountOfScans++,await this._onScan(e)},1)}_getFileReport(a){return new Promise((i,s)=>{const n=t.default.stringify({resource:a,apikey:this.APIKey}),r=e.default.request(this.options,e=>{let t=\"\";e.on(\"data\",e=>{t+=e}),e.on(\"end\",()=>{const e=0===t.length?null:JSON.parse(t);i(e)}),e.on(\"error\",e=>{s(e)})});r.on(\"error\",e=>{s(e)}),r.write(n),r.end()})}async _onScan(e){const t=await this._getFileReport(e.fileHash);null!==t?t.positives<parseInt(this.maximumPositives)||0===t.response_code||0===t.length?await this._updateFileVirustotalScanCountInDb(e.fileName,e.scanNumber):await(0,u.default)([e.fileName],\"VirusTotal\")&&await(0,o.default)(e.fileName,e.fileHash,t.permalink,\"Virustotal\"):await this._updateFileVirustotalScanCountInDb(e.fileName,e.scanNumber)}async _updateFileVirustotalScanCountInDb(e,t){const a=await r.default.connect();await a.query('UPDATE \"Uploads\" SET \"virustotalScan\" = $1 WHERE filename = $2;',[t,e]),await a.release()}scan(e,t,a){this.queue.push({fileHash:e,fileName:t,scanNumber:a})}}var h=p;exports.default=h;","map":{"mappings":[{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":0}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":13}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":20}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":35}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":43}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":56}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":57}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":64}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":68}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":76}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":89}},{"source":"Classes/VirusTotalScanner.js","original":{"line":1,"column":0},"generated":{"line":1,"column":91}},{"source":"Classes/VirusTotalScanner.js","original":{"line":1,"column":0},"generated":{"line":1,"column":95}},{"source":"Classes/VirusTotalScanner.js","original":{"line":1,"column":0},"generated":{"line":1,"column":97}},{"source":"Classes/VirusTotalScanner.js","original":{"line":1,"column":0},"generated":{"line":1,"column":99}},{"source":"Classes/VirusTotalScanner.js","original":{"line":1,"column":0},"generated":{"line":1,"column":107}},{"source":"Classes/VirusTotalScanner.js","original":{"line":2,"column":0},"generated":{"line":1,"column":117}},{"source":"Classes/VirusTotalScanner.js","original":{"line":2,"column":0},"generated":{"line":1,"column":119}},{"source":"Classes/VirusTotalScanner.js","original":{"line":2,"column":0},"generated":{"line":1,"column":121}},{"source":"Classes/VirusTotalScanner.js","original":{"line":2,"column":0},"generated":{"line":1,"column":129}},{"source":"Classes/VirusTotalScanner.js","original":{"line":3,"column":0},"generated":{"line":1,"column":145}},{"source":"Classes/VirusTotalScanner.js","original":{"line":3,"column":0},"generated":{"line":1,"column":147}},{"source":"Classes/VirusTotalScanner.js","original":{"line":3,"column":0},"generated":{"line":1,"column":149}},{"source":"Classes/VirusTotalScanner.js","original":{"line":3,"column":0},"generated":{"line":1,"column":157}},{"source":"Classes/VirusTotalScanner.js","original":{"line":4,"column":0},"generated":{"line":1,"column":167}},{"source":"Classes/VirusTotalScanner.js","original":{"line":4,"column":0},"generated":{"line":1,"column":169}},{"source":"Classes/VirusTotalScanner.js","original":{"line":4,"column":0},"generated":{"line":1,"column":177}},{"source":"Classes/VirusTotalScanner.js","original":{"line":5,"column":0},"generated":{"line":1,"column":185}},{"source":"Classes/VirusTotalScanner.js","original":{"line":5,"column":0},"generated":{"line":1,"column":187}},{"source":"Classes/VirusTotalScanner.js","original":{"line":5,"column":0},"generated":{"line":1,"column":189}},{"source":"Classes/VirusTotalScanner.js","original":{"line":5,"column":0},"generated":{"line":1,"column":197}},{"source":"Classes/VirusTotalScanner.js","original":{"line":6,"column":0},"generated":{"line":1,"column":204}},{"source":"Classes/VirusTotalScanner.js","original":{"line":6,"column":0},"generated":{"line":1,"column":206}},{"source":"Classes/VirusTotalScanner.js","original":{"line":6,"column":0},"generated":{"line":1,"column":208}},{"source":"Classes/VirusTotalScanner.js","original":{"line":6,"column":0},"generated":{"line":1,"column":216}},{"source":"Classes/VirusTotalScanner.js","original":{"line":7,"column":0},"generated":{"line":1,"column":239}},{"source":"Classes/VirusTotalScanner.js","original":{"line":7,"column":0},"generated":{"line":1,"column":241}},{"source":"Classes/VirusTotalScanner.js","original":{"line":7,"column":0},"generated":{"line":1,"column":243}},{"source":"Classes/VirusTotalScanner.js","original":{"line":7,"column":0},"generated":{"line":1,"column":251}},{"source":"Classes/VirusTotalScanner.js","original":{"line":8,"column":0},"generated":{"line":1,"column":275}},{"source":"Classes/VirusTotalScanner.js","original":{"line":8,"column":0},"generated":{"line":1,"column":277}},{"source":"Classes/VirusTotalScanner.js","original":{"line":8,"column":0},"generated":{"line":1,"column":279}},{"source":"Classes/VirusTotalScanner.js","original":{"line":8,"column":0},"generated":{"line":1,"column":287}},{"source":"Classes/VirusTotalScanner.js","original":{"line":9,"column":0},"generated":{"line":1,"column":329}},{"source":"Classes/VirusTotalScanner.js","original":{"line":9,"column":0},"generated":{"line":1,"column":331}},{"source":"Classes/VirusTotalScanner.js","original":{"line":9,"column":0},"generated":{"line":1,"column":333}},{"source":"Classes/VirusTotalScanner.js","original":{"line":9,"column":0},"generated":{"line":1,"column":341}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":389}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":398}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":400}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":403}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":410}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":413}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":415}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":426}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":428}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":429}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":437}},{"source":"Classes/VirusTotalScanner.js","original":{"line":11,"column":0},"generated":{"line":1,"column":440}},{"source":"Classes/VirusTotalScanner.js","name":"unlink","original":{"line":11,"column":6},"generated":{"line":1,"column":446}},{"source":"Classes/VirusTotalScanner.js","original":{"line":11,"column":17},"generated":{"line":1,"column":449}},{"source":"Classes/VirusTotalScanner.js","name":"fs","original":{"line":11,"column":27},"generated":{"line":1,"column":451}},{"source":"Classes/VirusTotalScanner.js","name":"fs","original":{"line":11,"column":27},"generated":{"line":1,"column":453}},{"source":"Classes/VirusTotalScanner.js","name":"fs","original":{"line":11,"column":27},"generated":{"line":1,"column":464}},{"source":"Classes/VirusTotalScanner.js","name":"unlink","original":{"line":11,"column":30},"generated":{"line":1,"column":466}},{"source":"Classes/VirusTotalScanner.js","name":"unlink","original":{"line":11,"column":30},"generated":{"line":1,"column":474}},{"source":"Classes/VirusTotalScanner.js","original":{"line":13,"column":0},"generated":{"line":1,"column":482}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":13,"column":6},"generated":{"line":1,"column":488}},{"source":"Classes/VirusTotalScanner.js","name":"constructor","original":{"line":22,"column":4},"generated":{"line":1,"column":490}},{"source":"Classes/VirusTotalScanner.js","name":"APIKey","original":{"line":22,"column":16},"generated":{"line":1,"column":502}},{"source":"Classes/VirusTotalScanner.js","name":"waitTime","original":{"line":22,"column":24},"generated":{"line":1,"column":504}},{"source":"Classes/VirusTotalScanner.js","name":"scansPrMinute","original":{"line":22,"column":34},"generated":{"line":1,"column":506}},{"source":"Classes/VirusTotalScanner.js","name":"maximumPositives","original":{"line":22,"column":49},"generated":{"line":1,"column":508}},{"source":"Classes/VirusTotalScanner.js","name":"uploadDir","original":{"line":22,"column":67},"generated":{"line":1,"column":510}},{"source":"Classes/VirusTotalScanner.js","name":"APIKey","original":{"line":23,"column":13},"generated":{"line":1,"column":513}},{"source":"Classes/VirusTotalScanner.js","name":"APIKey","original":{"line":23,"column":13},"generated":{"line":1,"column":518}},{"source":"Classes/VirusTotalScanner.js","name":"APIKey","original":{"line":23,"column":32},"generated":{"line":1,"column":525}},{"source":"Classes/VirusTotalScanner.js","name":"uploadDir","original":{"line":24,"column":13},"generated":{"line":1,"column":527}},{"source":"Classes/VirusTotalScanner.js","name":"uploadDir","original":{"line":24,"column":13},"generated":{"line":1,"column":532}},{"source":"Classes/VirusTotalScanner.js","name":"uploadDir","original":{"line":24,"column":32},"generated":{"line":1,"column":542}},{"source":"Classes/VirusTotalScanner.js","name":"waitTime","original":{"line":25,"column":13},"generated":{"line":1,"column":544}},{"source":"Classes/VirusTotalScanner.js","name":"waitTime","original":{"line":25,"column":13},"generated":{"line":1,"column":549}},{"source":"Classes/VirusTotalScanner.js","name":"parseInt","original":{"line":25,"column":32},"generated":{"line":1,"column":558}},{"source":"Classes/VirusTotalScanner.js","name":"waitTime","original":{"line":25,"column":41},"generated":{"line":1,"column":567}},{"source":"Classes/VirusTotalScanner.js","name":"scansPrMinute","original":{"line":26,"column":13},"generated":{"line":1,"column":570}},{"source":"Classes/VirusTotalScanner.js","name":"scansPrMinute","original":{"line":26,"column":13},"generated":{"line":1,"column":575}},{"source":"Classes/VirusTotalScanner.js","name":"parseInt","original":{"line":26,"column":32},"generated":{"line":1,"column":589}},{"source":"Classes/VirusTotalScanner.js","name":"scansPrMinute","original":{"line":26,"column":41},"generated":{"line":1,"column":598}},{"source":"Classes/VirusTotalScanner.js","name":"maximumPositives","original":{"line":27,"column":13},"generated":{"line":1,"column":601}},{"source":"Classes/VirusTotalScanner.js","name":"maximumPositives","original":{"line":27,"column":13},"generated":{"line":1,"column":606}},{"source":"Classes/VirusTotalScanner.js","name":"parseInt","original":{"line":27,"column":32},"generated":{"line":1,"column":623}},{"source":"Classes/VirusTotalScanner.js","name":"maximumPositives","original":{"line":27,"column":41},"generated":{"line":1,"column":632}},{"source":"Classes/VirusTotalScanner.js","name":"amountOfScans","original":{"line":28,"column":13},"generated":{"line":1,"column":635}},{"source":"Classes/VirusTotalScanner.js","name":"amountOfScans","original":{"line":28,"column":13},"generated":{"line":1,"column":640}},{"source":"Classes/VirusTotalScanner.js","original":{"line":28,"column":32},"generated":{"line":1,"column":654}},{"source":"Classes/VirusTotalScanner.js","name":"options","original":{"line":30,"column":13},"generated":{"line":1,"column":656}},{"source":"Classes/VirusTotalScanner.js","name":"options","original":{"line":30,"column":13},"generated":{"line":1,"column":661}},{"source":"Classes/VirusTotalScanner.js","original":{"line":30,"column":23},"generated":{"line":1,"column":669}},{"source":"Classes/VirusTotalScanner.js","name":"hostname","original":{"line":31,"column":12},"generated":{"line":1,"column":670}},{"source":"Classes/VirusTotalScanner.js","original":{"line":31,"column":22},"generated":{"line":1,"column":679}},{"source":"Classes/VirusTotalScanner.js","name":"port","original":{"line":32,"column":12},"generated":{"line":1,"column":696}},{"source":"Classes/VirusTotalScanner.js","original":{"line":32,"column":18},"generated":{"line":1,"column":701}},{"source":"Classes/VirusTotalScanner.js","name":"path","original":{"line":33,"column":12},"generated":{"line":1,"column":707}},{"source":"Classes/VirusTotalScanner.js","original":{"line":33,"column":18},"generated":{"line":1,"column":712}},{"source":"Classes/VirusTotalScanner.js","name":"method","original":{"line":34,"column":12},"generated":{"line":1,"column":736}},{"source":"Classes/VirusTotalScanner.js","original":{"line":34,"column":20},"generated":{"line":1,"column":743}},{"source":"Classes/VirusTotalScanner.js","name":"headers","original":{"line":35,"column":12},"generated":{"line":1,"column":750}},{"source":"Classes/VirusTotalScanner.js","original":{"line":35,"column":21},"generated":{"line":1,"column":758}},{"source":"Classes/VirusTotalScanner.js","original":{"line":36,"column":35},"generated":{"line":1,"column":759}},{"source":"Classes/VirusTotalScanner.js","original":{"line":36,"column":35},"generated":{"line":1,"column":777}},{"source":"Classes/VirusTotalScanner.js","original":{"line":37,"column":30},"generated":{"line":1,"column":792}},{"source":"Classes/VirusTotalScanner.js","original":{"line":37,"column":30},"generated":{"line":1,"column":805}},{"source":"Classes/VirusTotalScanner.js","name":"process","original":{"line":37,"column":40},"generated":{"line":1,"column":813}},{"source":"Classes/VirusTotalScanner.js","name":"env","original":{"line":37,"column":48},"generated":{"line":1,"column":821}},{"source":"Classes/VirusTotalScanner.js","name":"VIRUSTOTAL_USER","original":{"line":37,"column":52},"generated":{"line":1,"column":825}},{"source":"Classes/VirusTotalScanner.js","name":"queue","original":{"line":41,"column":13},"generated":{"line":1,"column":843}},{"source":"Classes/VirusTotalScanner.js","name":"queue","original":{"line":41,"column":13},"generated":{"line":1,"column":848}},{"source":"Classes/VirusTotalScanner.js","name":"async","original":{"line":41,"column":21},"generated":{"line":1,"column":854}},{"source":"Classes/VirusTotalScanner.js","name":"queue","original":{"line":41,"column":27},"generated":{"line":1,"column":856}},{"source":"Classes/VirusTotalScanner.js","name":"queue","original":{"line":41,"column":27},"generated":{"line":1,"column":864}},{"source":"Classes/VirusTotalScanner.js","original":{"line":41,"column":33},"generated":{"line":1,"column":870}},{"source":"Classes/VirusTotalScanner.js","original":{"line":41,"column":33},"generated":{"line":1,"column":876}},{"source":"Classes/VirusTotalScanner.js","original":{"line":43,"column":16},"generated":{"line":1,"column":880}},{"source":"Classes/VirusTotalScanner.js","name":"amountOfScans","original":{"line":43,"column":21},"generated":{"line":1,"column":885}},{"source":"Classes/VirusTotalScanner.js","original":{"line":43,"column":38},"generated":{"line":1,"column":900}},{"source":"Classes/VirusTotalScanner.js","name":"scansPrMinute","original":{"line":43,"column":43},"generated":{"line":1,"column":905}},{"source":"Classes/VirusTotalScanner.js","original":{"line":44,"column":22},"generated":{"line":1,"column":927}},{"source":"Classes/VirusTotalScanner.js","original":{"line":44,"column":28},"generated":{"line":1,"column":929}},{"source":"Classes/VirusTotalScanner.js","original":{"line":44,"column":28},"generated":{"line":1,"column":931}},{"source":"Classes/VirusTotalScanner.js","original":{"line":44,"column":28},"generated":{"line":1,"column":940}},{"source":"Classes/VirusTotalScanner.js","name":"waitTime","original":{"line":44,"column":33},"generated":{"line":1,"column":945}},{"source":"Classes/VirusTotalScanner.js","name":"amountOfScans","original":{"line":45,"column":21},"generated":{"line":1,"column":955}},{"source":"Classes/VirusTotalScanner.js","name":"amountOfScans","original":{"line":45,"column":21},"generated":{"line":1,"column":960}},{"source":"Classes/VirusTotalScanner.js","original":{"line":45,"column":37},"generated":{"line":1,"column":974}},{"source":"Classes/VirusTotalScanner.js","name":"amountOfScans","original":{"line":47,"column":17},"generated":{"line":1,"column":977}},{"source":"Classes/VirusTotalScanner.js","name":"amountOfScans","original":{"line":47,"column":17},"generated":{"line":1,"column":982}},{"source":"Classes/VirusTotalScanner.js","original":{"line":49,"column":18},"generated":{"line":1,"column":1004}},{"source":"Classes/VirusTotalScanner.js","name":"_onScan","original":{"line":49,"column":23},"generated":{"line":1,"column":1009}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":49,"column":31},"generated":{"line":1,"column":1017}},{"source":"Classes/VirusTotalScanner.js","original":{"line":50,"column":11},"generated":{"line":1,"column":1021}},{"source":"Classes/VirusTotalScanner.js","name":"_getFileReport","original":{"line":53,"column":4},"generated":{"line":1,"column":1024}},{"source":"Classes/VirusTotalScanner.js","name":"fileHash","original":{"line":53,"column":19},"generated":{"line":1,"column":1039}},{"source":"Classes/VirusTotalScanner.js","original":{"line":54,"column":15},"generated":{"line":1,"column":1042}},{"source":"Classes/VirusTotalScanner.js","original":{"line":54,"column":15},"generated":{"line":1,"column":1049}},{"source":"Classes/VirusTotalScanner.js","name":"Promise","original":{"line":54,"column":19},"generated":{"line":1,"column":1053}},{"source":"Classes/VirusTotalScanner.js","original":{"line":54,"column":27},"generated":{"line":1,"column":1061}},{"source":"Classes/VirusTotalScanner.js","name":"resolve","original":{"line":54,"column":28},"generated":{"line":1,"column":1062}},{"source":"Classes/VirusTotalScanner.js","name":"reject","original":{"line":54,"column":37},"generated":{"line":1,"column":1064}},{"source":"Classes/VirusTotalScanner.js","name":"postData","original":{"line":55,"column":18},"generated":{"line":1,"column":1069}},{"source":"Classes/VirusTotalScanner.js","name":"postData","original":{"line":55,"column":18},"generated":{"line":1,"column":1075}},{"source":"Classes/VirusTotalScanner.js","name":"queryString","original":{"line":55,"column":29},"generated":{"line":1,"column":1077}},{"source":"Classes/VirusTotalScanner.js","name":"stringify","original":{"line":55,"column":41},"generated":{"line":1,"column":1079}},{"source":"Classes/VirusTotalScanner.js","name":"stringify","original":{"line":55,"column":41},"generated":{"line":1,"column":1087}},{"source":"Classes/VirusTotalScanner.js","original":{"line":55,"column":51},"generated":{"line":1,"column":1097}},{"source":"Classes/VirusTotalScanner.js","name":"fileHash","original":{"line":56,"column":28},"generated":{"line":1,"column":1098}},{"source":"Classes/VirusTotalScanner.js","name":"fileHash","original":{"line":56,"column":28},"generated":{"line":1,"column":1107}},{"source":"Classes/VirusTotalScanner.js","original":{"line":57,"column":26},"generated":{"line":1,"column":1109}},{"source":"Classes/VirusTotalScanner.js","original":{"line":57,"column":26},"generated":{"line":1,"column":1116}},{"source":"Classes/VirusTotalScanner.js","name":"APIKey","original":{"line":57,"column":31},"generated":{"line":1,"column":1121}},{"source":"Classes/VirusTotalScanner.js","name":"req","original":{"line":60,"column":18},"generated":{"line":1,"column":1130}},{"source":"Classes/VirusTotalScanner.js","name":"https","original":{"line":60,"column":24},"generated":{"line":1,"column":1132}},{"source":"Classes/VirusTotalScanner.js","name":"request","original":{"line":60,"column":30},"generated":{"line":1,"column":1134}},{"source":"Classes/VirusTotalScanner.js","name":"request","original":{"line":60,"column":30},"generated":{"line":1,"column":1142}},{"source":"Classes/VirusTotalScanner.js","original":{"line":60,"column":38},"generated":{"line":1,"column":1150}},{"source":"Classes/VirusTotalScanner.js","name":"options","original":{"line":60,"column":43},"generated":{"line":1,"column":1155}},{"source":"Classes/VirusTotalScanner.js","name":"res","original":{"line":60,"column":52},"generated":{"line":1,"column":1163}},{"source":"Classes/VirusTotalScanner.js","name":"end","original":{"line":61,"column":20},"generated":{"line":1,"column":1167}},{"source":"Classes/VirusTotalScanner.js","name":"end","original":{"line":61,"column":20},"generated":{"line":1,"column":1171}},{"source":"Classes/VirusTotalScanner.js","original":{"line":61,"column":26},"generated":{"line":1,"column":1173}},{"source":"Classes/VirusTotalScanner.js","name":"res","original":{"line":62,"column":16},"generated":{"line":1,"column":1176}},{"source":"Classes/VirusTotalScanner.js","name":"on","original":{"line":62,"column":20},"generated":{"line":1,"column":1178}},{"source":"Classes/VirusTotalScanner.js","original":{"line":62,"column":23},"generated":{"line":1,"column":1181}},{"source":"Classes/VirusTotalScanner.js","name":"d","original":{"line":62,"column":31},"generated":{"line":1,"column":1188}},{"source":"Classes/VirusTotalScanner.js","name":"end","original":{"line":63,"column":20},"generated":{"line":1,"column":1192}},{"source":"Classes/VirusTotalScanner.js","name":"d","original":{"line":63,"column":27},"generated":{"line":1,"column":1195}},{"source":"Classes/VirusTotalScanner.js","name":"res","original":{"line":66,"column":16},"generated":{"line":1,"column":1199}},{"source":"Classes/VirusTotalScanner.js","name":"on","original":{"line":66,"column":20},"generated":{"line":1,"column":1201}},{"source":"Classes/VirusTotalScanner.js","original":{"line":66,"column":23},"generated":{"line":1,"column":1204}},{"source":"Classes/VirusTotalScanner.js","original":{"line":66,"column":30},"generated":{"line":1,"column":1210}},{"source":"Classes/VirusTotalScanner.js","name":"result","original":{"line":70,"column":26},"generated":{"line":1,"column":1215}},{"source":"Classes/VirusTotalScanner.js","name":"result","original":{"line":70,"column":26},"generated":{"line":1,"column":1221}},{"source":"Classes/VirusTotalScanner.js","original":{"line":70,"column":50},"generated":{"line":1,"column":1223}},{"source":"Classes/VirusTotalScanner.js","name":"end","original":{"line":70,"column":35},"generated":{"line":1,"column":1227}},{"source":"Classes/VirusTotalScanner.js","name":"length","original":{"line":70,"column":39},"generated":{"line":1,"column":1229}},{"source":"Classes/VirusTotalScanner.js","original":{"line":70,"column":54},"generated":{"line":1,"column":1236}},{"source":"Classes/VirusTotalScanner.js","name":"JSON","original":{"line":71,"column":54},"generated":{"line":1,"column":1241}},{"source":"Classes/VirusTotalScanner.js","name":"parse","original":{"line":71,"column":59},"generated":{"line":1,"column":1246}},{"source":"Classes/VirusTotalScanner.js","name":"end","original":{"line":71,"column":65},"generated":{"line":1,"column":1252}},{"source":"Classes/VirusTotalScanner.js","name":"resolve","original":{"line":73,"column":20},"generated":{"line":1,"column":1255}},{"source":"Classes/VirusTotalScanner.js","name":"result","original":{"line":73,"column":28},"generated":{"line":1,"column":1257}},{"source":"Classes/VirusTotalScanner.js","name":"res","original":{"line":76,"column":16},"generated":{"line":1,"column":1262}},{"source":"Classes/VirusTotalScanner.js","name":"on","original":{"line":76,"column":20},"generated":{"line":1,"column":1264}},{"source":"Classes/VirusTotalScanner.js","original":{"line":76,"column":23},"generated":{"line":1,"column":1267}},{"source":"Classes/VirusTotalScanner.js","name":"e","original":{"line":76,"column":32},"generated":{"line":1,"column":1275}},{"source":"Classes/VirusTotalScanner.js","name":"reject","original":{"line":77,"column":20},"generated":{"line":1,"column":1279}},{"source":"Classes/VirusTotalScanner.js","name":"e","original":{"line":77,"column":27},"generated":{"line":1,"column":1281}},{"source":"Classes/VirusTotalScanner.js","name":"req","original":{"line":81,"column":12},"generated":{"line":1,"column":1288}},{"source":"Classes/VirusTotalScanner.js","name":"on","original":{"line":81,"column":16},"generated":{"line":1,"column":1290}},{"source":"Classes/VirusTotalScanner.js","original":{"line":81,"column":19},"generated":{"line":1,"column":1293}},{"source":"Classes/VirusTotalScanner.js","name":"e","original":{"line":81,"column":28},"generated":{"line":1,"column":1301}},{"source":"Classes/VirusTotalScanner.js","name":"reject","original":{"line":82,"column":16},"generated":{"line":1,"column":1305}},{"source":"Classes/VirusTotalScanner.js","name":"e","original":{"line":82,"column":23},"generated":{"line":1,"column":1307}},{"source":"Classes/VirusTotalScanner.js","name":"req","original":{"line":85,"column":12},"generated":{"line":1,"column":1312}},{"source":"Classes/VirusTotalScanner.js","name":"write","original":{"line":85,"column":16},"generated":{"line":1,"column":1314}},{"source":"Classes/VirusTotalScanner.js","name":"postData","original":{"line":85,"column":22},"generated":{"line":1,"column":1320}},{"source":"Classes/VirusTotalScanner.js","name":"req","original":{"line":86,"column":12},"generated":{"line":1,"column":1323}},{"source":"Classes/VirusTotalScanner.js","name":"end","original":{"line":86,"column":16},"generated":{"line":1,"column":1325}},{"source":"Classes/VirusTotalScanner.js","name":"_onScan","original":{"line":90,"column":10},"generated":{"line":1,"column":1333}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":90,"column":18},"generated":{"line":1,"column":1347}},{"source":"Classes/VirusTotalScanner.js","name":"report","original":{"line":91,"column":14},"generated":{"line":1,"column":1350}},{"source":"Classes/VirusTotalScanner.js","name":"report","original":{"line":91,"column":14},"generated":{"line":1,"column":1356}},{"source":"Classes/VirusTotalScanner.js","original":{"line":91,"column":29},"generated":{"line":1,"column":1364}},{"source":"Classes/VirusTotalScanner.js","name":"_getFileReport","original":{"line":91,"column":34},"generated":{"line":1,"column":1369}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":91,"column":49},"generated":{"line":1,"column":1384}},{"source":"Classes/VirusTotalScanner.js","name":"fileHash","original":{"line":91,"column":54},"generated":{"line":1,"column":1386}},{"source":"Classes/VirusTotalScanner.js","original":{"line":94,"column":23},"generated":{"line":1,"column":1396}},{"source":"Classes/VirusTotalScanner.js","name":"report","original":{"line":94,"column":12},"generated":{"line":1,"column":1403}},{"source":"Classes/VirusTotalScanner.js","name":"report","original":{"line":101,"column":35},"generated":{"line":1,"column":1405}},{"source":"Classes/VirusTotalScanner.js","name":"positives","original":{"line":101,"column":42},"generated":{"line":1,"column":1407}},{"source":"Classes/VirusTotalScanner.js","name":"parseInt","original":{"line":101,"column":54},"generated":{"line":1,"column":1417}},{"source":"Classes/VirusTotalScanner.js","original":{"line":101,"column":63},"generated":{"line":1,"column":1426}},{"source":"Classes/VirusTotalScanner.js","name":"maximumPositives","original":{"line":101,"column":68},"generated":{"line":1,"column":1431}},{"source":"Classes/VirusTotalScanner.js","original":{"line":102,"column":60},"generated":{"line":1,"column":1450}},{"source":"Classes/VirusTotalScanner.js","name":"report","original":{"line":102,"column":35},"generated":{"line":1,"column":1454}},{"source":"Classes/VirusTotalScanner.js","name":"response_code","original":{"line":102,"column":42},"generated":{"line":1,"column":1456}},{"source":"Classes/VirusTotalScanner.js","original":{"line":103,"column":53},"generated":{"line":1,"column":1471}},{"source":"Classes/VirusTotalScanner.js","name":"report","original":{"line":103,"column":35},"generated":{"line":1,"column":1475}},{"source":"Classes/VirusTotalScanner.js","name":"length","original":{"line":103,"column":42},"generated":{"line":1,"column":1477}},{"source":"Classes/VirusTotalScanner.js","original":{"line":107,"column":18},"generated":{"line":1,"column":1490}},{"source":"Classes/VirusTotalScanner.js","name":"_updateFileVirustotalScanCountInDb","original":{"line":107,"column":23},"generated":{"line":1,"column":1495}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":107,"column":58},"generated":{"line":1,"column":1530}},{"source":"Classes/VirusTotalScanner.js","name":"fileName","original":{"line":107,"column":63},"generated":{"line":1,"column":1532}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":107,"column":73},"generated":{"line":1,"column":1541}},{"source":"Classes/VirusTotalScanner.js","name":"scanNumber","original":{"line":107,"column":78},"generated":{"line":1,"column":1543}},{"source":"Classes/VirusTotalScanner.js","original":{"line":112,"column":37},"generated":{"line":1,"column":1561}},{"source":"Classes/VirusTotalScanner.js","original":{"line":112,"column":49},"generated":{"line":1,"column":1563}},{"source":"Classes/VirusTotalScanner.js","original":{"line":112,"column":49},"generated":{"line":1,"column":1565}},{"source":"Classes/VirusTotalScanner.js","original":{"line":112,"column":49},"generated":{"line":1,"column":1574}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":112,"column":50},"generated":{"line":1,"column":1575}},{"source":"Classes/VirusTotalScanner.js","name":"fileName","original":{"line":112,"column":55},"generated":{"line":1,"column":1577}},{"source":"Classes/VirusTotalScanner.js","original":{"line":112,"column":66},"generated":{"line":1,"column":1587}},{"source":"Classes/VirusTotalScanner.js","original":{"line":115,"column":18},"generated":{"line":1,"column":1608}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":115,"column":36},"generated":{"line":1,"column":1610}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":115,"column":36},"generated":{"line":1,"column":1612}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":115,"column":36},"generated":{"line":1,"column":1621}},{"source":"Classes/VirusTotalScanner.js","name":"fileName","original":{"line":115,"column":41},"generated":{"line":1,"column":1623}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":115,"column":51},"generated":{"line":1,"column":1632}},{"source":"Classes/VirusTotalScanner.js","name":"fileHash","original":{"line":115,"column":56},"generated":{"line":1,"column":1634}},{"source":"Classes/VirusTotalScanner.js","name":"report","original":{"line":115,"column":66},"generated":{"line":1,"column":1643}},{"source":"Classes/VirusTotalScanner.js","name":"permalink","original":{"line":115,"column":73},"generated":{"line":1,"column":1645}},{"source":"Classes/VirusTotalScanner.js","original":{"line":115,"column":84},"generated":{"line":1,"column":1655}},{"source":"Classes/VirusTotalScanner.js","original":{"line":95,"column":18},"generated":{"line":1,"column":1675}},{"source":"Classes/VirusTotalScanner.js","name":"_updateFileVirustotalScanCountInDb","original":{"line":95,"column":23},"generated":{"line":1,"column":1680}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":95,"column":58},"generated":{"line":1,"column":1715}},{"source":"Classes/VirusTotalScanner.js","name":"fileName","original":{"line":95,"column":63},"generated":{"line":1,"column":1717}},{"source":"Classes/VirusTotalScanner.js","name":"task","original":{"line":95,"column":73},"generated":{"line":1,"column":1726}},{"source":"Classes/VirusTotalScanner.js","name":"scanNumber","original":{"line":95,"column":78},"generated":{"line":1,"column":1728}},{"source":"Classes/VirusTotalScanner.js","name":"_updateFileVirustotalScanCountInDb","original":{"line":123,"column":10},"generated":{"line":1,"column":1740}},{"source":"Classes/VirusTotalScanner.js","name":"fileName","original":{"line":123,"column":45},"generated":{"line":1,"column":1781}},{"source":"Classes/VirusTotalScanner.js","name":"scanNumber","original":{"line":123,"column":55},"generated":{"line":1,"column":1783}},{"source":"Classes/VirusTotalScanner.js","name":"client","original":{"line":124,"column":14},"generated":{"line":1,"column":1786}},{"source":"Classes/VirusTotalScanner.js","name":"client","original":{"line":124,"column":14},"generated":{"line":1,"column":1792}},{"source":"Classes/VirusTotalScanner.js","name":"db","original":{"line":124,"column":29},"generated":{"line":1,"column":1800}},{"source":"Classes/VirusTotalScanner.js","name":"connect","original":{"line":124,"column":32},"generated":{"line":1,"column":1802}},{"source":"Classes/VirusTotalScanner.js","name":"connect","original":{"line":124,"column":32},"generated":{"line":1,"column":1810}},{"source":"Classes/VirusTotalScanner.js","name":"client","original":{"line":125,"column":29},"generated":{"line":1,"column":1826}},{"source":"Classes/VirusTotalScanner.js","name":"query","original":{"line":125,"column":36},"generated":{"line":1,"column":1828}},{"source":"Classes/VirusTotalScanner.js","original":{"line":125,"column":43},"generated":{"line":1,"column":1834}},{"source":"Classes/VirusTotalScanner.js","original":{"line":125,"column":109},"generated":{"line":1,"column":1900}},{"source":"Classes/VirusTotalScanner.js","name":"scanNumber","original":{"line":125,"column":110},"generated":{"line":1,"column":1901}},{"source":"Classes/VirusTotalScanner.js","name":"fileName","original":{"line":125,"column":122},"generated":{"line":1,"column":1903}},{"source":"Classes/VirusTotalScanner.js","name":"client","original":{"line":126,"column":29},"generated":{"line":1,"column":1913}},{"source":"Classes/VirusTotalScanner.js","name":"release","original":{"line":126,"column":36},"generated":{"line":1,"column":1915}},{"source":"Classes/VirusTotalScanner.js","name":"scan","original":{"line":135,"column":4},"generated":{"line":1,"column":1925}},{"source":"Classes/VirusTotalScanner.js","name":"filehash","original":{"line":135,"column":9},"generated":{"line":1,"column":1930}},{"source":"Classes/VirusTotalScanner.js","name":"filename","original":{"line":135,"column":19},"generated":{"line":1,"column":1932}},{"source":"Classes/VirusTotalScanner.js","name":"scanNumber","original":{"line":135,"column":29},"generated":{"line":1,"column":1934}},{"source":"Classes/VirusTotalScanner.js","name":"queue","original":{"line":136,"column":13},"generated":{"line":1,"column":1937}},{"source":"Classes/VirusTotalScanner.js","name":"queue","original":{"line":136,"column":13},"generated":{"line":1,"column":1942}},{"source":"Classes/VirusTotalScanner.js","name":"push","original":{"line":136,"column":19},"generated":{"line":1,"column":1948}},{"source":"Classes/VirusTotalScanner.js","original":{"line":136,"column":24},"generated":{"line":1,"column":1953}},{"source":"Classes/VirusTotalScanner.js","name":"fileHash","original":{"line":137,"column":12},"generated":{"line":1,"column":1954}},{"source":"Classes/VirusTotalScanner.js","name":"filehash","original":{"line":137,"column":22},"generated":{"line":1,"column":1963}},{"source":"Classes/VirusTotalScanner.js","name":"fileName","original":{"line":138,"column":12},"generated":{"line":1,"column":1965}},{"source":"Classes/VirusTotalScanner.js","name":"filename","original":{"line":138,"column":22},"generated":{"line":1,"column":1974}},{"source":"Classes/VirusTotalScanner.js","name":"scanNumber","original":{"line":139,"column":12},"generated":{"line":1,"column":1976}},{"source":"Classes/VirusTotalScanner.js","name":"scanNumber","original":{"line":139,"column":24},"generated":{"line":1,"column":1987}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":1992}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":1996}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":1998}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":2000}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":2008}},{"source":"Classes/VirusTotalScanner.js","name":"VirusTotalScanner","original":{"line":144,"column":15},"generated":{"line":1,"column":2016}}],"sources":{"Classes/VirusTotalScanner.js":"import https         from \"https\";\r\nimport queryString   from \"querystring\";\r\nimport async         from \"async\";\r\nimport { promisify } from \"util\";\r\nimport fs            from \"fs\";\r\nimport sleep         from \"../Functions/sleep\";\r\nimport db            from \"../helpers/database\";\r\nimport deleteFiles   from \"../Functions/FileDeletion/deleteFiles\";\r\nimport logToTransparency from \"../Functions/Transparency/logToTransparency\";\r\n\r\nconst unlink   = promisify(fs.unlink);\r\n\r\nclass VirusTotalScanner {\r\n    /**\r\n     * \r\n     * @param {String} APIKey \r\n     * @param {Number} waitTime \r\n     * @param {Number} scansPrMinute \r\n     * @param {Number} maximumPositives \r\n     * @param {String} uploadDir \r\n     */\r\n    constructor(APIKey, waitTime, scansPrMinute, maximumPositives, uploadDir) {\r\n        this.APIKey           = APIKey;\r\n        this.uploadDir        = uploadDir;\r\n        this.waitTime         = parseInt(waitTime);\r\n        this.scansPrMinute    = parseInt(scansPrMinute);\r\n        this.maximumPositives = parseInt(maximumPositives);\r\n        this.amountOfScans    = 0;\r\n\r\n        this.options = {\r\n            hostname: \"virustotal.com\",\r\n            port: \"443\",\r\n            path: \"/vtapi/v2/file/report\",\r\n            method: \"POST\",\r\n            headers: {\r\n                \"Accept-Encoding\": \"gzip deflate\",\r\n                \"User-Agent\": \"gzip \" + process.env.VIRUSTOTAL_USER\r\n            }\r\n        }\r\n\r\n        this.queue = async.queue(async task => {\r\n            // This is how the scanner i limited to 4 scans pr minute\r\n            if (this.amountOfScans == this.scansPrMinute) {\r\n                await sleep(this.waitTime);\r\n                this.amountOfScans = 0;\r\n            }\r\n            this.amountOfScans++;\r\n\r\n            await this._onScan(task);\r\n        }, 1);\r\n    }\r\n\r\n    _getFileReport(fileHash) {\r\n        return new Promise((resolve, reject) => {\r\n            const postData = queryString.stringify({\r\n                \"resource\": fileHash,\r\n                \"apikey\": this.APIKey\r\n            });\r\n        \r\n            const req = https.request(this.options, res => {\r\n                let end = \"\";\r\n                res.on(\"data\", d => {\r\n                    end += d;\r\n                });\r\n    \r\n                res.on(\"end\", () => {\r\n                    // If for whatever reason VirusTotal doesn't approve of your request it will give you empty string\r\n                    // JSON.parse doesn't like empty string\r\n                    //...\r\n                    const result = end.length === 0 ? null \r\n                                                    : JSON.parse(end);\r\n    \r\n                    resolve(result);\r\n                });\r\n    \r\n                res.on(\"error\", e => {\r\n                    reject(e);\r\n                });\r\n            });\r\n        \r\n            req.on(\"error\", e => {\r\n                reject(e);\r\n            })\r\n            \r\n            req.write(postData);\r\n            req.end();\r\n        });\r\n    } \r\n\r\n    async _onScan(task) {\r\n        const report = await this._getFileReport(task.fileHash);\r\n\r\n        // Should I wait and try again?\r\n        if (report === null)  {\r\n            await this._updateFileVirustotalScanCountInDb(task.fileName, task.scanNumber);\r\n            return;\r\n        }\r\n        \r\n\r\n\r\n        const virusTotalDemands =  report.positives < parseInt(this.maximumPositives)\r\n                                || report.response_code === 0 // The file is not in the database\r\n                                || report.length === 0;       // ^\r\n\r\n        // If there are too few positives\r\n        if (virusTotalDemands) {\r\n            await this._updateFileVirustotalScanCountInDb(task.fileName, task.scanNumber);\r\n            return;\r\n        }\r\n\r\n        // Remove the file if there are too many positives\r\n        const fileGotDeleted = await deleteFiles([task.fileName], \"VirusTotal\");\r\n\r\n        if (fileGotDeleted)\r\n            await logToTransparency(task.fileName, task.fileHash, report.permalink, \"Virustotal\");\r\n    }\r\n\r\n    /**\r\n     * \r\n     * @param {*} fileName \r\n     * @param {*} scanNumber \r\n     */\r\n    async _updateFileVirustotalScanCountInDb(fileName, scanNumber) {\r\n        const client = await db.connect();\r\n                       await client.query(`UPDATE \"Uploads\" SET \"virustotalScan\" = $1 WHERE filename = $2;`, [scanNumber, fileName]);\r\n                       await client.release();\r\n    }\r\n\r\n    /**\r\n     * \r\n     * @param {String} filehash - The files hash \r\n     * @param {String} filename - The name of the file on disk\r\n     * @param {Number} scanNumber - The scan that has been performed\r\n     */\r\n    scan(filehash, filename, scanNumber) {\r\n        this.queue.push({\r\n            fileHash: filehash,\r\n            fileName: filename,\r\n            scanNumber: scanNumber\r\n        })\r\n    }\r\n}\r\n\r\nexport default VirusTotalScanner;"},"lineCount":null}},"hash":"c5aa344c2fc22290df017247331af796","cacheData":{"env":{}}}